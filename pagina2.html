
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JC PATH LAB | Sistema de Gestión</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Dexie.js for IndexedDB wrapper -->
    <script src="https://unpkg.com/dexie@3.2.2/dist/dexie.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
    <style>:root{--primary:#1e88e5;--primary-dark:#0d47a1;--secondary:#ff9800;--secondary-dark:#f57c00;--text:#333;--text-light:#666;--bg:#f0f2f5;--sidebar-bg:#2c3e50;--sidebar-hover:#34495e;--card-bg:#fff;--border:#e0e0e0;--success:#4caf50;--error:#e53935;--table-header:#e3f2fd}*{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif}@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}@keyframes slideInLeft{from{opacity:0;transform:translateX(-20px)}to{opacity:1;transform:translateX(0)}}@keyframes slideInRight{from{opacity:0;transform:translateX(20px)}to{opacity:1;transform:translateX(0)}}@keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.02)}100%{transform:scale(1)}}.animated-fadeIn{animation:fadeIn .5s ease-out}.animated-slideInLeft{animation:slideInLeft .5s ease-out}.animated-slideInRight{animation:slideInRight .5s ease-out}.animated-pulse:hover{animation:pulse .3s ease-in-out}.card{transition:all .3s ease}.card:hover{transform:translateY(-5px);box-shadow:0 10px 25px rgba(0,0,0,.15)}.btn{transition:all .3s ease}.btn:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,0,0,.1)}.menu-item{transition:all .2s ease}.menu-item:hover{transform:translateX(5px)}body{background-color:var(--bg);color:var(--text);display:flex;min-height:100vh;overflow-x:hidden}.sidebar{width:260px;background:var(--sidebar-bg);color:#fff;height:100vh;position:fixed;transition:all .3s ease;z-index:100;overflow-y:auto}.logo{padding:25px 20px;border-bottom:1px solid rgba(255,255,255,.1);display:flex;align-items:center;gap:15px}.logo i{font-size:28px;color:var(--secondary)}.logo-text{display:flex;flex-direction:column}.logo-title{font-size:20px;font-weight:600}.logo-subtitle{font-size:12px;opacity:.8}.menu{padding:20px 0}.menu-item{padding:14px 20px;display:flex;align-items:center;gap:15px;cursor:pointer;transition:all .3s;border-left:4px solid transparent}.menu-item:hover,.menu-item.active{background:var(--sidebar-hover);border-left-color:var(--primary)}.menu-item i{width:20px;text-align:center}.main-content{margin-left:260px;width:calc(100% - 260px);transition:all .3s ease;padding:20px}.topbar{background:#fff;padding:10px 20px;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.05);display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}.topbar-left{display:flex;align-items:center;gap:20px}.menu-toggle{cursor:pointer;font-size:20px}.page-title{font-size:22px;font-weight:600;color:var(--primary-dark)}.user-info{display:flex;align-items:center;gap:15px}.user-avatar{width:40px;height:40px;border-radius:50%;background:var(--primary);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:600}.user-name{font-weight:500}.content{padding:0}.page-content{display:none}.page-content.active{display:block;animation:fadeIn .5s ease-out}.container{width:100%}.card{background:var(--card-bg);border-radius:10px;box-shadow:0 4px 20px rgba(0,0,0,.08);margin-bottom:20px}.card-header{padding:20px;border-bottom:1px solid var(--border)}.card-header h1{font-size:24px;margin:0;color:var(--primary-dark)}.confirmation-message{display:none;padding:15px;margin:20px;border-radius:8px;background-color:#e8f5e9;color:#388e3c;font-weight:500;text-align:center}.confirmation-message.duplicate{background-color:#fff3e0;color:#f57c00}.section{padding:20px;border-bottom:1px solid var(--border)}.section:last-child{border-bottom:none}.section-title{font-size:18px;font-weight:600;margin-bottom:20px;color:var(--primary-dark);padding-bottom:10px;border-bottom:2px solid var(--primary)}.input-group{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-bottom:20px}.form-group{display:flex;flex-direction:column}.form-group label{margin-bottom:8px;font-weight:500;color:var(--text-light)}.form-group input,.form-group select,.form-group textarea{padding:12px;border:1px solid var(--border);border-radius:6px;font-size:1rem;transition:all .3s}.form-group input:focus,.form-group select:focus,.form-group textarea:focus{border-color:var(--primary);outline:none;box-shadow:0 0 0 3px rgba(30,136,229,.2)}.attention-group{display:flex;gap:10px;align-items:flex-end}.combo-input-container{position:relative}.file-upload{border:2px dashed var(--border);border-radius:8px;padding:30px;text-align:center;cursor:pointer;transition:all .3s}.file-upload:hover{border-color:var(--primary);background:#f5f9ff}.file-upload i{font-size:32px;color:var(--primary);margin-bottom:10px}.file-upload .file-text{font-weight:500}.date-box{padding:20px;text-align:center;background:#f9f9f9;border-radius:8px;margin:10px 0}.date-label{font-weight:500;color:var(--text-light);margin-bottom:5px}.date-value{font-size:18px;font-weight:600;color:var(--primary-dark)}.buttons{padding:20px;display:flex;justify-content:flex-end;gap:15px}.btn{padding:12px 25px;border:none;border-radius:6px;cursor:pointer;font-size:1rem;font-weight:600;display:inline-flex;align-items:center;gap:8px}.btn-primary{background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff}.btn-secondary{background:linear-gradient(135deg,var(--secondary),var(--secondary-dark));color:#fff}.btn-outline{background:transparent;border:2px solid var(--border);color:var(--text-light)}.btn-outline:hover{background:var(--border);color:var(--text)}.filters{display:flex;flex-wrap:wrap;gap:15px;padding:20px;background:#f9f9f9;border-bottom:1px solid var(--border)}.filters .filter-group{flex:1;min-width:200px}.filters .search-btn{padding:12px 20px;background:var(--primary);color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:1rem;display:flex;align-items:center;gap:8px;align-self:flex-end}.results-container{padding:0 20px 20px;overflow-x:auto}.results-table{width:100%;border-collapse:collapse}.results-table th,.results-table td{padding:15px;text-align:left;border-bottom:1px solid var(--border)}.results-table th{background:var(--table-header);font-weight:600;color:var(--primary-dark)}.results-table tr:hover{background:#f5f9ff}.modify-btn,.delete-btn{background:transparent;border:none;cursor:pointer;font-size:16px;padding:5px}.modify-btn{color:var(--secondary-dark)}.delete-btn{color:var(--error)}.pagination{display:flex;justify-content:center;padding:20px;gap:10px}.page-btn{padding:8px 15px;background:#f0f0f0;border:1px solid var(--border);border-radius:4px;cursor:pointer}.page-btn.active,.page-btn:hover{background:var(--primary);color:#fff;border-color:var(--primary)}.plantillas-iframe{width:100%;height:80vh;border:none}.data-card{background:#f9f9f9;border-radius:8px;padding:20px}.data-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px}.data-item .data-label{font-size:12px;color:var(--text-light);margin-bottom:4px;display:block}.data-item .data-value{font-weight:500}.editable-field,.editable-select{width:100%;padding:8px;border:1px solid var(--border);border-radius:4px}.doctor-section{display:flex;gap:20px;margin-top:20px}.description-container{display:grid;grid-template-columns:1fr 1fr;gap:20px}.editor-container{border:1px solid var(--border);border-radius:6px;overflow:hidden}.editor-toolbar{background:#f0f2f5;padding:8px;display:flex;flex-wrap:wrap;gap:5px}.editor-toolbar .format-btn,.editor-toolbar .format-select{background:#fff;border:1px solid var(--border);padding:5px 10px;border-radius:4px;cursor:pointer}.editor-content{min-height:150px;padding:10px;outline:none}.diagnostico-section{margin-top:20px}.photos-section{margin-top:20px}.photos-grid{display:grid;grid-template-columns:1fr 1fr;gap:15px}.photo-upload{border:2px dashed var(--border);border-radius:8px;padding:20px;text-align:center;cursor:pointer;position:relative;overflow:hidden}.photo-upload img{max-width:100%;max-height:150px;display:none}.photo-upload .photo-controls{position:absolute;bottom:0;left:0;right:0;background:rgba(0,0,0,.6);padding:5px;display:flex;justify-content:center;gap:10px;transform:translateY(100%);transition:transform .3s}.photo-upload:hover .photo-controls{transform:translateY(0)}.photo-btn{background:transparent;border:none;color:#fff;cursor:pointer;font-size:14px}.crop-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);z-index:1001;display:none;align-items:center;justify-content:center;padding:10px;box-sizing:border-box}.crop-content{background:#fff;padding:20px;border-radius:10px;width:100%;max-width:800px;height:90vh;display:flex;flex-direction:column;box-sizing:border-box}.crop-area{position:relative;overflow:hidden;flex-grow:1;margin-bottom:15px;display:flex;justify-content:center;align-items:center}.crop-area img{max-width:100%;max-height:100%}.crop-box{position:absolute;border:2px dashed var(--primary);cursor:move}.crop-handle{position:absolute;width:10px;height:10px;background:var(--primary);right:-5px;bottom:-5px;cursor:se-resize}.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:1000;display:flex;align-items:center;justify-content:center}.modal-content{background:#fff;border-radius:10px;box-shadow:0 5px 25px rgba(0,0,0,.2);width:90%;max-width:500px}.modal-header{padding:15px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}.modal-header h2{font-size:20px;margin:0}.modal-close{font-size:24px;cursor:pointer;color:var(--text-light)}.modal-body{padding:20px}.modal-footer{padding:15px 20px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:10px}body.sidebar-collapsed .sidebar{width:80px}body.sidebar-collapsed .sidebar .logo-text,body.sidebar-collapsed .sidebar .menu-text,body.sidebar-collapsed .sidebar .sidebar-footer p{display:none}body.sidebar-collapsed .main-content{margin-left:80px;width:calc(100% - 80px)}@media(max-width:992px){.sidebar{width:0}.main-content{margin-left:0;width:100%}}
    </style>
    <style id="permissions-style">
        /* .read-only-mode .btn-primary,
        .read-only-mode .btn-save,
        .read-only-mode .btn-secondary,
        .read-only-mode .delete-btn,
        .read-only-mode .modify-btn,
        .read-only-mode #register-btn-med,
        .read-only-mode #update-btn-med,
        .read-only-mode #guardar-btn,
        .read-only-mode #firmar-btn,
        .read-only-mode .file-upload,
        .read-only-mode .photo-upload,
        .read-only-mode .buttons button:not(#exit-btn):not(#volver-btn) {
            display: none !important;
        }

        .read-only-mode input,
        .read-only-mode textarea,
        .read-only-mode select {
            pointer-events: none;
            background-color: #f0f2f5 !important;
        }

        .read-only-mode [contenteditable="true"] {
            pointer-events: none;
            background-color: #f0f2f5 !important;
            border-color: transparent !important;
        } */
    </style>

    <style>
/* Search Bot */
#search-bot-fab {
    position: fixed;
    bottom: 30px;
    right: 30px;
    width: 60px;
    height: 60px;
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    z-index: 1000;
    transition: all 0.3s ease;
}
#search-bot-fab:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 16px rgba(0,0,0,0.3);
}
.search-modal {
    display: none;
    position: fixed;
    z-index: 1001;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.5);
    animation: fadeIn 0.3s;
}
.search-modal-content {
    background-color: #fefefe;
    margin: 10% auto;
    padding: 20px;
    border: 1px solid #888;
    width: 80%;
    max-width: 600px;
    border-radius: 10px;
}
.search-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #ddd;
    padding-bottom: 10px;
    margin-bottom: 20px;
}
.search-modal-close {
    color: #aaa;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    border: none;
    background: none;
}
#search-modal-input {
    width: 100%;
    padding: 12px;
    font-size: 16px;
    border: 1px solid #ccc;
    border-radius: 5px;
}
#search-modal-results {
    margin-top: 20px;
    max-height: 400px;
    overflow-y: auto;
}
.search-result-item {
    padding: 10px;
    border-bottom: 1px solid #eee;
    cursor: pointer;
    display: flex;
    align-items: center;
}
.search-result-item:hover {
    background-color: #f0f2f5;
}
.search-result-item i {
    margin-right: 10px;
    color: var(--primary);
}
    </style>
</head>
<body>
    <script>
        const token = sessionStorage.getItem('token');
        const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
        if (!token || !currentUser) {
            window.location.href = 'index.html';
        }
    </script>
    <!-- Menú lateral (sin cambios) -->
    <aside class="sidebar">
        <div class="logo">
            <i class="fas fa-flask"></i>
            <div class="logo-text">
                <span class="logo-title">JC PATH LAB</span>
                <span class="logo-subtitle">LABORATORIO DE ANATOMIA PATOLOGICA</span>
            </div>
        </div>
        
        <div class="menu">
            <div class="menu-item active" data-link="registro-pacientes">
                <i class="fas fa-user-injured"></i>
                <span class="menu-text">Registro de pacientes</span>
            </div>
            <div class="menu-item" data-link="registro-medicos">
                <i class="fas fa-user-md"></i>
                <span class="menu-text">Registro de médicos</span>
            </div>
            <div class="menu-item" data-link="resultados-quirurgicos">
                <i class="fas fa-clipboard-list"></i>
                <span class="menu-text">Lista de resultados quirúrgicos</span>
            </div>
            <div class="menu-item" data-link="resultados-citologicos">
                <i class="fas fa-microscope"></i>
                <span class="menu-text">Lista de resultados citológicos</span>
            </div>
            <div class="menu-item" data-link="plantillas">
                <i class="fas fa-file-alt"></i>
                <span class="menu-text">Plantillas</span>
            </div>
            <div class="menu-item admin-only" data-link="gestion-usuarios" style="display: none;">
                <i class="fas fa-users-cog"></i>
                <span class="menu-text">Gestión de Usuarios</span>
            </div>
        </div>
        
        <div class="sidebar-footer">
            <p>Propietario:</p>
            <p>Dr. Joseph Christopher Castillo Cuenca</p>
        </div>
    </aside>
    
    <!-- Contenido principal -->
    <div class="main-content">
        <div class="topbar">
            <div class="topbar-left">
                <div class="menu-toggle">
                    <i class="fas fa-bars"></i>
                </div>
                <div class="page-title" id="page-title">Registro de Pacientes</div>
            </div>
            <div class="user-info">
                <div class="user-avatar">JC</div>
                <div class="user-name">Dr. Castillo</div>
                <button id="logout-btn" title="Cerrar Sesión" style="background: none; border: none; color: var(--primary-dark); font-size: 1.2rem; cursor: pointer;"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </div>
        
        <div class="content">
            <!-- Página de registro de pacientes -->
            <div id="registro-pacientes" class="page-content active">
                <div class="container">
                    <div class="card">
                        <div class="card-header">
                            <h1>REGISTRO PACIENTE</h1>
                        </div>
                        
                        <div class="confirmation-message" id="confirmation-message">
                            <i class="fas fa-check-circle"></i> Datos guardados correctamente
                        </div>
                        
                        <div class="confirmation-message duplicate" id="duplicate-message">
                            <i class="fas fa-exclamation-triangle"></i> Código duplicado, por favor ingrene otro código
                        </div>
                        
                        <div class="section">
                            <div class="section-title">Tipo Servicio</div>
                            <div class="input-group">
                                <div class="form-group">
                                    <label for="service-type">TIPO DE SERVICIO</label>
                                    <select id="service-type">
                                        <option value="">Seleccione un servicio</option>
                                        <option value="muestras-quirurgicas">Muestras Quirúrgicas</option>
                                        <option value="muestras-citologicas">Muestras Citológicas</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="section">
                            <div class="section-title">Datos del Paciente</div>
                            
                            <div class="attention-group">
                                <div class="form-group">
                                    <label for="attention-code">Cod. Atención</label>
                                    <input type="text" id="attention-code">
                                </div>
                                <button class="btn btn-primary" id="validate-btn">
                                    <i class="fas fa-check-circle"></i> Validar
                                </button>
                            </div>
                            
                            <div class="input-group">
                                <div class="form-group">
                                    <label for="dni">DNI</label>
                                    <input type="text" id="dni">
                                </div>
                                
                                <div class="form-group">
                                    <label for="age">Edad</label>
                                    <input type="number" id="age">
                                </div>
                            </div>
                            
                            <div class="input-group">
                                <div class="form-group">
                                    <label for="last-name">APELLIDOS</label>
                                    <input type="text" id="last-name">
                                </div>
                                
                                <div class="form-group">
                                    <label for="first-name">NOMBRES</label>
                                    <input type="text" id="first-name">
                                </div>
                            </div>
                            
                            <div class="input-group">
                                <div class="form-group">
                                    <label for="phone">Teléfono</label>
                                    <input type="text" id="phone">
                                </div>
                                
                                <div class="form-group">
                                    <label for="gender">Sexo</label>
                                    <select id="gender">
                                        <option value="Masculino">Masculino</option>
                                        <option value="Femenino">Femenino</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="input-group">
                                <div class="form-group">
                                    <label for="contact-date">Familiar de Contacto</label>
                                    <input type="text" id="contact-date">
                                </div>
                                
                                <div class="form-group">
                                    <label for="contact-phone">Teléfono de Contacto</label>
                                    <input type="text" id="contact-phone">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="requesting-doctor">Med. Solicitante</label>
                                <div class="combo-input-container">
                                    <input type="text" id="requesting-doctor" placeholder="Escribir o seleccionar médico..." list="doctors-options">
                                    <datalist id="doctors-options">
                                        <!-- Las opciones se cargarán dinámicamente -->
                                    </datalist>
                                </div>
                                <button type="button" class="btn btn-secondary" id="register-doctor-now-btn" style="margin-top: 10px; font-size: 0.9rem; padding: 8px 16px;">
                                    <i class="fas fa-user-plus"></i> Registrar Médico Nuevo
                                </button>
                            </div>
                            
                            <div class="form-group">
                                <label for="study-reason">Motivo Estudio</label>
                                <textarea id="study-reason" rows="3"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label for="clinic">Clínica donde proviene la muestra</label>
                                <input type="text" id="clinic">
                            </div>
                        </div>
                        
                        <div class="section">
                            <div class="section-title">Orden Servicio</div>
                            
                            <div class="file-upload" id="orden-servicio-upload">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <div class="file-text">Elegir archivos (JPG)</div>
                                <div class="file-text">Ningún archivo seleccionado</div>
                            </div>
                        </div>
                        
                        <div class="date-box">
                            <div class="date-label">Fecha de Registro</div>
                            <div class="date-value" id="registration-date"></div>
                        </div>
                        
                        <div class="date-box">
                            <div class="date-label">Fec. Probable-Entrega</div>
                            <div class="date-value" id="delivery-date"></div>
                        </div>
                        
                        <div class="buttons">
                            <button class="btn btn-outline" id="exit-btn">
                                <i class="fas fa-door-open"></i> Salir
                            </button>
                            <button class="btn btn-primary" id="save-btn">
                                <i class="fas fa-save"></i> Guardar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Página de registro de médicos -->
            <div id="registro-medicos" class="page-content">
                <div class="container">
                    <div class="card">
                        <div class="card-header">
                            <h1>REGISTRO DE MÉDICOS</h1>
                        </div>
                        
                        <div class="filters">
                            <div class="filter-group">
                                <label for="search-nombre-completo-med">Nombre del médico</label>
                                <input type="text" id="search-nombre-completo-med" placeholder="Ej: DR. CARLOS GONZÁLEZ PÉREZ" value="">
                            </div>
                            
                            <div class="filter-group">
                                <label for="search-especialidad-med">Especialidad</label>
                                <input type="text" id="search-especialidad-med" placeholder="Especialidad" value="">
                            </div>
                            
                            <div class="filter-group">
                                <label for="clinica-med">Clínica de procedencia</label>
                                <input type="text" id="clinica-med" placeholder="Clínica">
                            </div>
                            
                            <button class="search-btn" id="search-btn-med">
                                <i class="fas fa-search"></i> Buscar
                            </button>
                            
                            <button class="search-btn" id="register-btn-med" style="background: linear-gradient(135deg, var(--success), #2e7d32);">
                                <i class="fas fa-user-plus"></i> Registrar Médico
                            </button>
                            
                            <button class="search-btn update-btn" id="update-btn-med" style="display: none;">
                                <i class="fas fa-sync-alt"></i> Actualizar
                            </button>
                            
                            <button class="search-btn" id="cancel-btn-med" style="background: linear-gradient(135deg, #f57c00, #e64a19); display: none;">
                                <i class="fas fa-times"></i> Cancelar
                            </button>
                        </div>
                        
                        <div class="results-container">
                            <table class="results-table" id="medicos-results-table">
                                <thead>
                                    <tr>
                                        <th>Nº</th>
                                        <th>NOMBRE DEL MÉDICO</th>
                                        <th>ESPECIALIDAD</th>
                                        <th>CLINICA DE PROCEDENCIA</th>
                                        <th>MODIFICAR</th>
                                        <th>ELIMINAR</th>
                                    </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="pagination" id="pagination-med">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Página de resultados quirúrgicos -->
            <div id="resultados-quirurgicos" class="page-content">
                <div class="container">
                    <div class="card">
                        <div class="card-header">
                            <h1>RESULTADOS QUIRÚRGICOS</h1>
                        </div>
                        
                        <div class="filters">
                            <div class="filter-group">
                                <label for="search-cod">Código de Atención</label>
                                <input type="text" id="search-cod" placeholder="Ej: 25Q-402" value="">
                            </div>
                            
                            <div class="filter-group">
                                <label for="search-dni">DNI</label>
                                <input type="text" id="search-dni" placeholder="Ej: 42560314" value="">
                            </div>
                            
                            <div class="filter-group">
                                <label for="search-paciente">Paciente</label>
                                <input type="text" id="search-paciente" placeholder="Nombre del paciente" value="">
                            </div>
                            
                            <button class="search-btn" id="search-btn">
                                <i class="fas fa-search"></i> Buscar
                            </button>
                        </div>
                        
                        <div class="results-container">
                            <table class="results-table" id="surgical-results-table">
                                <thead>
                                    <tr>
                                        <th>Nº</th>
                                        <th>COD-ATENCIÓN</th>
                                        <th>DNI</th>
                                        <th>EDAD</th>
                                        <th>APELLIDOS</th>
                                        <th>NOMBRES</th>
                                        <th>SEXO</th>
                                        <th>MED. SOLICITANTE</th>
                                        <th>CLINICA DE PROCEDENCIA</th>
                                        <th>FECHA DE REGISTRO</th>
                                        <th>FECHA DE INFORME</th>
                                        <th>INFORME</th>
                                        <th>ELIMINAR</th>
                                        <th>PDF</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Los datos se cargarán dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="pagination" id="pagination">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Página de resultados citológicos -->
            <div id="resultados-citologicos" class="page-content">
                <div class="container">
                    <div class="card">
                        <div class="card-header">
                            <h1>RESULTADOS CITOLÓGICOS</h1>
                        </div>
                        
                        <div class="filters">
                            <div class="filter-group">
                                <label for="search-cod-cito">Código de Atención</label>
                                <input type="text" id="search-cod-cito" placeholder="Ej: 25C-402" value="">
                            </div>
                            
                            <div class="filter-group">
                                <label for="search-dni-cito">DNI</label>
                                <input type="text" id="search-dni-cito" placeholder="Ej: 42560314" value="">
                            </div>
                            
                            <div class="filter-group">
                                <label for="search-paciente-cito">Paciente</label>
                                <input type="text" id="search-paciente-cito" placeholder="Nombre del paciente" value="">
                            </div>
                            
                            <button class="search-btn" id="search-btn-cito">
                                <i class="fas fa-search"></i> Buscar
                            </button>
                        </div>
                        
                        <div class="results-container">
                            <table class="results-table" id="cytological-results-table">
                                <thead>
                                    <tr>
                                        <th>Nº</th>
                                        <th>COD-ATENCIÓN</th>
                                        <th>DNI</th>
                                        <th>EDAD</th>
                                        <th>APELLIDOS</th>
                                        <th>NOMBRES</th>
                                        <th>SEXO</th>
                                        <th>MED. SOLICITANTE</th>
                                        <th>CLINICA DE PROCEDENCIA</th>
                                        <th>FECHA DE REGISTRO</th>
                                        <th>FECHA DE INFORME</th>
                                        <th>INFORME</th>
                                        <th>ELIMINAR</th>
                                        <th>PDF</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Los datos se cargarán dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="pagination" id="pagination-cito">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Página de plantillas -->
            <div id="plantillas" class="page-content">
                <div class="container">
                    <div class="card">
                        <div class="card-header">
                            <h1>PLANTILLAS</h1>
                        </div>
                        <iframe class="plantillas-iframe" src="plantillas.html"></iframe>
                    </div>
                </div>
            </div>

            <!-- Página de Gestión de Usuarios -->
            <div id="gestion-usuarios" class="page-content">
                <div class="container">
                    <div class="card">
                        <div class="card-header">
                            <h1>Gestión de Usuarios</h1>
                        </div>
                        <div class="section">
                            <h2 class="section-title">Registrar Nuevo Usuario</h2>
                            <form id="user-register-form">
                                <div class="input-group">
                                    <div class="form-group">
                                        <label for="new-username">Nombre de Usuario</label>
                                        <input type="text" id="new-username" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="new-password">Contraseña</label>
                                        <input type="password" id="new-password" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="new-role">Rol</label>
                                        <select id="new-role">
                                            <option value="viewer">Viewer</option>
                                            <option value="admin">Admin</option>
                                        </select>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary">Registrar Usuario</button>
                                <p id="register-feedback" style="margin-top: 10px;"></p>
                            </form>
                        </div>
                        <div class="section">
                            <h2 class="section-title">Usuarios del Sistema</h2>
                            <div class="results-container">
                                <table class="results-table" id="user-list-table">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Username</th>
                                            <th>Role</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="user-list-tbody">
                                        <!-- User list will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Página para ver el informe -->
            <div id="ver-informe" class="page-content">
                <div class="container">
                    <div class="card">
                        <div class="card-header">
                            <h1>INFORME DE PATOLOGÍA</h1>
                        </div>
                        
                        <div class="section">
                            <div class="section-title">Datos del Servicio</div>
                            
                            <div class="data-card">
                                <div class="data-grid">
                                    <div class="data-item">
                                        <span class="data-label">Cod. Atención</span>
                                        <div class="data-value" id="informe-cod-atencion"></div>
                                    </div>
                                    <div class="data-item">
                                        <span class="data-label">DNI</span>
                                        <input type="text" class="editable-field" id="informe-dni" value="">
                                    </div>
                                    <div class="data-item">
                                        <span class="data-label">Sexo</span>
                                        <select class="editable-select" id="informe-sexo">
                                            <option value="masculino">MASCULINO</option>
                                            <option value="femenino">FEMENINO</option>
                                        </select>
                                    </div>
                                    
                                    <div class="data-item">
                                        <span class="data-label">Apellidos</span>
                                        <input type="text" class="editable-field" id="informe-apellidos" value="">
                                    </div>
                                    <div class="data-item">
                                        <span class="data-label">Nombres</span>
                                        <input type="text" class="editable-field" id="informe-nombres" value="">
                                    </div>
                                    
                                    <div class="data-item">
                                        <span class="data-label">Edad</span>
                                        <input type="text" class="editable-field" id="informe-edad" value="">
                                    </div>
                                    <div class="data-item">
                                        <span class="data-label">Teléfono</span>
                                        <input type="text" class="editable-field" id="informe-telefono" value="">
                                    </div>
                                    <div class="data-item">
                                        <span class="data-label">F. Contacto</span>
                                        <input type="text" class="editable-field" id="informe-contacto" value="">
                                    </div>
                                    <div class="data-item">
                                        <span class="data-label">Tel. Contacto</span>
                                        <input type="text" class="editable-field" id="informe-tel-contacto" value="">
                                    </div>
                                    <div class="data-item">
                                        <span class="data-label">Clínica de donde proviene la muestra</span>
                                        <input type="text" class="editable-field" id="informe-clinica" value="">
                                    </div>
                                    <div class="data-item">
                                        <span class="data-label">Med. Solicitante</span>
                                        <input type="text" class="editable-field" id="informe-medico" list="doctors-options">
                                    </div>
                                    <div class="data-item double-column">
                                        <span class="data-label">Motivo Estudio</span>
                                        <textarea class="editable-field" id="informe-motivo" rows="3"></textarea>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="doctor-section">
                                <div class="doctor-info">
                                    <div class="data-item">
                                        <span class="data-label">Fecha de Registro</span>
                                        <div class="data-value" id="fecha-registro"></div>
                                    </div>
                                </div>
                                
                                <div class="delivery-info">
                                    <div class="data-item">
                                        <span class="data-label">Fec. Probable Entrega</span>
                                        <div class="data-value" id="fecha-entrega"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="section">
                            <div class="section-title">Descripción Macro y Microscópica</div>
                            
                            <div class="description-container">
                                <!-- Sección Macroscópica -->
                                <div class="description-section">
                                    <h3>Descripción Macroscópica</h3>
                                    
                                    <div class="form-group">
                                        <label for="categoria-macro">Categoría</label>
                                        <select id="categoria-macro" class="template-select">
                                            <option value="">Seleccionar categoría</option>
                                        </select>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="plantilla-macro">Plantilla Macroscópica</label>
                                        <select id="plantilla-macro" class="template-select">
                                            <option value="">Seleccionar plantilla</option>
                                        </select>
                                    </div>
                                    
                                    <div class="editor-container">
                                        <div class="editor-toolbar">
                                            <button type="button" class="format-btn" data-command="bold" title="Negrita"><i class="fas fa-bold"></i></button>
                                            <button type="button" class="format-btn" data-command="italic" title="Cursiva"><i class="fas fa-italic"></i></button>
                                            <button type="button" class="format-btn" data-command="underline" title="Subrayado"><i class="fas fa-underline"></i></button>
                                            <button type="button" class="format-btn" data-command="insertUnorderedList" title="Lista"><i class="fas fa-list-ul"></i></button>
                                            <button type="button" class="format-btn" data-command="insertOrderedList" title="Lista numerada"><i class="fas fa-list-ol"></i></button>
                                            <button type="button" class="format-btn" data-command="justifyFull" title="Justificar"><i class="fas fa-align-justify"></i></button>
                                            <select class="format-select" data-command="fontName" title="Tipo de letra"><option value="">Fuente</option><option value="Arial">Arial</option><option value="Times New Roman">Times New Roman</option><option value="Helvetica">Helvetica</option><option value="Georgia">Georgia</option><option value="Verdana">Verdana</option></select>
                                            <select class="format-select" data-command="fontSize" title="Tamaño de letra"><option value="">Tamaño</option><option value="1">8pt</option><option value="2">10pt</option><option value="3">12pt</option><option value="4">14pt</option><option value="5">18pt</option><option value="6">24pt</option><option value="7">36pt</option></select>
                                        </div>
                                        <div class="editor-content" id="macro-editor" contenteditable="true"></div>
                                    </div>
                                </div>
                                
                                <!-- Sección Microscópica -->
                                <div class="description-section">
                                    <h3>Descripción Microscópica</h3>
                                    
                                    <div class="form-group">
                                        <label for="categoria-micro">Categoría</label>
                                        <select id="categoria-micro" class="template-select">
                                            <option value="">Seleccionar categoría</option>
                                        </select>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="plantilla-micro">Plantilla Microscópica</label>
                                        <select id="plantilla-micro" class="template-select">
                                            <option value="">Seleccionar plantilla</option>
                                        </select>
                                    </div>
                                    
                                    <div class="editor-container">
                                        <div class="editor-toolbar">
                                            <button type="button" class="format-btn" data-command="bold" title="Negrita"><i class="fas fa-bold"></i></button>
                                            <button type="button" class="format-btn" data-command="italic" title="Cursiva"><i class="fas fa-italic"></i></button>
                                            <button type="button" class="format-btn" data-command="underline" title="Subrayado"><i class="fas fa-underline"></i></button>
                                            <button type="button" class="format-btn" data-command="insertUnorderedList" title="Lista"><i class="fas fa-list-ul"></i></button>
                                            <button type="button" class="format-btn" data-command="insertOrderedList" title="Lista numerada"><i class="fas fa-list-ol"></i></button>
                                            <button type="button" class="format-btn" data-command="justifyFull" title="Justificar"><i class="fas fa-align-justify"></i></button>
                                            <select class="format-select" data-command="fontName" title="Tipo de letra"><option value="">Fuente</option><option value="Arial">Arial</option><option value="Times New Roman">Times New Roman</option><option value="Helvetica">Helvetica</option><option value="Georgia">Georgia</option><option value="Verdana">Verdana</option></select>
                                            <select class="format-select" data-command="fontSize" title="Tamaño de letra"><option value="">Tamaño</option><option value="1">8pt</option><option value="2">10pt</option><option value="3">12pt</option><option value="4">14pt</option><option value="5">18pt</option><option value="6">24pt</option><option value="7">36pt</option></select>
                                        </div>
                                        <div class="editor-content" id="micro-editor" contenteditable="true"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- CUADRO DE DIAGNÓSTICO -->
                            <div class="diagnostico-section">
                                <h3>Diagnóstico</h3>
                                <div class="diagnostico-container">
                                    <div class="editor-toolbar">
                                        <button type="button" class="format-btn" data-command="bold" title="Negrita"><i class="fas fa-bold"></i></button>
                                        <button type="button" class="format-btn" data-command="italic" title="Cursiva"><i class="fas fa-italic"></i></button>
                                        <button type="button" class="format-btn" data-command="underline" title="Subrayado"><i class="fas fa-underline"></i></button>
                                        <button type="button" class="format-btn" data-command="insertUnorderedList" title="Lista"><i class="fas fa-list-ul"></i></button>
                                        <button type="button" class="format-btn" data-command="insertOrderedList" title="Lista numerada"><i class="fas fa-list-ol"></i></button>
                                        <button type="button" class="format-btn" title="Centrar texto" data-command="justifyCenter"><i class="fas fa-align-center"></i></button>
                                        <button type="button" class="format-btn" title="Texto a la izquierda" data-command="justifyLeft"><i class="fas fa-align-left"></i></button>
                                        <button type="button" class="format-btn" title="Texto a la derecha" data-command="justifyRight"><i class="fas fa-align-right"></i></button>
                                        <button type="button" class="format-btn" title="Justificar" data-command="justifyFull"><i class="fas fa-align-justify"></i></button>
                                        <select class="format-select" data-command="fontName" title="Tipo de letra"><option value="">Fuente</option><option value="Arial">Arial</option><option value="Times New Roman">Times New Roman</option><option value="Helvetica">Helvetica</option><option value="Georgia">Georgia</option><option value="Verdana">Verdana</option></select>
                                        <select class="format-select" data-command="fontSize" title="Tamaño de letra"><option value="">Tamaño</option><option value="1">8pt</option><option value="2">10pt</option><option value="3">12pt</option><option value="4">14pt</option><option value="5">18pt</option><option value="6">24pt</option><option value="7">36pt</option></select>
                                    </div>
                                    <div class="editor-content" id="diagnostico-editor" contenteditable="true"></div>
                                </div>
                            </div>
                            
                            <!-- SECCIÓN PARA SUBIR FOTOS -->
                            <div class="photos-section">
                                <h3>Fotos Adjuntas</h3>
                                <div class="photos-grid">
                                    <div class="photo-upload" id="photo-1" onclick="openCropModal(1)"><i class="fas fa-camera"></i><div class="photo-text">Haga clic o arrastre una foto (JPG)</div><img class="photo-preview" id="preview-1" alt="Vista previa de la foto"><div class="photo-controls" style="display: none;" id="controls-1"><button class="photo-btn" onclick="openCropModal(1)"><i class="fas fa-sync"></i> Cambiar</button><button class="photo-btn" onclick="removePhoto(1)"><i class="fas fa-trash"></i> Eliminar</button></div><input type="file" id="photo-input-1" accept="image/jpeg" style="display: none;" onchange="handlePhotoSelect(this, 1)"></div>
                                    <div class="photo-upload" id="photo-2" onclick="openCropModal(2)"><i class="fas fa-camera"></i><div class="photo-text">Haga clic o arrastre una foto (JPG)</div><img class="photo-preview" id="preview-2" alt="Vista previa de la foto"><div class="photo-controls" style="display: none;" id="controls-2"><button class="photo-btn" onclick="openCropModal(2)"><i class="fas fa-sync"></i> Cambiar</button><button class="photo-btn" onclick="removePhoto(2)"><i class="fas fa-trash"></i> Eliminar</button></div><input type="file" id="photo-input-2" accept="image/jpeg" style="display: none;" onchange="handlePhotoSelect(this, 2)"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="buttons">
                            <button class="btn btn-outline" id="volver-btn"><i class="fas fa-arrow-left"></i> Volver</button>
                            <button class="btn btn-primary" id="preliminary-btn"><i class="fas fa-print"></i> Informe Preliminar</button>
                            <button class="btn btn-save" id="guardar-btn"><i class="fas fa-save"></i> Guardar</button>
                            <button class="btn btn-sign" id="firmar-btn"><i class="fas fa-signature"></i> Firmar</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para recorte de foto -->
    <div id="crop-modal" class="crop-modal">
        <div class="crop-content">
            <h2>Recortar Foto</h2>
            <p class="crop-info">Seleccione el área de 4.5x4.5 cm para recortar la imagen</p>
            <div class="crop-area" id="crop-area"><img id="crop-preview" class="crop-preview"><div class="crop-box" id="crop-box"><div class="crop-handle" id="crop-handle"></div></div></div>
            <div class="crop-buttons"><button class="btn btn-outline" id="cancel-crop">Cancelar</button><button class="btn btn-primary" id="save-crop">Guardar Recorte</button></div>
        </div>
    </div>

    <!-- Modal para registro de médicos -->
    <div id="doctor-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Registrar Nuevo Médico</h2>
                <span class="modal-close" id="close-doctor-modal">&times;</span>
            </div>
            <div class="modal-body">
                <form id="doctor-form">
                    <div class="form-group"><label for="doctor-name">Nombre del Médico</label><input type="text" id="doctor-name" placeholder="Ej: DR. CARLOS GONZÁLEZ PÉREZ" required></div>
                    <div class="form-group"><label for="doctor-specialty">Especialidad</label><input type="text" id="doctor-specialty" placeholder="Ej: Patología General" required></div>
                    <div class="form-group"><label for="doctor-clinic">Clínica de Procedencia</label><input type="text" id="doctor-clinic" placeholder="Ej: Clínica Central" required></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" id="cancel-doctor-modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="save-doctor-modal">Guardar Médico</button>
            </div>
        </div>
    </div>

    <script>
        // Global state variables
        let currentPatientId = null;
        let allTemplates = [];
        let cropper;
        let currentPhotoSlot;
        let currentDoctorId = null;

        // Functions in Global Scope for HTML onclick attributes
        function openCropModal(slot) {
            currentPhotoSlot = slot;
            document.getElementById(`photo-input-${slot}`).click();
        }

        function removePhoto(slot) {
            const preview = document.getElementById(`preview-${slot}`);
            preview.src = '';
            preview.style.display = 'none';
            document.querySelector(`#photo-${slot} .photo-text`).style.display = 'block';
            document.getElementById(`controls-${slot}`).style.display = 'none';
            document.getElementById(`photo-input-${slot}`).value = ''; // Reset file input
        }

        function handlePhotoSelect(input, slot) {
            const cropModal = document.getElementById('crop-modal');
            const cropPreview = document.getElementById('crop-preview');
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    cropPreview.src = e.target.result;
                    cropModal.style.display = 'flex';
                    if (cropper) {
                        cropper.destroy();
                    }
                    cropper = new Cropper(cropPreview, {
                        aspectRatio: 1,
                        viewMode: 1,
                        autoCropArea: 0.8
                    });
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const token = sessionStorage.getItem('token');
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));

            if (!token || !currentUser) {
                window.location.href = 'index.html';
                return;
            }

            // --- GENERAL UI SETUP ---
            const userNameDisplay = document.querySelector('.user-name');
            if (userNameDisplay && currentUser && currentUser.username) {
                userNameDisplay.textContent = currentUser.username;
                const userAvatar = document.querySelector('.user-avatar');
                userAvatar.textContent = currentUser.username.substring(0, 2).toUpperCase();
            }

            if (currentUser && currentUser.role === 'admin') {
                document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'block');
            }

            document.getElementById('logout-btn').addEventListener('click', () => {
                sessionStorage.clear();
                window.location.href = 'index.html';
            });

            // --- PAGE NAVIGATION ---
            const menuItems = document.querySelectorAll('.menu-item');
            const pages = document.querySelectorAll('.page-content');
            const pageTitle = document.getElementById('page-title');

            menuItems.forEach(item => {
                item.addEventListener('click', () => {
                    const link = item.getAttribute('data-link');
                    if (!link) return;

                    menuItems.forEach(i => i.classList.remove('active'));
                    pages.forEach(p => p.classList.remove('active'));

                    item.classList.add('active');
                    document.getElementById(link).classList.add('active');
                    pageTitle.textContent = item.querySelector('.menu-text').textContent;
                });
            });

            // --- DOCTOR LOGIC ---
            function loadDoctors() {
                fetch('http://localhost:3000/api/doctors', { headers: { 'Authorization': `Bearer ${token}` } })
                .then(res => res.json())
                .then(data => {
                    const tbody = document.getElementById('medicos-results-table').querySelector('tbody');
                    const doctorsDatalist = document.getElementById('doctors-options');
                    tbody.innerHTML = '';
                    doctorsDatalist.innerHTML = '';

                    if (data.doctors) {
                        data.doctors.forEach((doctor, index) => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${index + 1}</td>
                                <td>${doctor.nombreCompleto}</td>
                                <td>${doctor.especialidad || '-'}</td>
                                <td>${doctor.clinica || '-'}</td>
                                <td><button class="modify-btn doctor-modify-btn" data-id="${doctor.id}"><i class="fas fa-edit"></i></button></td>
                                <td><button class="delete-btn doctor-delete-btn" data-id="${doctor.id}"><i class="fas fa-trash-alt"></i></button></td>
                            `;
                            tbody.appendChild(row);

                            const option = document.createElement('option');
                            option.value = doctor.nombreCompleto;
                            doctorsDatalist.appendChild(option);
                        });
                    }
                });
            }

            function resetDoctorForm() {
                document.getElementById('search-nombre-completo-med').value = '';
                document.getElementById('search-especialidad-med').value = '';
                document.getElementById('clinica-med').value = '';
                currentDoctorId = null;
                document.getElementById('register-btn-med').style.display = 'inline-block';
                document.getElementById('update-btn-med').style.display = 'none';
                document.getElementById('cancel-btn-med').style.display = 'none';
            }

            document.querySelector('[data-link="registro-medicos"]').addEventListener('click', loadDoctors);

            document.getElementById('register-btn-med').addEventListener('click', () => {
                const nombreCompleto = document.getElementById('search-nombre-completo-med').value;
                if (!nombreCompleto) return alert('El nombre del médico es obligatorio.');
                const especialidad = document.getElementById('search-especialidad-med').value;
                const clinica = document.getElementById('clinica-med').value;

                fetch('http://localhost:3000/api/doctors', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ nombreCompleto, especialidad, clinica })
                })
                .then(res => res.json())
                .then(data => {
                    alert(data.message || data.error);
                    if (!data.error) {
                        resetDoctorForm();
                        loadDoctors();
                    }
                });
            });
            
            document.getElementById('medicos-results-table').addEventListener('click', (e) => {
                const modifyBtn = e.target.closest('.doctor-modify-btn');
                if (modifyBtn) {
                    const id = modifyBtn.dataset.id;
                    const row = modifyBtn.closest('tr');
                    const cells = row.querySelectorAll('td');
                    document.getElementById('search-nombre-completo-med').value = cells[1].textContent;
                    document.getElementById('search-especialidad-med').value = cells[2].textContent;
                    document.getElementById('clinica-med').value = cells[3].textContent;
                    currentDoctorId = id;
                    document.getElementById('register-btn-med').style.display = 'none';
                    document.getElementById('update-btn-med').style.display = 'inline-block';
                    document.getElementById('cancel-btn-med').style.display = 'inline-block';
                }

                const deleteBtn = e.target.closest('.doctor-delete-btn');
                if (deleteBtn) {
                    const id = deleteBtn.dataset.id;
                    if (confirm(`¿Estás seguro de eliminar al médico con ID ${id}?`)) {
                        fetch(`http://localhost:3000/api/doctors/${id}`, {
                            method: 'DELETE',
                            headers: { 'Authorization': `Bearer ${token}` }
                        })
                        .then(res => res.json())
                        .then(data => {
                            alert(data.message || data.error);
                            loadDoctors();
                        });
                    }
                }
            });

            document.getElementById('cancel-btn-med').addEventListener('click', resetDoctorForm);

            document.getElementById('update-btn-med').addEventListener('click', () => {
                if (!currentDoctorId) return;
                const nombreCompleto = document.getElementById('search-nombre-completo-med').value;
                if (!nombreCompleto) return alert('El nombre del médico es obligatorio.');
                const especialidad = document.getElementById('search-especialidad-med').value;
                const clinica = document.getElementById('clinica-med').value;

                fetch(`http://localhost:3000/api/doctors/${currentDoctorId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ nombreCompleto, especialidad, clinica })
                })
                .then(res => res.json())
                .then(data => {
                    alert(data.message || data.error);
                    if (!data.error) {
                        resetDoctorForm();
                        loadDoctors();
                    }
                });
            });

            // --- TEMPLATE LOGIC ---
            async function loadTemplates() {
                try {
                    const response = await fetch('http://localhost:3000/api/templates', { headers: { 'Authorization': `Bearer ${token}` } });
                    const data = await response.json();
                    if (response.ok) {
                        allTemplates = data.templates;
                        const specialities = [...new Set(allTemplates.map(t => t.especialidad).filter(Boolean))];
                        const macroCategory = document.getElementById('categoria-macro');
                        const microCategory = document.getElementById('categoria-micro');
                        macroCategory.innerHTML = '<option value="">Seleccionar categoría</option>';
                        microCategory.innerHTML = '<option value="">Seleccionar categoría</option>';
                        specialities.forEach(spec => {
                            const option = `<option value="${spec}">${spec}</option>`;
                            macroCategory.innerHTML += option;
                            microCategory.innerHTML += option;
                        });
                    }
                } catch (error) {
                    console.error('Error al cargar las plantillas:', error);
                }
            }

            function populateTemplateDropdown(category, type) {
                const templateDropdown = document.getElementById(`plantilla-${type}`);
                templateDropdown.innerHTML = '<option value="">Seleccionar plantilla</option>';
                const dbType = type === 'macro' ? 'macroscopia' : 'microscopia';
                const filteredTemplates = allTemplates.filter(t => t.especialidad === category && t.tipo === dbType);
                filteredTemplates.forEach(t => {
                    templateDropdown.innerHTML += `<option value="${t.id}">${t.nombre}</option>`;
                });
            }

            document.getElementById('categoria-macro').addEventListener('change', (e) => populateTemplateDropdown(e.target.value, 'macro'));
            document.getElementById('categoria-micro').addEventListener('change', (e) => populateTemplateDropdown(e.target.value, 'micro'));

            document.getElementById('plantilla-macro').addEventListener('change', (e) => {
                const template = allTemplates.find(t => t.id == e.target.value);
                if (template) document.getElementById('macro-editor').innerHTML = template.contenido;
            });

            document.getElementById('plantilla-micro').addEventListener('change', (e) => {
                const template = allTemplates.find(t => t.id == e.target.value);
                if (template) {
                    document.getElementById('micro-editor').innerHTML = template.contenido;
                    document.getElementById('diagnostico-editor').innerHTML = template.diagnostico;
                }
            });

            // --- PATIENT LOGIC (NEW PATIENT FORM) ---
            const registrationDateEl = document.getElementById('registration-date');
            const deliveryDateEl = document.getElementById('delivery-date');
            const serviceTypeEl = document.getElementById('service-type');
            const attentionCodeEl = document.getElementById('attention-code');

            function setDates() {
                const today = new Date();
                const deliveryDate = new Date();
                deliveryDate.setDate(today.getDate() + 3);
                const formatDate = (date) => {
                    const day = String(date.getDate()).padStart(2, '0');
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const year = date.getFullYear();
                    return `${day}-${month}-${year}`;
                }
                if(registrationDateEl) registrationDateEl.textContent = formatDate(today);
                if(deliveryDateEl) deliveryDateEl.textContent = formatDate(deliveryDate);
            }

            serviceTypeEl.addEventListener('change', () => {
                const selectedValue = serviceTypeEl.value;
                if (selectedValue === 'muestras-quirurgicas') {
                    attentionCodeEl.value = '25Q-';
                } else if (selectedValue === 'muestras-citologicas') {
                    attentionCodeEl.value = '25C-';
                } else {
                    attentionCodeEl.value = '';
                }
                attentionCodeEl.focus();
            });

            function showConfirmation(message, isError = false) {
                const el = document.getElementById(isError ? 'duplicate-message' : 'confirmation-message');
                el.textContent = message;
                el.style.display = 'block';
                setTimeout(() => { el.style.display = 'none'; }, 3000);
            }

            function resetPatientForm() {
                // Manually reset all fields
                document.getElementById('service-type').value = '';
                document.getElementById('attention-code').value = '';
                document.getElementById('dni').value = '';
                document.getElementById('age').value = '';
                document.getElementById('last-name').value = '';
                document.getElementById('first-name').value = '';
                document.getElementById('phone').value = '';
                document.getElementById('gender').value = 'Masculino'; // Reset to default
                document.getElementById('contact-date').value = '';
                document.getElementById('contact-phone').value = '';
                document.getElementById('requesting-doctor').value = '';
                document.getElementById('study-reason').value = '';
                document.getElementById('clinic').value = '';

                // Reset dates
                setDates();
            }

            async function saveNewPatient() {
                const patientData = {
                    service_type: document.getElementById('service-type').value,
                    attention_code: document.getElementById('attention-code').value,
                    dni: document.getElementById('dni').value,
                    age: document.getElementById('age').value,
                    last_name: document.getElementById('last-name').value,
                    first_name: document.getElementById('first-name').value,
                    phone: document.getElementById('phone').value,
                    gender: document.getElementById('gender').value,
                    contact_family: document.getElementById('contact-date').value,
                    contact_phone: document.getElementById('contact-phone').value,
                    requesting_doctor: document.getElementById('requesting-doctor').value,
                    study_reason: document.getElementById('study-reason').value,
                    clinic: document.getElementById('clinic').value,
                    registration_date: document.getElementById('registration-date').textContent,
                    delivery_date: document.getElementById('delivery-date').textContent
                };

                if (!patientData.attention_code || !patientData.last_name || !patientData.first_name) {
                    return alert('Por favor, complete los campos obligatorios: Cod. Atención, Apellidos y Nombres.');
                }

                try {
                    const response = await fetch('http://localhost:3000/api/patients', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify(patientData)
                    });
                    const result = await response.json();
                    showConfirmation(result.message || result.error, !response.ok);
                    if (response.ok) {
                        resetPatientForm();
                    }
                } catch (error) {
                    console.error('Error al guardar el paciente:', error);
                    showConfirmation('No se pudo conectar con el servidor.', true);
                }
            }

            // --- PATIENT LOGIC (LISTING, DETAILS, UPDATE) ---
            async function loadPatients() {
                try {
                    const response = await fetch('http://localhost:3000/api/patients', { headers: { 'Authorization': `Bearer ${token}` } });
                    const data = await response.json();
                    if (!response.ok) return;

                    const surgicalTbody = document.getElementById('surgical-results-table').querySelector('tbody');
                    const cytologicalTbody = document.getElementById('cytological-results-table').querySelector('tbody');
                    surgicalTbody.innerHTML = '';
                    cytologicalTbody.innerHTML = '';

                    data.patients.forEach((patient, index) => {
                        const rowHTML = `
                            <td>${index + 1}</td>
                            <td>${patient.attention_code}</td>
                            <td>${patient.dni}</td>
                            <td>${patient.age}</td>
                            <td>${patient.last_name}</td>
                            <td>${patient.first_name}</td>
                            <td>${patient.gender}</td>
                            <td>${patient.requesting_doctor}</td>
                            <td>${patient.clinic}</td>
                            <td>${patient.registration_date}</td>
                            <td></td>
                            <td><button class="btn-informe btn-modificar" data-id="${patient.id}">Modificar</button></td>
                            <td><button class="delete-btn" data-id="${patient.id}"><i class="fas fa-trash-alt"></i></button></td>
                            <td>
                                ${patient.pdf_path 
                                    ? `<a href="/${patient.pdf_path.replace('.\\', '')}" download="${patient.attention_code}.pdf"><i class="fas fa-file-pdf" style="color: red; font-size: 1.5rem;"></i></a>` 
                                    : (patient.is_signed ? '<i class="fas fa-file-pdf" style="color: grey; font-size: 1.5rem;" title="PDF en proceso"></i>' : '')}
                            </td>
                        `;
                        if (patient.service_type === 'muestras-quirurgicas') {
                            surgicalTbody.innerHTML += `<tr>${rowHTML}</tr>`;
                        } else {
                            cytologicalTbody.innerHTML += `<tr>${rowHTML}</tr>`;
                        }
                    });
                } catch (error) {
                    console.error('Error al cargar pacientes:', error);
                }
            }

            async function showPatientDetails(patientId) {
                try {
                    const response = await fetch(`http://localhost:3000/api/patients/${patientId}`, { headers: { 'Authorization': `Bearer ${token}` } });
                    const data = await response.json();
                    if (response.ok) {
                        currentPatientId = patientId; // Set current patient context
                        const patient = data.patient;
                        document.getElementById('informe-cod-atencion').textContent = patient.attention_code;
                        document.getElementById('informe-dni').value = patient.dni;
                        document.getElementById('informe-sexo').value = patient.gender.toLowerCase();
                        document.getElementById('informe-apellidos').value = patient.last_name;
                        document.getElementById('informe-nombres').value = patient.first_name;
                        document.getElementById('informe-edad').value = patient.age;
                        document.getElementById('informe-telefono').value = patient.phone;
                        document.getElementById('informe-contacto').value = patient.contact_family;
                        document.getElementById('informe-tel-contacto').value = patient.contact_phone;
                        document.getElementById('informe-clinica').value = patient.clinic;
                        document.getElementById('informe-medico').value = patient.requesting_doctor;
                        document.getElementById('informe-motivo').value = patient.study_reason;
                        document.getElementById('fecha-registro').textContent = patient.registration_date;
                        document.getElementById('fecha-entrega').textContent = patient.delivery_date;
                        document.getElementById('macro-editor').innerHTML = patient.macro_description || '';
                        document.getElementById('micro-editor').innerHTML = patient.micro_description || '';
                        document.getElementById('diagnostico-editor').innerHTML = patient.diagnosis || '';
                        
                        // Load photos
                        [1, 2].forEach(slot => {
                            const photoData = patient[`photo${slot}`];
                            const preview = document.getElementById(`preview-${slot}`);
                            const photoText = document.querySelector(`#photo-${slot} .photo-text`);
                            const controls = document.getElementById(`controls-${slot}`);
                            if (photoData && photoData.startsWith('data:image')) {
                                preview.src = photoData;
                                preview.style.display = 'block';
                                photoText.style.display = 'none';
                                controls.style.display = 'flex';
                            } else {
                                preview.src = '';
                                preview.style.display = 'none';
                                photoText.style.display = 'block';
                                controls.style.display = 'none';
                            }
                        });

                        document.getElementById('firmar-btn').disabled = patient.is_signed;

                        document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active'));
                        document.getElementById('ver-informe').classList.add('active');
                        pageTitle.textContent = 'Detalle del Paciente';
                    } else {
                        alert(`Error: ${data.error}`);
                    }
                } catch (error) {
                    console.error('Error al cargar detalles del paciente:', error);
                }
            }

            async function updatePatient() {
                if (!currentPatientId) return alert('No hay un paciente seleccionado para actualizar.');
                
                const photo1 = document.getElementById('preview-1').src;
                const photo2 = document.getElementById('preview-2').src;

                const patientData = {
                    dni: document.getElementById('informe-dni').value,
                    age: document.getElementById('informe-edad').value,
                    last_name: document.getElementById('informe-apellidos').value,
                    first_name: document.getElementById('informe-nombres').value,
                    phone: document.getElementById('informe-telefono').value,
                    gender: document.getElementById('informe-sexo').value,
                    contact_family: document.getElementById('informe-contacto').value,
                    contact_phone: document.getElementById('informe-tel-contacto').value,
                    requesting_doctor: document.getElementById('informe-medico').value,
                    study_reason: document.getElementById('informe-motivo').value,
                    clinic: document.getElementById('informe-clinica').value,
                    macro_description: document.getElementById('macro-editor').innerHTML,
                    micro_description: document.getElementById('micro-editor').innerHTML,
                    diagnosis: document.getElementById('diagnostico-editor').innerHTML,
                    photo1: photo1.startsWith('data:image') ? photo1 : null,
                    photo2: photo2.startsWith('data:image') ? photo2 : null
                };
                try {
                    const response = await fetch(`http://localhost:3000/api/patients/${currentPatientId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify(patientData)
                    });
                    const result = await response.json();
                    alert(result.message || result.error);
                } catch (error) {
                    console.error('Error al actualizar el paciente:', error);
                    alert('No se pudo conectar con el servidor.');
                }
            }

            // --- EVENT LISTENERS ---
            document.getElementById('save-btn').addEventListener('click', saveNewPatient);
            document.getElementById('guardar-btn').addEventListener('click', updatePatient);
            document.querySelector('[data-link="resultados-quirurgicos"]').addEventListener('click', loadPatients);
            document.querySelector('[data-link="resultados-citologicos"]').addEventListener('click', loadPatients);

            document.getElementById('surgical-results-table').addEventListener('click', (e) => {
                if (e.target.classList.contains('btn-modificar')) {
                    showPatientDetails(e.target.dataset.id);
                }
            });
            document.getElementById('cytological-results-table').addEventListener('click', (e) => {
                if (e.target.classList.contains('btn-modificar')) {
                    showPatientDetails(e.target.dataset.id);
                }
            });

            // Photo/Crop Modal Logic
            const cropModal = document.getElementById('crop-modal');
            document.getElementById('cancel-crop').addEventListener('click', () => {
                if (cropper) cropper.destroy();
                cropModal.style.display = 'none';
            });
            document.getElementById('save-crop').addEventListener('click', () => {
                if (!cropper) return;
                const canvas = cropper.getCroppedCanvas({ width: 512, height: 512, imageSmoothingQuality: 'high' });
                document.getElementById(`preview-${currentPhotoSlot}`).src = canvas.toDataURL('image/jpeg');
                document.getElementById(`preview-${currentPhotoSlot}`).style.display = 'block';
                document.querySelector(`#photo-${currentPhotoSlot} .photo-text`).style.display = 'none';
                document.getElementById(`controls-${currentPhotoSlot}`).style.display = 'flex';
                document.getElementById('cancel-crop').click(); // Close modal
            });

            // Preliminary Report
            document.getElementById('preliminary-btn').addEventListener('click', () => {
                const photo1 = document.getElementById('preview-1').src;
                const photo2 = document.getElementById('preview-2').src;

                const reportData = {
                    attention_code: document.getElementById('informe-cod-atencion').textContent,
                    last_name: document.getElementById('informe-apellidos').value,
                    first_name: document.getElementById('informe-nombres').value,
                    gender: document.getElementById('informe-sexo').value,
                    registration_date: document.getElementById('fecha-registro').textContent,
                    requesting_doctor: document.getElementById('informe-medico').value,
                    clinic: document.getElementById('informe-clinica').value,
                    macro_description: document.getElementById('macro-editor').innerHTML,
                    micro_description: document.getElementById('micro-editor').innerHTML,
                    diagnosis: document.getElementById('diagnostico-editor').innerHTML,
                    photo1: photo1.startsWith('data:image') ? photo1 : null,
                    photo2: photo2.startsWith('data:image') ? photo2 : null
                };
                sessionStorage.setItem('preliminaryReportData', JSON.stringify(reportData));
                window.open('informe-preliminar.html', '_blank');
            });
            
            // Sign button
            document.getElementById('firmar-btn').addEventListener('click', async () => {
                if (!currentPatientId) return alert('No hay un paciente seleccionado.');
                if (!confirm('¿Está seguro de que desea firmar este informe? Esta acción es irreversible.')) return;
                try {
                    const response = await fetch(`http://localhost:3000/api/patients/${currentPatientId}/sign`, {
                        method: 'PUT',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const result = await response.json();
                    alert(result.message || result.error);
                    if (response.ok) {
                        document.getElementById('firmar-btn').disabled = true;
                        loadPatients();
                    }
                } catch (error) {
                    console.error('Error al firmar el informe:', error);
                    alert('No se pudo conectar con el servidor.');
                }
            });

            // Initial Load
            setDates();
            loadDoctors();
            loadTemplates();

            // Expose a function for the iframe to call
            window.refreshTemplates = loadTemplates;

            // --- USER MANAGEMENT LOGIC ---
            const userRegisterForm = document.getElementById('user-register-form');
            const registerFeedback = document.getElementById('register-feedback');

            async function loadUsers() {
                try {
                    const response = await fetch('http://localhost:3000/api/users', { headers: { 'Authorization': `Bearer ${token}` } });
                    const data = await response.json();
                    const userListTbody = document.getElementById('user-list-tbody');
                    userListTbody.innerHTML = '';
                    if (response.ok) {
                        data.users.forEach(user => {
                            const row = `<tr>
                                <td>${user.id}</td>
                                <td>${user.username}</td>
                                <td>${user.role}</td>
                                <td>
                                    ${currentUser.id != user.id ? `<button class="delete-btn user-delete-btn" data-id="${user.id}"><i class="fas fa-trash-alt"></i></button>` : ''}
                                </td>
                            </tr>`;
                            userListTbody.innerHTML += row;
                        });
                    }
                } catch (error) {
                    console.error('Error loading users:', error);
                }
            }

            if (userRegisterForm) {
                userRegisterForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const username = document.getElementById('new-username').value;
                    const password = document.getElementById('new-password').value;
                    const role = document.getElementById('new-role').value;

                    try {
                        const response = await fetch('http://localhost:3000/api/register', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                            body: JSON.stringify({ username, password, role })
                        });
                        const result = await response.json();
                        registerFeedback.textContent = result.message || result.error;
                        if (response.ok) {
                            userRegisterForm.reset();
                            loadUsers(); // Refresh user list
                        }
                    } catch (error) {
                        registerFeedback.textContent = 'Error de conexión.';
                    }
                });
            }

            document.getElementById('user-list-table').addEventListener('click', async (e) => {
                const deleteBtn = e.target.closest('.user-delete-btn');
                if (deleteBtn) {
                    const id = deleteBtn.dataset.id;
                    if (confirm(`¿Estás seguro de eliminar al usuario con ID ${id}?`)) {
                        try {
                            const response = await fetch(`http://localhost:3000/api/users/${id}`, {
                                method: 'DELETE',
                                headers: { 'Authorization': `Bearer ${token}` }
                            });
                            const result = await response.json();
                            alert(result.message || result.error);
                            if (response.ok) {
                                loadUsers();
                            }
                        } catch (error) {
                            alert('Error de conexión.');
                        }
                    }
                }
            });

            document.querySelector('[data-link="gestion-usuarios"]').addEventListener('click', loadUsers);

            // --- EDITOR TOOLBAR LOGIC ---
            function formatDoc(editorId, command, value = null) {
                const editor = document.getElementById(editorId);
                if (editor) {
                    editor.focus();
                    document.execCommand(command, false, value);
                }
            }

            document.querySelectorAll('.editor-toolbar').forEach(toolbar => {
                toolbar.addEventListener('click', (e) => {
                    const button = e.target.closest('.format-btn');
                    if (button) {
                        e.preventDefault(); // Prevent any default action
                        const command = button.dataset.command;
                        const editor = button.closest('.editor-container, .diagnostico-container').querySelector('.editor-content');
                        if (command && editor) {
                            formatDoc(editor.id, command);
                        }
                    }
                });

                toolbar.addEventListener('change', (e) => {
                    const select = e.target.closest('.format-select');
                    if (select) {
                        const command = select.dataset.command;
                        const editor = select.closest('.editor-container, .diagnostico-container').querySelector('.editor-content');
                        if (command && editor && select.value) {
                            formatDoc(editor.id, command, select.value);
                            select.value = ''; // Reset select
                        }
                    }
                });
            });
        });
         // --- SEARCH BOT LOGIC ---
            const fab = document.getElementById('search-bot-fab');
            const modal = document.getElementById('search-modal');
            const closeModalBtn = document.getElementById('search-modal-close');
            const searchInput = document.getElementById('search-modal-input');
            const searchResults = document.getElementById('search-modal-results');

            fab.addEventListener('click', () => {
                modal.style.display = 'block';
                searchInput.value = '';
                searchResults.innerHTML = '<p>Escriba para buscar...</p>';
                searchInput.focus();
            });

            closeModalBtn.addEventListener('click', () => {
                modal.style.display = 'none';
            });

            window.addEventListener('click', (event) => {
                if (event.target == modal) {
                    modal.style.display = 'none';
                }
            });

            let searchTimeout;
            searchInput.addEventListener('input', () => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(async () => {
                    const query = searchInput.value;
                    if (query.length < 2) {
                        searchResults.innerHTML = '<p>Escriba al menos 2 caracteres...</p>';
                        return;
                    }

                    try {
                        const response = await fetch(`http://localhost:3000/api/search?q=${query}`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        const results = await response.json();
                        
                        searchResults.innerHTML = '';
                        const patients = results.filter(r => r.type === 'patient');
                        if (patients.length > 0) {
                            patients.forEach(patient => {
                                const item = document.createElement('div');
                                item.classList.add('search-result-item');
                                item.dataset.id = patient.id;
                                item.innerHTML = `
                                    <i class="fas fa-user-injured"></i>
                                    <div>
                                        <strong>${patient.last_name}, ${patient.first_name}</strong><br>
                                        <small>Clínica: ${patient.clinic || 'N/A'} | Código: ${patient.attention_code}</small>
                                    </div>
                                `;
                                item.addEventListener('click', () => {
                                    showPatientDetails(patient.id);
                                    modal.style.display = 'none';
                                });
                                searchResults.appendChild(item);
                            });
                        } else {
                            searchResults.innerHTML = '<p>No se encontraron pacientes.</p>';
                        }
                    } catch (error) {
                        console.error('Error en la búsqueda:', error);
                        searchResults.innerHTML = '<p>Error al realizar la búsqueda.</p>';
                    }
                }, 300);
            });
    </script>
      <!-- Search Bot FAB -->
    <div id="search-bot-fab" title="Buscar Paciente">
        <i class="fas fa-search"></i>
    </div>
    <!-- Search Bot Modal -->
    <div id="search-modal" class="search-modal">
        <div class="search-modal-content">
            <div class="search-modal-header">
                <h2>Buscar Paciente o Clínica</h2>
                <button class="search-modal-close" id="search-modal-close">&times;</button>
            </div>
            <input type="text" id="search-modal-input" placeholder="Escriba un nombre, código o clínica...">
            <div id="search-modal-results">
                 <p>Escriba para buscar...</p>
            </div>
        </div>
    </div>
</body>
</html>
