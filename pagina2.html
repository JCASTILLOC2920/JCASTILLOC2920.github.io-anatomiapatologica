<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JC PATH LAB | Sistema de Gesti√≥n</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Dexie.js for IndexedDB wrapper -->
    <script src="https://unpkg.com/dexie@3.2.2/dist/dexie.js"></script>
    <style>
        /* ESTILOS ORIGINALES (sin cambios) */
        :root {
            --primary: #1e88e5;
            --primary-dark: #0d47a1;
            --secondary: #ff9800;
            --secondary-dark: #f57c00;
            --text: #333;
            --text-light: #666;
            --bg: #f0f2f5;
            --sidebar-bg: #2c3e50;
            --sidebar-hover: #34495e;
            --card-bg: #ffffff;
            --border: #e0e0e0;
            --success: #4caf50;
            --error: #e53935;
            --table-header: #e3f2fd;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        /* Animaciones sutiles */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideInLeft {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        
        .animated-fadeIn {
            animation: fadeIn 0.5s ease-out;
        }
        
        .animated-slideInLeft {
            animation: slideInLeft 0.5s ease-out;
        }
        
        .animated-slideInRight {
            animation: slideInRight 0.5s ease-out;
        }
        
        .animated-pulse:hover {
            animation: pulse 0.3s ease-in-out;
        }
        
        /* Aplicar animaciones a elementos clave */
        .card {
            transition: all 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }
        
        .btn {
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .menu-item {
            transition: all 0.2s ease;
        }
        
        .menu-item:hover {
            transform: translateX(5px);
        }
        
        body {
            background-color: var(--bg);
            color: var(--text);
            display: flex;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .sidebar {
            width: 260px;
            background: var(--sidebar-bg);
            color: white;
            height: 100vh;
            position: fixed;
            transition: all 0.3s ease;
            z-index: 100;
            overflow-y: auto;
        }
        
        .logo {
            padding: 25px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo i {
            font-size: 28px;
            color: var(--secondary);
        }
        
        .logo-text {
            display: flex;
            flex-direction: column;
        }
        
        .logo-title {
            font-size: 20px;
            font-weight: 600;
        }
        
        .logo-subtitle {
            font-size: 12px;
            opacity: 0.8;
        }
        
        .menu {
            padding: 20px 0;
        }
        
        .menu-item {
            padding: 14px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 4px solid transparent;
        }
        
        .menu-item:hover, .menu-item.active {
            background: var(--sidebar-hover);
            border-left: 4px solid var(--secondary);
        }
        
        .menu-item i {
            width: 24px;
            text-align: center;
            font-size: 18px;
        }
        
        .sidebar-footer {
            padding: 20px;
            text-align: center;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            margin-top: auto;
            position: absolute;
            bottom: 0;
            width: 100%;
            font-size: 12px;
            opacity: 0.7;
        }
        
        .main-content {
            flex: 1;
            margin-left: 260px;
            transition: all 0.3s ease;
            min-height: 100vh;
        }
        
        .topbar {
            background: var(--card-bg);
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            position: sticky;
            top: 0;
            z-index: 50;
        }
        
        .topbar-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .menu-toggle {
            display: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text);
        }
        
        .page-title {
            font-size: 24px;
            font-weight: 600;
            color: var(--primary-dark);
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .user-name {
            font-weight: 500;
        }
        
        .content {
            padding: 30px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        /* üñ•Ô∏è MEJORAS PARA PANTALLAS GRANDES Y PEQUE√ëAS */
        
        /* Pantallas muy grandes (4K, Ultrawide) */
        @media (min-width: 1920px) {
            .container {
                max-width: 1600px;
                padding: 0 40px;
            }
            
            .content {
                padding: 40px;
            }
            
            .card {
                margin-bottom: 30px;
            }
            
            .section {
                padding: 30px;
            }
            
            input, select, textarea {
                padding: 15px;
                font-size: 1.1rem;
            }
            
            .btn {
                padding: 15px 25px;
                font-size: 1.1rem;
            }
            
            .data-grid {
                gap: 25px;
            }
        }
        
        /* Pantallas grandes (Escritorio grande) */
        @media (min-width: 1400px) and (max-width: 1919px) {
            .container {
                max-width: 1400px;
                padding: 0 30px;
            }
            
            .content {
                padding: 35px;
            }
            
            .data-grid {
                gap: 20px;
            }
        }
        
        /* Pantallas medianas-grandes (Laptop grande) */
        @media (min-width: 1200px) and (max-width: 1399px) {
            .container {
                max-width: 1200px;
                padding: 0 25px;
            }
        }
        
        /* Pantallas medianas (Laptop est√°ndar) */
        @media (min-width: 992px) and (max-width: 1199px) {
            .container {
                max-width: 100%;
                padding: 0 20px;
            }
            
            .content {
                padding: 25px;
            }
            
            .data-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
        }
        
        /* Tablets */
        @media (min-width: 769px) and (max-width: 991px) {
            .container {
                max-width: 100%;
                padding: 0 15px;
            }
            
            .content {
                padding: 20px;
            }
            
            .input-group {
                gap: 15px;
            }
            
            .data-grid {
                grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            }
        }
        
        .card {
            background: var(--card-bg);
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        .card-header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .card-header h1 {
            font-size: 1.8rem;
            margin: 0;
        }
        
        .section {
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }
        
        .section-title {
            font-size: 1.2rem;
            color: var(--primary-dark);
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--border);
            font-weight: 600;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--text-light);
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 2px rgba(30, 136, 229, 0.2);
        }
        
        .input-group {
            display: flex;
            gap: 10px;
        }
        
        .input-group .form-group {
            flex: 1;
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #1976d2, #0d47a1);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .btn-outline {
            background: transparent;
            border: 2px solid var(--error);
            color: var(--error);
        }
        
        .btn-outline:hover {
            background: var(--error);
            color: white;
            transform: translateY(-2px);
        }
        
        .btn i {
            margin-right: 8px;
        }
        
        .buttons {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            padding: 20px;
        }
        
        .file-upload {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 25px;
            text-align: center;
            background-color: #f9f9f9;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .file-upload:hover {
            border-color: var(--primary);
            background-color: #f0f7ff;
        }
        
        .file-upload i {
            font-size: 2rem;
            color: var(--primary);
            margin-bottom: 10px;
        }
        
        .file-text {
            color: #777;
            font-size: 0.9rem;
        }
        
        .date-box {
            background: linear-gradient(135deg, var(--secondary), var(--secondary-dark));
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin: 15px 0;
        }
        
        .date-label {
            font-size: 0.9rem;
            margin-bottom: 5px;
        }
        
        .date-value {
            font-size: 1.3rem;
            font-weight: bold;
        }
        
        .attention-group {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        
        .attention-group .form-group {
            flex: 1;
        }
        
        .attention-group .btn {
            height: fit-content;
            margin-bottom: 15px;
        }
        
        .confirmation-message {
            background-color: #dff0d8;
            border: 1px solid #d6e9c6;
            border-radius: 4px;
            color: #3c763d;
            padding: 15px;
            margin-bottom: 15px;
            display: none;
        }
        
        .confirmation-message.duplicate {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
            display: none;
        }
        
        .filters {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            padding: 20px;
            background-color: #f9f9f9;
            border-bottom: 1px solid var(--border);
        }
        
        .filter-group {
            flex: 1;
            min-width: 200px;
        }
        
        .filter-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--text-light);
        }
        
        .filter-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 1rem;
        }
        
        .search-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            align-self: flex-end;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .search-btn:hover {
            background: linear-gradient(135deg, #1976d2, #0d47a1);
        }
        
        .results-container {
            overflow-x: auto;
            padding: 20px;
        }
        
        .results-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1000px;
        }
        
        .results-table th {
            background-color: var(--table-header);
            text-align: left;
            padding: 15px;
            font-weight: 600;
            color: var(--primary-dark);
            border-bottom: 2px solid var(--primary);
            border-right: 1px solid #d1d1d1;
        }
        
        .results-table th:last-child {
            border-right: none;
        }
        
        .results-table td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border);
            border-right: 1px solid #eaeaea;
        }
        
        .results-table td:last-child {
            border-right: none;
        }
        
        .results-table tr:hover {
            background-color: #f5f9ff;
        }
        
        .action-btn {
            background: transparent;
            border: none;
            color: var(--primary);
            cursor: pointer;
            font-size: 1.1rem;
            margin: 0 5px;
            transition: all 0.3s;
        }
        
        .action-btn:hover {
            color: var(--primary-dark);
            transform: scale(1.1);
        }
        
        .informe-btn {
            background: var(--success);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .informe-btn:hover {
            background: #388e3c;
            transform: translateY(-2px);
        }

        .delete-btn {
            background: #fbe9e7;
            color: #e53935;
            border: none;
            border-radius: 4px;
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
        }
        
        .delete-btn:hover {
            background: #ffcdd2;
            transform: scale(1.1);
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            padding: 20px;
            gap: 10px;
        }
        
        .page-btn {
            padding: 8px 15px;
            background: #f0f0f0;
            border: 1px solid var(--border);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .page-btn.active, .page-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .page-content {
            display: none;
        }
        
        .page-content.active {
            display: block;
        }
        
        /* Nuevo estilo para bot√≥n de agregar plantilla */
        .add-template-btn {
            background: linear-gradient(135deg, var(--success), #2e7d32);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .add-template-btn:hover {
            background: linear-gradient(135deg, #43a047, #1b5e20);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        /* Nuevos estilos para bot√≥n Firmar */
        .btn-sign {
            background: linear-gradient(135deg, #4caf50, #2e7d32);
            color: white;
        }
        
        .btn-sign:hover {
            background: linear-gradient(135deg, #388e3c, #1b5e20);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        /* Nuevos estilos para bot√≥n Guardar */
        .btn-save {
            background: linear-gradient(135deg, #2196F3, #0d47a1);
            color: white;
        }
        
        .btn-save:hover {
            background: linear-gradient(135deg, #1976d2, #0b3d91);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        /* Estilos para la nueva p√°gina de informe */
        .data-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .data-header {
            background: linear-gradient(135deg, #f0f0f0, #e0e0e0);
            padding: 15px;
            font-weight: 600;
            color: var(--primary-dark);
            border-bottom: 1px solid var(--border);
        }
        
        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            padding: 20px;
        }
        
        .data-item {
            display: flex;
            flex-direction: column;
        }
        
        .data-label {
            font-size: 0.85rem;
            color: var(--text-light);
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .data-value {
            font-size: 1rem;
            font-weight: 500;
            padding: 8px;
            background: #f9f9f9;
            border-radius: 4px;
            border: 1px solid #eee;
        }

        /* Campos editables en informe */
        .editable-field {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #fff;
            font-family: inherit;
            font-size: 1rem;
            box-sizing: border-box;
        }
        
        .editable-field:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 2px rgba(30, 136, 229, 0.2);
        }
        
        .double-column {
            grid-column: span 2;
        }
        
        .doctor-section {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .doctor-info {
            flex: 1;
            margin-right: 20px;
            min-width: 250px;
        }
        
        .delivery-info {
            flex: 1;
            min-width: 250px;
        }
        
        /* NUEVOS ESTILOS PARA EL PANEL DE DESCRIPCIONES */
        .description-container {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .description-section {
            flex: 1;
            min-width: 300px;
            background: #f9f9f9;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            padding: 15px;
        }
        
        .description-section h3 {
            font-size: 1.1rem;
            color: var(--primary-dark);
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #ddd;
        }
        
        .editor-container {
            border: 1px solid #ddd;
            border-radius: 6px;
            margin-bottom: 15px;
            overflow: hidden;
        }
        
        .editor-toolbar {
            background: #f0f0f0;
            padding: 8px;
            border-bottom: 1px solid #ddd;
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        
        .editor-toolbar button {
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 5px 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .editor-toolbar button:hover {
            background: #e9f7ff;
            border-color: #1e88e5;
        }
        
        .format-select {
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 5px 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.85rem;
            min-width: 80px;
            max-width: 100px;
        }
        
        .format-select:hover {
            background: #e9f7ff;
            border-color: #1e88e5;
        }
        
        .format-select:focus {
            border-color: #1e88e5;
            outline: none;
            box-shadow: 0 0 0 2px rgba(30, 136, 229, 0.2);
        }
        
        .editor-content {
            min-height: 150px;
            padding: 12px;
            background: white;
            outline: none;
        }
        
        /* ESTILOS PARA EL NUEVO CUADRO DE DIAGN√ìSTICO */
        .diagnostico-section {
            width: 100%;
            background: #f9f9f9;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            padding: 15px;
            margin-top: 20px;
        }
        
        .diagnostico-section h3 {
            font-size: 1.1rem;
            color: var(--primary-dark);
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #ddd;
        }
        
        .diagnostico-container {
            border: 1px solid #ddd;
            border-radius: 6px;
            overflow: hidden;
        }
        
        /* ESTILOS PARA LAS FOTOS */
        .photos-section {
            margin-top: 20px;
        }
        
        .photos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 15px;
}
        
        .photo-upload {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 30px 20px;
            text-align: center;
            background-color: #f9f9f9;
            cursor: pointer;
            transition: all 0.3s;
            height: 250px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .photo-upload:hover {
            border-color: var(--primary);
            background-color: #f0f7ff;
        }
        
        .photo-upload i {
            font-size: 3rem;
            color: var(--primary);
            margin-bottom: 15px;
        }
        
        .photo-preview {
            max-width: 100%;
            max-height: 200px;
            display: none;
            border-radius: 6px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        
        .photo-text {
            color: #777;
            font-size: 0.9rem;
            margin-top: 5px;
        }
        
        .photo-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }
        
        .photo-btn {
            padding: 4px 8px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 4px;
            min-width: 60px;
            justify-content: center;
        }
        
        .photo-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }
        
        .photo-btn i {
            font-size: 0.7rem;
        }
        
        /* üì± RESPONSIVE DESIGN MEJORADO PARA TODOS LOS DISPOSITIVOS */
        
        /* Mejoras para dispositivos t√°ctiles */
        @media (hover: none) and (pointer: coarse) {
            .btn, .action-btn, .menu-item {
                min-height: 44px; /* Tama√±o m√≠nimo recomendado para touch */
                padding: 12px 16px;
            }
            
            .results-table td {
                padding: 16px 12px;
            }
        }
        
        /* Tablets grandes y pantallas medianas */
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
                z-index: 1000;
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
                width: 100%;
            }
            
            .menu-toggle {
                display: block;
            }
            
            .container {
                padding: 0 20px;
            }
            
            .data-grid {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            }
        }
        
        /* Tablets y pantallas medianas */
        @media (max-width: 860px) {
            .topbar {
                padding: 15px 20px;
            }
            
            .page-title {
                font-size: 20px;
            }
            
            .results-table {
                min-width: 800px;
            }
            
            .card-header h1 {
                font-size: 1.6rem;
            }
            
            .section {
                padding: 15px;
            }
        }
        
        /* M√≥viles y tablets peque√±as */
        @media (max-width: 768px) {
            .input-group {
                flex-direction: column;
                gap: 15px;
            }
            
            .attention-group {
                flex-direction: column;
                gap: 15px;
            }
            
            .attention-group .btn {
                margin-bottom: 0;
                width: 100%;
            }
            
            .buttons {
                flex-direction: column;
                gap: 10px;
            }
            
            .btn {
                width: 100%;
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .sidebar {
                transform: translateX(-100%);
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .sidebar.active + .main-content {
                margin-left: 0;
            }
            
            .filters {
                flex-direction: column;
                padding: 15px;
            }
            
            .filter-group {
                min-width: 100%;
            }
            
            .results-table {
                min-width: 800px;
                font-size: 0.9rem;
            }
            
            .data-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .double-column {
                grid-column: span 1;
            }
            
            .doctor-section {
                flex-direction: column;
            }
            
            .doctor-info {
                margin-right: 0;
                margin-bottom: 20px;
            }
            
            .description-container {
                flex-direction: column;
                gap: 15px;
            }
            
            .diagnostico-section {
                margin-top: 15px;
            }
            
            .photos-grid {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 0 10px;
            }
        }
        
        /* M√≥viles peque√±os */
        @media (max-width: 480px) {
            .card-header h1 {
                font-size: 1.5rem;
            }
            
            .section {
                padding: 15px;
            }
            
            .topbar {
                padding: 15px;
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .content {
                padding: 15px;
            }
            
            .page-title {
                font-size: 20px;
            }
            
            .results-table th, 
            .results-table td {
                padding: 8px 10px;
                font-size: 0.85rem;
            }
            
            .user-info {
                align-self: flex-end;
            }
            
            .editor-toolbar {
                gap: 3px;
                flex-wrap: wrap;
            }
            
            .editor-toolbar button {
                padding: 4px 6px;
                font-size: 0.8rem;
            }
            
            .format-select {
                padding: 3px 5px;
                font-size: 0.75rem;
                min-width: 60px;
                max-width: 80px;
            }
            
            .photo-btn {
                padding: 4px 8px;
                font-size: 0.75rem;
                min-width: 60px;
                justify-content: center;
            }
            
            .photo-btn i {
                font-size: 0.65rem;
            }
            
            .diagnostico-section {
                padding: 10px;
            }
            
            .photo-upload {
                padding: 20px 15px;
                height: 200px;
            }
            
            .photo-upload i {
                font-size: 2rem;
            }
            
            input, select, textarea {
                padding: 10px;
                font-size: 0.9rem;
            }
            
            .btn {
                padding: 10px 15px;
                font-size: 0.9rem;
            }
            
            .container {
                padding: 0 5px;
            }
        }
        
        /* M√≥viles muy peque√±os */
        @media (max-width: 320px) {
            .card-header h1 {
                font-size: 1.3rem;
            }
            
            .page-title {
                font-size: 18px;
            }
            
            .section {
                padding: 10px;
            }
            
            .content {
                padding: 10px;
            }
            
            .topbar {
                padding: 10px;
            }
            
            .results-table {
                font-size: 0.8rem;
            }
            
            .photo-upload {
                height: 150px;
                padding: 15px 10px;
            }
        }

        /* Altura constante para filas - MODIFICADO A 30px */
        #medicos-results-table tbody tr,
        #surgical-results-table tbody tr,
        #cytological-results-table tbody tr {
            height: 30px;
            display: table-row;
        }

        #medicos-results-table tbody td,
        #surgical-results-table tbody td,
        #cytological-results-table tbody td {
            max-height: 30px;
            overflow-y: auto;
            word-break: break-word;
        }
        
        /* Nuevos estilos para bot√≥n modificar */
        .modify-btn {
            background: #e3f2fd;
            color: #0d47a1;
            border: none;
            border-radius: 4px;
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
        }
        
        .modify-btn:hover {
            background: #bbdefb;
            transform: scale(1.1);
        }
        
        .update-btn {
            background: linear-gradient(135deg, #ff9800, #f57c00);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            align-self: flex-end;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .update-btn:hover {
            background: linear-gradient(135deg, #f57c00, #e65100);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        /* Estilos para la nueva p√°gina de plantillas */
        .template-form {
            padding: 20px;
            background: white;
        }
        
        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .form-row .form-group {
            flex: 1;
        }
        
        .editor-large {
            min-height: 300px;
        }
        
        .editor-toolbar-large {
            padding: 10px;
        }
        
        .editor-toolbar-large button {
            padding: 8px 12px;
            font-size: 1rem;
        }
        
        .editor-toolbar-large i {
            margin-right: 5px;
        }
        
        .template-actions {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 20px;
        }
        
        /* Nuevos estilos para di√°logo de confirmaci√≥n */
        .confirmation-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .confirmation-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            max-width: 400px;
            width: 90%;
        }
        
        .confirmation-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        
        /* ESTILOS PARA EL NUEVO INFORME PRELIMINAR */
        .preliminary-report {
            padding: 30px;
            background: white;
            font-family: 'Times New Roman', serif;
            color: #333;
            line-height: 1.6;
            max-width: 1044px; /* Ajustado para la imagen */
            margin: 0 auto;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-radius: 8px;
        }
        
        .report-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
        }
        
        /* Nuevo estilo para la imagen del encabezado */
        .report-header img {
            width: 100%;
            max-width: 1044px;
            height: auto;
            display: block;
            margin: 0 auto;
        }
        
        .patient-info {
            margin-bottom: 25px;
            font-family: Arial;
        }
        
        .patient-info h3 {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 10px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
        }
        
        .patient-details {
            display: flex;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }
        
        .patient-detail {
            flex: 1;
            min-width: 200px;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }
        
        .dates-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        
        .report-section {
            margin-bottom: 25px;
        }
        
        .report-section h3 {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #ddd;
        }
        
        .report-content {
            padding-left: 20px;
        }
        
        .diagnosis-section {
            margin-top: 30px;
            font-weight: bold;
        }
        
        .diagnosis-title {
            font-size: 1.2rem;
            text-align: center;
            margin-bottom: 15px;
        }
        
        .signature-section {
            margin-top: 50px;
            text-align: center;
        }
        
        .signature-line {
            display: inline-block;
            width: 250px;
            border-top: 1px solid #333;
            margin-top: 40px;
        }
        
        .signature-info {
            margin-top: 10px;
            font-size: 0.9rem;
        }
        
        /* Estilo para resaltar el bot√≥n de informe preliminar */
        #preliminary-btn {
            background: linear-gradient(135deg, #9c27b0, #673ab7);
        }
        
        #preliminary-btn:hover {
            background: linear-gradient(135deg, #7b1fa2, #512da8);
        }

        /* Estilos para la imagen de firma */
        .signature-image {
            width: 211px;
            height: 114px;
            display: block;
            margin: 0 auto;
        }

        /* Nuevos estilos para las l√≠neas decorativas */
        .decorative-line {
            width: 100%;
            max-width: 1031px;
            height: 7px;
            display: block;
            margin: 10px 0;
        }

        .page-footer {
            text-align: center;
            margin-top: 20px;
        }
        
        .footer-image {
            max-width: 100%;
            height: auto;
            max-height: 17px;
            display: block;
            margin: 0 auto;
        }
        
        /* NUEVOS ESTILOS ESPEC√çFICOS PARA EL INFORME PRELIMINAR */
        #informe-preliminar .preliminary-report {
            font-family: Arial;
            font-size: 10pt;
            text-align: justify;
        }
        
        #informe-preliminar .patient-detail strong,
        #informe-preliminar .dates-info strong,
        #informe-preliminar .report-section h3,
        #informe-preliminar .diagnosis-title {
            font-weight: bold;
            text-transform: uppercase;
        }
        
        #informe-preliminar .patient-detail,
        #informe-preliminar .dates-info div {
            text-transform: uppercase;
        }
        
        #informe-preliminar .diagnosis-title {
            text-align: left;
            font-size: 0.6rem; /* Diagn√≥stico reducido a la mitad */
        }
        
        #informe-preliminar .footer-image {
            width: 1044px;
            max-width: 100%;
            height: 24px;
            display: block;
            margin: 0 auto;
        }
        
        /* NUEVOS ESTILOS PARA LA TABLA DE DATOS DEL PACIENTE */
        .patient-data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        
        .patient-data-table td {
            padding: 4px; /* Padding reducido para ahorrar espacio */
            border: 1px solid #ddd;
            vertical-align: top;
            font-size: 9pt; /* Tama√±o reducido */
            line-height: 1.2; /* Espaciado reducido */
        }
        
        .patient-data-table .codigo-cell {
            font-size: 2.5em; /* 3 veces el tama√±o normal */
            font-weight: bold;
            text-align: center;
            vertical-align: middle;
            background-color: #f0f7ff;
            padding: 2px 4px; /* Padding reducido */
        }
        
        .patient-data-table .info-cell {
            padding: 4px; /* Padding reducido */
        }
        
        /* Reducci√≥n de tama√±o para t√≠tulos */
        #preliminary-report-content h3 {
            font-size: 0.6rem;
        }
        
        /* Estilos para el pie de p√°gina del informe */
        .report-footer {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-family: Arial;
            width: 100%;
        }
        
        .footer-left {
            font-size: 9pt; /* Tama√±o solicitado */
            text-align: left;
        }
        
        .footer-right {
            font-size: 8pt; /* Tama√±o solicitado */
            text-align: right;
        }
        
        .footer-right span {
            margin-left: 10px;
        }
        
        /* Alineaci√≥n de la firma a la derecha */
        #preliminary-report-content .signature-section {
            text-align: right;
        }

        /* Eliminar l√≠nea inferior derecha */
        #preliminary-report-content .signature-line {
            display: none; /* L√≠nea eliminada */
        }
        
        /* Estilos para select en informe */
        .editable-select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #fff;
            font-family: inherit;
            font-size: 1rem;
            box-sizing: border-box;
        }
        
        .editable-select:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 2px rgba(30, 136, 229, 0.2);
        }

        /* Estilos para iframe de plantillas */
        .plantillas-iframe {
            width: 100%;
            height: calc(100vh - 150px);
            border: none;
            border-radius: 10px;
        }

        /* Estilos para el modal de recorte de foto MEJORADO */
        .crop-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        
        .crop-content {
            background-color: white;
            padding: 30px;
            border-radius: 15px;
            width: 95%;
            max-width: 900px;
            max-height: 95vh;
            overflow: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .crop-title {
            text-align: center;
            color: var(--primary-dark);
            margin-bottom: 10px;
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .crop-area {
            width: 100%;
            height: 500px;
            background: linear-gradient(45deg, #f0f0f0 25%, transparent 25%), 
                       linear-gradient(-45deg, #f0f0f0 25%, transparent 25%), 
                       linear-gradient(45deg, transparent 75%, #f0f0f0 75%), 
                       linear-gradient(-45deg, transparent 75%, #f0f0f0 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            margin: 20px 0;
            position: relative;
            overflow: hidden;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
        }
        
        .crop-preview {
            max-width: 100%;
            max-height: 100%;
            display: block;
            margin: 0 auto;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        .crop-box {
            position: absolute;
            border: 3px solid var(--primary);
            background-color: rgba(30, 136, 229, 0.1);
            box-sizing: border-box;
            cursor: move;
            min-width: 50px;
            min-height: 50px;
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.8);
        }
        
        .crop-box:hover {
            border-color: var(--secondary);
            background-color: rgba(255, 152, 0, 0.1);
        }
        
        .crop-handle {
            position: absolute;
            width: 15px;
            height: 15px;
            background-color: var(--primary);
            border: 2px solid white;
            border-radius: 50%;
            bottom: -8px;
            right: -8px;
            cursor: nwse-resize;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }
        
        .crop-handle:hover {
            background-color: var(--secondary);
            transform: scale(1.2);
        }
        
        .crop-info {
            margin: 15px 0;
            font-size: 15px;
            color: #666;
            text-align: center;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            border-left: 4px solid var(--primary);
        }
        
        .crop-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 15px 0;
        }
        
        .crop-control-btn {
            padding: 8px 15px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .crop-control-btn:hover {
            background: #e9ecef;
        }
        
        .crop-control-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .crop-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 25px;
        }
        
        .crop-buttons .btn {
            padding: 12px 25px;
            font-size: 16px;
            min-width: 120px;
        }
        
        /* Estilos para modal de registro de m√©dicos */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            margin: 0;
            color: var(--primary-dark);
            font-size: 1.4rem;
        }
        
        .modal-close {
            font-size: 28px;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
            transition: color 0.3s;
        }
        
        .modal-close:hover {
            color: #000;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .modal-footer {
            padding: 20px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
    </style>
</head>
<body>
    <!-- Men√∫ lateral (sin cambios) -->
    <aside class="sidebar">
        <div class="logo">
            <i class="fas fa-flask"></i>
            <div class="logo-text">
                <span class="logo-title">JC PATH LAB</span>
                <span class="logo-subtitle">LABORATORIO DE ANATOMIA PATOLOGICA</span>
            </div>
        </div>
        
        <div class="menu">
            <div class="menu-item active" data-link="registro-pacientes">
                <i class="fas fa-user-injured"></i>
                <span class="menu-text">Registro de pacientes</span>
            </div>
            <div class="menu-item" data-link="registro-medicos">
                <i class="fas fa-user-md"></i>
                <span class="menu-text">Registro de m√©dicos</span>
            </div>
            <div class="menu-item" data-link="resultados-quirurgicos">
                <i class="fas fa-clipboard-list"></i>
                <span class="menu-text">Lista de resultados quir√∫rgicos</span>
            </div>
            <div class="menu-item" data-link="resultados-citologicos">
                <i class="fas fa-microscope"></i>
                <span class="menu-text">Lista de resultados citol√≥gicos</span>
            </div>
            <div class="menu-item" data-link="plantillas">
                <i class="fas fa-file-alt"></i>
                <span class="menu-text">Plantillas</span>
            </div>
        </div>
        
        <div class="sidebar-footer">
            <p>Propietario:</p>
            <p>Dr. Joseph Christopher Castillo Cuenca</p>
        </div>
    </aside>
    
    <!-- Contenido principal -->
    <div class="main-content">
        <div class="topbar">
            <div class="topbar-left">
                <div class="menu-toggle">
                    <i class="fas fa-bars"></i>
                </div>
                <div class="page-title" id="page-title">Registro de Pacientes</div>
            </div>
            <div class="user-info">
                <div class="user-avatar">JC</div>
                <div class="user-name">Dr. Castillo</div>
            </div>
        </div>
        
        <div class="content">
            <!-- P√°gina de registro de pacientes -->
            <div id="registro-pacientes" class="page-content active">
                <div class="container">
                    <div class="card">
                        <div class="card-header">
                            <h1>REGISTRO PACIENTE</h1>
                        </div>
                        
                        <div class="confirmation-message" id="confirmation-message">
                            <i class="fas fa-check-circle"></i> Datos guardados correctamente
                        </div>
                        
                        <div class="confirmation-message duplicate" id="duplicate-message">
                            <i class="fas fa-exclamation-triangle"></i> C√≥digo duplicado, por favor ingrene otro c√≥digo
                        </div>
                        
                        <div class="section">
                            <div class="section-title">Tipo Servicio</div>
                            <div class="input-group">
                                <div class="form-group">
                                    <label for="service-type">TIPO DE SERVICIO</label>
                                    <select id="service-type">
                                        <option value="">Seleccione un servicio</option>
                                        <option value="hematoxilina">ESTUDIO CON HEMATOXILINA EOSINA</option>
                                        <option value="citologia">ESTUDIO DE CITOLOGIA</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="section">
                            <div class="section-title">Datos del Paciente</div>
                            
                            <div class="attention-group">
                                <div class="form-group">
                                    <label for="attention-code">Cod. Atenci√≥n</label>
                                    <input type="text" id="attention-code">
                                </div>
                                <button class="btn btn-primary" id="validate-btn">
                                    <i class="fas fa-check-circle"></i> Validar
                                </button>
                            </div>
                            
                            <div class="input-group">
                                <div class="form-group">
                                    <label for="dni">DNI</label>
                                    <input type="text" id="dni">
                                </div>
                                
                                <div class="form-group">
                                    <label for="age">Edad</label>
                                    <input type="number" id="age">
                                </div>
                            </div>
                            
                            <div class="input-group">
                                <div class="form-group">
                                    <label for="last-name">APELLIDOS</label>
                                    <input type="text" id="last-name">
                                </div>
                                
                                <div class="form-group">
                                    <label for="first-name">NOMBRES</label>
                                    <input type="text" id="first-name">
                                </div>
                            </div>
                            
                            <div class="input-group">
                                <div class="form-group">
                                    <label for="phone">Tel√©fono</label>
                                    <input type="text" id="phone">
                                </div>
                                
                                <div class="form-group">
                                    <label for="gender">Sexo</label>
                                    <input type="text" id="gender" list="gender-options">
                                    <datalist id="gender-options">
                                        <option value="Masculino">
                                        <option value="Femenino">
                                    </datalist>
                                </div>
                            </div>
                            
                            <div class="input-group">
                                <div class="form-group">
                                    <label for="contact-date">Familiar de Contacto</label>
                                    <input type="text" id="contact-date">
                                </div>
                                
                                <div class="form-group">
                                    <label for="contact-phone">Tel√©fono de Contacto</label>
                                    <input type="text" id="contact-phone">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="requesting-doctor">Med. Solicitante</label>
                                <div class="combo-input-container">
                                    <input type="text" id="requesting-doctor" placeholder="Escribir o seleccionar m√©dico..." list="doctors-options">
                                    <datalist id="doctors-options">
                                        <!-- Las opciones se cargar√°n din√°micamente -->
                                    </datalist>
                                </div>
                                <button type="button" class="btn btn-secondary" id="register-doctor-now-btn" style="margin-top: 10px; font-size: 0.9rem; padding: 8px 16px;">
                                    <i class="fas fa-user-plus"></i> Registrar M√©dico Ahora
                                </button>
                            </div>
                            
                            <div class="form-group">
                                <label for="study-reason">Motivo Estudio</label>
                                <textarea id="study-reason" rows="3"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label for="clinic">Cl√≠nica donde proviene la muestra</label>
                                <input type="text" id="clinic">
                            </div>
                        </div>
                        
                        <div class="section">
                            <div class="section-title">Orden Servicio</div>
                            
                            <div class="file-upload" id="orden-servicio-upload">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <div class="file-text">Elegir archivos (JPG)</div>
                                <div class="file-text">Ning√∫n archivo seleccionado</div>
                            </div>
                        </div>
                        
                        <div class="date-box">
                            <div class="date-label">Fecha de Registro</div>
                            <div class="date-value" id="registration-date">04-08-2025</div>
                        </div>
                        
                        <div class="date-box">
                            <div class="date-label">Fec. Probable-Entrega</div>
                            <div class="date-value" id="delivery-date">06-08-2025</div>
                        </div>
                        
                        <div class="buttons">
                            <button class="btn btn-outline" id="exit-btn">
                                <i class="fas fa-door-open"></i> Salir
                            </button>
                            <button class="btn btn-primary" id="save-btn">
                                <i class="fas fa-save"></i> Guardar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- P√°gina de registro de m√©dicos -->
            <div id="registro-medicos" class="page-content">
                <div class="container">
                    <div class="card">
                        <div class="card-header">
                            <h1>REGISTRO DE M√âDICOS</h1>
                        </div>
                        
                        <div class="filters">
                            <div class="filter-group">
                                <label for="search-nombre-completo-med">Nombre del m√©dico</label>
                                <input type="text" id="search-nombre-completo-med" placeholder="Ej: DR. CARLOS GONZ√ÅLEZ P√âREZ" value="">
                            </div>
                            
                            <div class="filter-group">
                                <label for="search-especialidad-med">Especialidad</label>
                                <input type="text" id="search-especialidad-med" placeholder="Especialidad" value="">
                            </div>
                            
                            <div class="filter-group">
                                <label for="clinica-med">Cl√≠nica de procedencia</label>
                                <input type="text" id="clinica-med" placeholder="Cl√≠nica">
                            </div>
                            
                            <button class="search-btn" id="search-btn-med">
                                <i class="fas fa-search"></i> Buscar
                            </button>
                            
                            <button class="search-btn" id="register-btn-med" style="background: linear-gradient(135deg, var(--success), #2e7d32);">
                                <i class="fas fa-user-plus"></i> Registrar
                            </button>
                            
                            <button class="search-btn update-btn" id="update-btn-med" style="display: none;">
                                <i class="fas fa-sync-alt"></i> Actualizar
                            </button>
                            
                            <button class="search-btn" id="cancel-btn-med" style="background: linear-gradient(135deg, #f57c00, #e64a19); display: none;">
                                <i class="fas fa-times"></i> Cancelar
                            </button>
                        </div>
                        
                        <div class="results-container">
                            <table class="results-table" id="medicos-results-table">
                                <thead>
                                    <tr>
                                        <th>N¬∫</th>
                                        <th>NOMBRE DEL M√âDICO</th>
                                        <th>ESPECIALIDAD</th>
                                        <th>CLINICA DE PROCEDENCIA</th>
                                        <th>MODIFICAR</th>
                                        <th>ELIMINAR</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>1</td>
                                        <td>DR. CARLOS GONZ√ÅLEZ P√âREZ</td>
                                        <td>Patolog√≠a General</td>
                                        <td>Cl√≠nica Central</td>
                                        <td>
                                            <button class="modify-btn" title="Modificar m√©dico">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                        </td>
                                        <td>
                                            <button class="delete-btn" title="Eliminar m√©dico">
                                                <i class="fas fa-trash-alt"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>2</td>
                                        <td>DRA. MAR√çA L√ìPEZ MART√çNEZ</td>
                                        <td>Citolog√≠a</td>
                                        <td>Cl√≠nica Norte</td>
                                        <td>
                                            <button class="modify-btn" title="Modificar m√©dico">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                        </td>
                                        <td>
                                            <button class="delete-btn" title="Eliminar m√©dico">
                                                <i class="fas fa-trash-alt"></i>
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="pagination" id="pagination-med">
                            <button class="page-btn active">1</button>
                            <button class="page-btn">2</button>
                            <button class="page-btn">3</button>
                            <button class="page-btn">4</button>
                            <button class="page-btn">5</button>
                            <button class="page-btn">Siguiente</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- P√°gina de resultados quir√∫rgicos -->
            <div id="resultados-quirurgicos" class="page-content">
                <div class="container">
                    <div class="card">
                        <div class="card-header">
                            <h1>RESULTADOS QUIR√öRGICOS</h1>
                        </div>
                        
                        <div class="filters">
                            <div class="filter-group">
                                <label for="search-cod">C√≥digo de Atenci√≥n</label>
                                <input type="text" id="search-cod" placeholder="Ej: 25Q-402" value="">
                            </div>
                            
                            <div class="filter-group">
                                <label for="search-dni">DNI</label>
                                <input type="text" id="search-dni" placeholder="Ej: 42560314" value="">
                            </div>
                            
                            <div class="filter-group">
                                <label for="search-paciente">Paciente</label>
                                <input type="text" id="search-paciente" placeholder="Nombre del paciente" value="">
                            </div>
                            
                            <button class="search-btn" id="search-btn">
                                <i class="fas fa-search"></i> Buscar
                            </button>
                        </div>
                        
                        <div class="results-container">
                            <table class="results-table" id="surgical-results-table">
                                <thead>
                                    <tr>
                                        <th>N¬∫</th>
                                        <th>COD-ATENCI√ìN</th>
                                        <th>DNI</th>
                                        <th>EDAD</th>
                                        <th>APELLIDOS</th>
                                        <th>NOMBRES</th>
                                        <th>SEXO</th>
                                        <th>MED. SOLICITANTE</th>
                                        <th>CLINICA DE PROCEDENCIA</th>
                                        <th>FECHA DE REGISTRO</th>
                                        <th>FECHA DE INFORME</th>
                                        <th>INFORME</th>
                                        <th>ELIMINAR</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Los datos se cargar√°n din√°micamente -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="pagination" id="pagination">
                            <button class="page-btn active">1</button>
                            <button class="page-btn">2</button>
                            <button class="page-btn">3</button>
                            <button class="page-btn">4</button>
                            <button class="page-btn">5</button>
                            <button class="page-btn">Siguiente</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- P√°gina de resultados citol√≥gicos (REEMPLAZADO iframe por contenido directo) -->
            <div id="resultados-citologicos" class="page-content">
                <div class="container">
                    <div class="card">
                        <div class="card-header">
                            <h1>RESULTADOS CITOL√ìGICOS</h1>
                        </div>
                        
                        <div class="filters">
                            <div class="filter-group">
                                <label for="search-cod-cito">C√≥digo de Atenci√≥n</label>
                                <input type="text" id="search-cod-cito" placeholder="Ej: 25C-402" value="">
                            </div>
                            
                            <div class="filter-group">
                                <label for="search-dni-cito">DNI</label>
                                <input type="text" id="search-dni-cito" placeholder="Ej: 42560314" value="">
                            </div>
                            
                            <div class="filter-group">
                                <label for="search-paciente-cito">Paciente</label>
                                <input type="text" id="search-paciente-cito" placeholder="Nombre del paciente" value="">
                            </div>
                            
                            <button class="search-btn" id="search-btn-cito">
                                <i class="fas fa-search"></i> Buscar
                            </button>
                        </div>
                        
                        <div class="results-container">
                            <table class="results-table" id="cytological-results-table">
                                <thead>
                                    <tr>
                                        <th>N¬∫</th>
                                        <th>COD-ATENCI√ìN</th>
                                        <th>DNI</th>
                                        <th>EDAD</th>
                                        <th>APELLIDOS</th>
                                        <th>NOMBRES</th>
                                        <th>SEXO</th>
                                        <th>MED. SOLICITANTE</th>
                                        <th>CLINICA DE PROCEDENCIA</th>
                                        <th>FECHA DE REGISTRO</th>
                                        <th>FECHA DE INFORME</th>
                                        <th>INFORME</th>
                                        <th>ELIMINAR</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Los datos se cargar√°n din√°micamente -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="pagination" id="pagination-cito">
                            <button class="page-btn active">1</button>
                            <button class="page-btn">2</button>
                            <button class="page-btn">3</button>
                            <button class="page-btn">4</button>
                            <button class="page-btn">5</button>
                            <button class="page-btn">Siguiente</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- P√°gina de plantillas (MODIFICADA para cargar plantillas.html) -->
            <div id="plantillas" class="page-content">
                <div class="container">
                    <div class="card">
                        <div class="card-header">
                            <h1>PLANTILLAS</h1>
                        </div>
                        <iframe class="plantillas-iframe" src="plantillas.html"></iframe>
                    </div>
                </div>
            </div>
            
            <!-- P√°gina para ver el informe (MODIFICADA) -->
            <div id="ver-informe" class="page-content">
                <div class="container">
                    <div class="card">
                        <div class="card-header">
                            <h1>INFORME DE PATOLOG√çA</h1>
                        </div>
                        
                        <div class="section">
                            <div class="section-title">Datos del Servicio</div>
                            
                            <div class="data-card">
                                <div class="data-grid">
                                    <div class="data-item">
                                        <span class="data-label">Cod. Atenci√≥n</span>
                                        <div class="data-value" id="informe-cod-atencion">25Q-402</div>
                                    </div>
                                    <div class="data-item">
                                        <span class="data-label">DNI</span>
                                        <input type="text" class="editable-field" id="informe-dni" value="4:26/03:14">
                                    </div>
                                    <!-- CAMBIO 1: Sexo ahora es un select -->
                                    <div class="data-item">
                                        <span class="data-label">Sexo</span>
                                        <select class="editable-select" id="informe-sexo">
                                            <option value="masculino">MASCULINO</option>
                                            <option value="femenino">FEMENINO</option>
                                        </select>
                                    </div>
                                    
                                    <!-- Separar nombre en apellidos y nombres -->
                                    <div class="data-item">
                                        <span class="data-label">Apellidos</span>
                                        <input type="text" class="editable-field" id="informe-apellidos" value="VARGAS LOZANO">
                                    </div>
                                    <div class="data-item">
                                        <span class="data-label">Nombres</span>
                                        <input type="text" class="editable-field" id="informe-nombres" value="ROSA">
                                    </div>
                                    
                                    <div class="data-item">
                                        <span class="data-label">Edad</span>
                                        <input type="text" class="editable-field" id="informe-edad" value="40">
                                    </div>
                                    <div class="data-item">
                                        <span class="data-label">Tel√©fono</span>
                                        <input type="text" class="editable-field" id="informe-telefono" value="-">
                                    </div>
                                    <div class="data-item">
                                        <span class="data-label">F. Contacto</span>
                                        <input type="text" class="editable-field" id="informe-contacto" value="-">
                                    </div>
                                    <div class="data-item">
                                        <span class="data-label">Tel. Contacto</span>
                                        <input type="text" class="editable-field" id="informe-tel-contacto" value="-">
                                    </div>
                                    <!-- Nuevo campo: Cl√≠nica de donde proviene la muestra -->
                                    <div class="data-item">
                                        <span class="data-label">Cl√≠nica de donde proviene la muestra</span>
                                        <input type="text" class="editable-field" id="informe-clinica" value="-">
                                    </div>
                                    <!-- CAMBIO 2: Med. Solicitante ahora es a select -->
                                    <div class="data-item">
                                        <span class="data-label">Med. Solicitante</label>
                                        <select class="editable-select" id="informe-medico">
                                            <option value="">Seleccionar m√©dico</option>
                                            <!-- Los m√©dicos se cargar√°n din√°micamente -->
                                        </select>
                                    </div>
                                    <div class="data-item double-column">
                                        <span class="data-label">Motivo Estudio</span>
                                        <textarea class="editable-field" id="informe-motivo" rows="3">GRANULONA VULVAR</textarea>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="doctor-section">
                                <!-- Nuevo campo: Fecha de Registro -->
                                <div class="doctor-info">
                                    <div class="data-item">
                                        <span class="data-label">Fecha de Registro</span>
                                        <div class="data-value" id="fecha-registro">04-08-2025</div>
                                    </div>
                                </div>
                                
                                <div class="delivery-info">
                                    <div class="data-item">
                                        <span class="data-label">Fec. Probable Entrega</span>
                                        <div class="data-value" id="fecha-entrega">06-08-2025</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="section">
                            <div class="section-title">Descripci√≥n Macro y Microsc√≥pica</div>
                            
                            <div class="description-container">
                                <!-- Secci√≥n Macrosc√≥pica -->
                                <div class="description-section">
                                    <h3>Descripci√≥n Macrosc√≥pica</h3>
                                    
                                    <!-- MODIFICACI√ìN: Categor√≠a arriba de Plantilla -->
                                    <!-- NUEVO: CATEGOR√çA MACROSC√ìPICA -->
                                    <div class="form-group">
                                        <label for="categoria-macro">Categor√≠a</label>
                                        <select id="categoria-macro" class="template-select">
                                            <option value="">Seleccionar categor√≠a</option>
                                            <option value="1">Biopsia</option>
                                            <option value="2">Pieza quir√∫rgica</option>
                                            <option value="3">Otros</option>
                                        </select>
                                    </div>
                                    
                                    <!-- CUADRO DE PLANTILLA MACROSC√ìPICA -->
                                    <div class="form-group">
                                        <label for="plantilla-macro">Plantilla Macrosc√≥pica</label>
                                        <select id="plantilla-macro" class="template-select">
                                            <option value="">Seleccionar plantilla</option>
                                            <option value="1">Plantilla est√°ndar de biopsia</option>
                                            <option value="2">Plantilla de pieza quir√∫rgica</option>
                                            <option value="3">Plantilla de tumor</option>
                                        </select>
                                    </div>
                                    
                                    <div class="editor-container">
                                        <div class="editor-toolbar">
                                            <button type="button" class="format-btn" data-command="bold" title="Negrita">
                                                <i class="fas fa-bold"></i>
                                            </button>
                                            <button type="button" class="format-btn" data-command="italic" title="Cursiva">
                                                <i class="fas fa-italic"></i>
                                            </button>
                                            <button type="button" class="format-btn" data-command="underline" title="Subrayado">
                                                <i class="fas fa-underline"></i>
                                            </button>
                                            <button type="button" class="format-btn" data-command="insertUnorderedList" title="Lista">
                                                <i class="fas fa-list-ul"></i>
                                            </button>
                                            <button type="button" class="format-btn" data-command="insertOrderedList" title="Lista numerada">
                                                <i class="fas fa-list-ol"></i>
                                            </button>
                                            <button type="button" class="format-btn" data-command="justifyFull" title="Justificar">
                                                <i class="fas fa-align-justify"></i>
                                            </button>
                                            <select class="format-select" data-command="fontName" title="Tipo de letra">
                                                <option value="">Fuente</option>
                                                <option value="Arial">Arial</option>
                                                <option value="Times New Roman">Times New Roman</option>
                                                <option value="Helvetica">Helvetica</option>
                                                <option value="Georgia">Georgia</option>
                                                <option value="Verdana">Verdana</option>
                                            </select>
                                            <select class="format-select" data-command="fontSize" title="Tama√±o de letra">
                                                <option value="">Tama√±o</option>
                                                <option value="1">8pt</option>
                                                <option value="2">10pt</option>
                                                <option value="3">12pt</option>
                                                <option value="4">14pt</option>
                                                <option value="5">18pt</option>
                                                <option value="6">24pt</option>
                                                <option value="7">36pt</option>
                                            </select>
                                        </div>
                                        <!-- CAMBIO 4: Editor vac√≠o -->
                                        <div class="editor-content" id="macro-editor" contenteditable="true"></div>
                                    </div>
                                </div>
                                
                                <!-- Secci√≥n Microsc√≥pica -->
                                <div class="description-section">
                                    <h3>Descripci√≥n Microsc√≥pica</h3>
                                    
                                    <!-- MODIFICACI√ìN: Categor√≠a arriba de Plantilla -->
                                    <!-- NUEVO: CATEGOR√çA MICROSC√ìPICA -->
                                    <div class="form-group">
                                        <label for="categoria-micro">Categor√≠a</label>
                                        <select id="categoria-micro" class="template-select">
                                            <option value="">Seleccionar categor√≠a</option>
                                            <option value="1">Inflamaci√≥n</option>
                                            <option value="2">Neoplasia</option>
                                            <option value="3">Otros</option>
                                        </select>
                                    </div>
                                    
                                    <!-- CUADRO DE PLANTILLA MICROSC√ìPICA -->
                                    <div class="form-group">
                                        <label for="plantilla-micro">Plantilla Microsc√≥pica</label>
                                        <select id="plantilla-micro" class="template-select">
                                            <option value="">Seleccionar plantilla</option>
                                            <option value="1">Plantilla de inflamaci√≥n cr√≥nica</option>
                                            <option value="2">Plantilla de neoplasia benigna</option>
                                            <option value="3">Plantilla de carcinoma</option>
                                        </select>
                                    </div>
                                    
                                    <div class="editor-container">
                                        <div class="editor-toolbar">
                                            <button type="button" class="format-btn" data-command="bold" title="Negrita">
                                                <i class="fas fa-bold"></i>
                                            </button>
                                            <button type="button" class="format-btn" data-command="italic" title="Cursiva">
                                                <i class="fas fa-italic"></i>
                                            </button>
                                            <button type="button" class="format-btn" data-command="underline" title="Subrayado">
                                                <i class="fas fa-underline"></i>
                                            </button>
                                            <button type="button" class="format-btn" data-command="insertUnorderedList" title="Lista">
                                                <i class="fas fa-list-ul"></i>
                                            </button>
                                            <button type="button" class="format-btn" data-command="insertOrderedList" title="Lista numerada">
                                                <i class="fas fa-list-ol"></i>
                                            </button>
                                            <button type="button" class="format-btn" data-command="justifyFull" title="Justificar">
                                                <i class="fas fa-align-justify"></i>
                                            </button>
                                            <select class="format-select" data-command="fontName" title="Tipo de letra">
                                                <option value="">Fuente</option>
                                                <option value="Arial">Arial</option>
                                                <option value="Times New Roman">Times New Roman</option>
                                                <option value="Helvetica">Helvetica</option>
                                                <option value="Georgia">Georgia</option>
                                                <option value="Verdana">Verdana</option>
                                            </select>
                                            <select class="format-select" data-command="fontSize" title="Tama√±o de letra">
                                                <option value="">Tama√±o</option>
                                                <option value="1">8pt</option>
                                                <option value="2">10pt</option>
                                                <option value="3">12pt</option>
                                                <option value="4">14pt</option>
                                                <option value="5">18pt</option>
                                                <option value="6">24pt</option>
                                                <option value="7">36pt</option>
                                            </select>
                                        </div>
                                        <!-- CAMBIO 4: Editor vac√≠o -->
                                        <div class="editor-content" id="micro-editor" contenteditable="true"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- CUADRO DE DIAGN√ìSTICO -->
                            <div class="diagnostico-section">
                                <h3>Diagn√≥stico</h3>
                                <div class="diagnostico-container">
                                    <div class="editor-toolbar">
                                        <button type="button" class="format-btn" data-command="bold" title="Negrita">
                                            <i class="fas fa-bold"></i>
                                        </button>
                                        <button type="button" class="format-btn" data-command="italic" title="Cursiva">
                                            <i class="fas fa-italic"></i>
                                        </button>
                                        <button type="button" class="format-btn" data-command="underline" title="Subrayado">
                                            <i class="fas fa-underline"></i>
                                        </button>
                                        <button type="button" class="format-btn" data-command="insertUnorderedList" title="Lista">
                                            <i class="fas fa-list-ul"></i>
                                        </button>
                                        <button type="button" class="format-btn" data-command="insertOrderedList" title="Lista numerada">
                                            <i class="fas fa-list-ol"></i>
                                        </button>
                                        <button type="button" class="format-btn" title="Centrar texto" data-command="justifyCenter">
                                            <i class="fas fa-align-center"></i>
                                        </button>
                                        <button type="button" class="format-btn" title="Texto a la izquierda" data-command="justifyLeft">
                                            <i class="fas fa-align-left"></i>
                                        </button>
                                        <button type="button" class="format-btn" title="Texto a la derecha" data-command="justifyRight">
                                            <i class="fas fa-align-right"></i>
                                        </button>
                                        <button type="button" class="format-btn" title="Justificar" data-command="justifyFull">
                                            <i class="fas fa-align-justify"></i>
                                        </button>
                                        <select class="format-select" data-command="fontName" title="Tipo de letra">
                                            <option value="">Fuente</option>
                                            <option value="Arial">Arial</option>
                                            <option value="Times New Roman">Times New Roman</option>
                                            <option value="Helvetica">Helvetica</option>
                                            <option value="Georgia">Georgia</option>
                                            <option value="Verdana">Verdana</option>
                                        </select>
                                        <select class="format-select" data-command="fontSize" title="Tama√±o de letra">
                                            <option value="">Tama√±o</option>
                                            <option value="1">8pt</option>
                                            <option value="2">10pt</option>
                                            <option value="3">12pt</option>
                                            <option value="4">14pt</option>
                                            <option value="5">18pt</option>
                                            <option value="6">24pt</option>
                                            <option value="7">36pt</option>
                                        </select>
                                    </div>
                                    <!-- CAMBIO 4: Editor vac√≠o -->
                                    <div class="editor-content" id="diagnostico-editor" contenteditable="true"></div>
                                </div>
                            </div>
                            
                            <!-- SECCI√ìN PARA SUBIR FOTOS -->
                            <div class="photos-section">
                                <h3>Fotos Adjuntas</h3>
                                <div class="photos-grid">
                                    <div class="photo-upload" id="photo-1" onclick="openCropModal(1)">
                                        <i class="fas fa-camera"></i>
                                        <div class="photo-text">Haga clic o arrastre una foto (JPG)</div>
                                        <img class="photo-preview" id="preview-1" alt="Vista previa de la foto">
                                        <div class="photo-controls" style="display: none;" id="controls-1">
                                            <button class="photo-btn" onclick="openCropModal(1)">
                                                <i class="fas fa-sync"></i> Cambiar
                                            </button>
                                            <button class="photo-btn" onclick="removePhoto(1)">
                                                <i class="fas fa-trash"></i> Eliminar
                                            </button>
                                        </div>
                                        <input type="file" id="photo-input-1" accept="image/jpeg" style="display: none;" onchange="handlePhotoSelect(this, 1)">
                                    </div>
                                    
                                    <div class="photo-upload" id="photo-2" onclick="openCropModal(2)">
                                        <i class="fas fa-camera"></i>
                                        <div class="photo-text">Haga clic o arrastre una foto (JPG)</div>
                                        <img class="photo-preview" id="preview-2" alt="Vista previa de la foto">
                                        <div class="photo-controls" style="display: none;" id="controls-2">
                                            <button class="photo-btn" onclick="openCropModal(2)">
                                                <i class="fas fa-sync"></i> Cambiar
                                            </button>
                                            <button class="photo-btn" onclick="removePhoto(2)">
                                                <i class="fas fa-trash"></i> Eliminar
                                            </button>
                                        </div>
                                        <input type="file" id="photo-input-2" accept="image/jpeg" style="display: none;" onchange="handlePhotoSelect(this, 2)">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="buttons">
                            <button class="btn btn-outline" id="volver-btn">
                                <i class="fas fa-arrow-left"></i> Volver
                            </button>
                            <button class="btn btn-primary" id="preliminary-btn">
                                <i class="fas fa-print"></i> Informe Preliminar
                            </button>
                            <button class="btn btn-save" id="guardar-btn">
                                <i class="fas fa-save"></i> Guardar
                            </button>
                            <button class="btn btn-sign" id="firmar-btn">
                                <i class="fas fa-signature"></i> Firmar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para recorte de foto -->
    <div id="crop-modal" class="crop-modal">
        <div class="crop-content">
            <h2>Recortar Foto</h2>
            <p class="crop-info">Seleccione el √°rea de 4.5x4.5 cm para recortar la imagen</p>
            
            <div class="crop-area" id="crop-area">
                <img id="crop-preview" class="crop-preview">
                <div class="crop-box" id="crop-box">
                    <div class="crop-handle" id="crop-handle"></div>
                </div>
            </div>
            
            <div class="crop-buttons">
                <button class="btn btn-outline" id="cancel-crop">Cancelar</button>
                <button class="btn btn-primary" id="save-crop">Guardar Recorte</button>
            </div>
        </div>
    </div>

    <!-- Modal para registro de m√©dicos -->
    <div id="doctor-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Registrar Nuevo M√©dico</h2>
                <span class="modal-close" id="close-doctor-modal">&times;</span>
            </div>
            <div class="modal-body">
                <form id="doctor-form">
                    <div class="form-group">
                        <label for="doctor-name">Nombre del M√©dico</label>
                        <input type="text" id="doctor-name" placeholder="Ej: DR. CARLOS GONZ√ÅLEZ P√âREZ" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="doctor-specialty">Especialidad</label>
                        <input type="text" id="doctor-specialty" placeholder="Ej: Patolog√≠a General" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="doctor-clinic">Cl√≠nica de Procedencia</label>
                        <input type="text" id="doctor-clinic" placeholder="Ej: Cl√≠nica Central" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" id="cancel-doctor-modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="save-doctor-modal">Guardar M√©dico</button>
                
                <!-- Botones de recuperaci√≥n de datos -->
                <button type="button" class="btn btn-secondary" id="recover-doctor-data" style="background: #ff9800; color: white;">
                    <i class="fas fa-undo"></i> Recuperar
                </button>
                <button type="button" class="btn btn-secondary" id="export-doctor-data" style="background: #9c27b0; color: white;">
                    <i class="fas fa-file-export"></i> Exportar
                </button>
                <button type="button" class="btn btn-secondary" id="import-doctor-data" style="background: #3f51b5; color: white;">
                    <i class="fas fa-file-import"></i> Importar
                </button>
            </div>
        </div>
    </div>

    <script>
        // Variables para almacenar los datos del paciente
        let pacienteData = {
            codAtencion: '',
            dni: '',
            edad: '',
            nombres: '',
            apellidos: '',
            telefono: '',
            sexo: '',
            contactoFamiliar: '',
            telefonoContacto: '',
            medicoSolicitante: '',
            motivoEstudio: '',
            clinica: '',
            tipoServicio: ''
        };
        
        // Variables para almacenar datos de informes
        let surgicalReports = JSON.parse(localStorage.getItem('surgicalReports')) || {};
        let cytologicalReports = JSON.parse(localStorage.getItem('cytologicalReports')) || {};
        
        // Almacenamiento para los datos quir√∫rgicos
        let surgicalData = JSON.parse(localStorage.getItem('surgicalData')) || [];
        
        // Almacenamiento para los datos citol√≥gicos
        let cytologicalData = JSON.parse(localStorage.getItem('cytologicalData')) || [];
        
        // Variables globales para seguimiento del informe actual
        let currentReportType = null;
        let currentCodAtencion = null;
        
        // Almacenamiento para m√©dicos
        let doctorsData = JSON.parse(localStorage.getItem('doctorsData')) || [
            { 
                id: 1, 
                nombreCompleto: "DR. CARLOS GONZ√ÅLEZ P√âREZ",
                especialidad: "Patolog√≠a General", 
                clinica: "Cl√≠nica Central",
                fechaRegistro: new Date().toISOString()
            },
            { 
                id: 2, 
                nombreCompleto: "DRA. MAR√çA L√ìPEZ MART√çNEZ",
                especialidad: "Citolog√≠a", 
                clinica: "Cl√≠nica Norte",
                fechaRegistro: new Date().toISOString()
            }
        ];
        
        // Variables para edici√≥n de m√©dicos
        let currentDoctorIndex = null;
        
        // Almacenamiento para plantillas
        let plantillasData = JSON.parse(localStorage.getItem('plantillasData')) || [];
        let currentPlantillaId = null;
        let plantillaModified = false;
        
        // Variables para el recorte de foto
        let currentPhotoId = null;
        let originalImage = null;
        let cropBox = null;
        let isDragging = false;
        let isResizing = false;
        let dragStartX = 0;
        let dragStartY = 0;
        let originalBoxX = 0;
        let originalBoxY = 0;
        
        // üîê SISTEMA DE SEGURIDAD Y CONTROL DE ACCESO ROBUSTO
        // ====================================================
        
        let currentUser = null;
        let userPermissions = 'lectura'; // Por defecto solo lectura
        let securityToken = null;
        let sessionValid = false;
        
        // Validar sesi√≥n al cargar la p√°gina
        function validateUserSession() {
            try {
                const userData = sessionStorage.getItem('current_user');
                if (!userData) {
                    console.warn('üîê No hay sesi√≥n activa, redirigiendo a login');
                    redirectToLogin();
                    return false;
                }
                
                const user = JSON.parse(userData);
                currentUser = user;
                userPermissions = user.permissions || 'lectura';
                sessionValid = true;
                
                // Generar token de seguridad para la sesi√≥n
                securityToken = generateSecurityToken();
                
                console.log('üîê Sesi√≥n v√°lida:', {
                    usuario: currentUser.username,
                    permisos: userPermissions,
                    token: securityToken.substring(0, 10) + '...'
                });
                
                // Configurar interfaz seg√∫n permisos
                configureUIBasedOnPermissions();
                
                return true;
            } catch (error) {
                console.error('üîê Error validando sesi√≥n:', error);
                redirectToLogin();
                return false;
            }
        }
        
        // Generar token de seguridad √∫nico
        function generateSecurityToken() {
            const timestamp = Date.now();
            const random = Math.random().toString(36).substring(2);
            const userHash = btoa(currentUser.username).substring(0, 8);
            return `${userHash}_${timestamp}_${random}`;
        }
        
        // Verificar permisos antes de operaciones cr√≠ticas
        function hasPermission(action) {
            if (!sessionValid || !currentUser) {
                console.warn('üîê Sesi√≥n no v√°lida para acci√≥n:', action);
                return false;
            }
            
            switch (action) {
                case 'delete':
                case 'modify':
                case 'admin':
                    return userPermissions === 'admin';
                case 'create':
                case 'edit':
                case 'save':
                    return userPermissions === 'admin' || userPermissions === 'editor';
                case 'read':
                case 'view':
                    return true; // Todos pueden leer
                default:
                    return false;
            }
        }
        
        // Configurar interfaz seg√∫n permisos del usuario
        function configureUIBasedOnPermissions() {
            const elementsToHide = [];
            const elementsToDisable = [];
            
            if (!hasPermission('delete')) {
                // Ocultar botones de eliminaci√≥n
                elementsToHide.push('.delete-btn', '.btn-delete', '[onclick*="eliminar"]');
            }
            
            if (!hasPermission('edit')) {
                // Deshabilitar campos de edici√≥n
                elementsToDisable.push('input:not([readonly])', 'textarea', 'select', '.btn-save');
            }
            
            if (!hasPermission('admin')) {
                // Ocultar funciones administrativas
                elementsToHide.push('.admin-only', '[data-admin="true"]');
            }
            
            // Aplicar restricciones
            elementsToHide.forEach(selector => {
                document.querySelectorAll(selector).forEach(element => {
                    element.style.display = 'none';
                    element.setAttribute('data-security-hidden', 'true');
                });
            });
            
            elementsToDisable.forEach(selector => {
                document.querySelectorAll(selector).forEach(element => {
                    element.disabled = true;
                    element.setAttribute('data-security-disabled', 'true');
                    element.style.opacity = '0.6';
                    element.style.cursor = 'not-allowed';
                });
            });
            
            // Agregar indicador de permisos en la interfaz
            addPermissionIndicator();
        }
        
        // Agregar indicador visual de permisos
        function addPermissionIndicator() {
            const indicator = document.createElement('div');
            indicator.id = 'permission-indicator';
            indicator.style.cssText = `
                position: fixed;
                top: 10px;
                right: 10px;
                background: ${userPermissions === 'admin' ? '#4caf50' : userPermissions === 'editor' ? '#ff9800' : '#607d8b'};
                color: white;
                padding: 8px 12px;
                border-radius: 20px;
                font-size: 12px;
                font-weight: bold;
                z-index: 1000;
                box-shadow: 0 2px 10px rgba(0,0,0,0.2);
                cursor: pointer;
            `;
            indicator.innerHTML = `
                <i class="fas fa-${userPermissions === 'admin' ? 'crown' : userPermissions === 'editor' ? 'edit' : 'eye'}"></i>
                ${currentUser.username} (${userPermissions.toUpperCase()})
            `;
            
            // Solo los administradores pueden ver el panel de seguridad
            if (userPermissions === 'admin') {
                indicator.onclick = showSecurityPanel;
                indicator.title = 'Clic para ver panel de seguridad';
            }
            
            document.body.appendChild(indicator);
        }
        
        // Panel de seguridad para administradores
        function showSecurityPanel() {
            if (userPermissions !== 'admin') {
                showSecurityAlert('Solo los administradores pueden acceder al panel de seguridad');
                return;
            }
            
            const securityLog = JSON.parse(localStorage.getItem('security_log') || '[]');
            const recentActions = securityLog.slice(-20); // √öltimas 20 acciones
            
            let logHTML = '<h3>üîê √öltimas Acciones de Seguridad</h3><div style="max-height: 300px; overflow-y: auto;">';
            
            if (recentActions.length === 0) {
                logHTML += '<p>No hay acciones registradas</p>';
            } else {
                recentActions.reverse().forEach(action => {
                    const date = new Date(action.timestamp).toLocaleString();
                    const actionColor = action.action === 'DELETE' ? '#f44336' : 
                                      action.action === 'LOGIN' ? '#4caf50' : 
                                      action.action === 'SAVE' ? '#2196f3' : '#ff9800';
                    
                    logHTML += `
                        <div style="border-left: 4px solid ${actionColor}; padding: 8px; margin: 5px 0; background: #f5f5f5;">
                            <strong>${action.action}</strong> - ${action.type}<br>
                            <small>Usuario: ${action.user} | Item: ${action.itemId} | ${date}</small>
                        </div>
                    `;
                });
            }
            
            logHTML += '</div>';
            
            // Estad√≠sticas de integridad
            const dataStats = {
                surgical: surgicalData.length,
                cytological: cytologicalData.length,
                reports: Object.keys({...surgicalReports, ...cytologicalReports}).length,
                photos: Object.keys(photoStorage).length
            };
            
            logHTML += `
                <h3>üìä Estad√≠sticas del Sistema</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 10px 0;">
                    <div style="padding: 10px; background: #e3f2fd; border-radius: 5px;">
                        <strong>Pacientes Quir√∫rgicos:</strong> ${dataStats.surgical}
                    </div>
                    <div style="padding: 10px; background: #f3e5f5; border-radius: 5px;">
                        <strong>Pacientes Citol√≥gicos:</strong> ${dataStats.cytological}
                    </div>
                    <div style="padding: 10px; background: #e8f5e9; border-radius: 5px;">
                        <strong>Informes Guardados:</strong> ${dataStats.reports}
                    </div>
                    <div style="padding: 10px; background: #fff3e0; border-radius: 5px;">
                        <strong>Fotos Almacenadas:</strong> ${dataStats.photos}
                    </div>
                </div>
            `;
            
            // Bot√≥n para exportar log de seguridad
            logHTML += `
                <div style="margin-top: 15px;">
                    <button onclick="exportSecurityLog()" style="
                        background: #4caf50; color: white; border: none; padding: 10px 15px; 
                        border-radius: 5px; cursor: pointer; margin-right: 10px;
                    ">
                        üíæ Exportar Log de Seguridad
                    </button>
                    <button onclick="clearSecurityLog()" style="
                        background: #f44336; color: white; border: none; padding: 10px 15px; 
                        border-radius: 5px; cursor: pointer;
                    ">
                        üóëÔ∏è Limpiar Log
                    </button>
                </div>
            `;
            
            // Crear modal
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.7); z-index: 10000; display: flex;
                align-items: center; justify-content: center;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: white; padding: 20px; border-radius: 10px; 
                    max-width: 800px; max-height: 80vh; overflow-y: auto;
                    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                ">
                    ${logHTML}
                    <div style="text-align: right; margin-top: 15px;">
                        <button onclick="this.closest('[style*=fixed]').remove()" style="
                            background: #607d8b; color: white; border: none; padding: 10px 15px; 
                            border-radius: 5px; cursor: pointer;
                        ">
                            Cerrar
                        </button>
                    </div>
                </div>
            `;
            
            // Cerrar al hacer clic fuera
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
            
            document.body.appendChild(modal);
        }
        
        // Exportar log de seguridad
        function exportSecurityLog() {
            const securityLog = JSON.parse(localStorage.getItem('security_log') || '[]');
            const dataStr = JSON.stringify(securityLog, null, 2);
            const dataBlob = new Blob([dataStr], {type:'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `security_log_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            logSecurityAction('EXPORT', 'SECURITY_LOG', 'EXPORTED');
        }
        
        // Limpiar log de seguridad
        function clearSecurityLog() {
            if (confirm('¬øEst√° seguro de limpiar el log de seguridad? Esta acci√≥n no se puede deshacer.')) {
                localStorage.setItem('security_log', JSON.stringify([]));
                logSecurityAction('CLEAR', 'SECURITY_LOG', 'CLEARED');
                showSecurityAlert('Log de seguridad limpiado', 'success');
            }
        }
        
        // Proteger operaciones de eliminaci√≥n con confirmaci√≥n m√∫ltiple
        function secureDelete(itemType, itemId, callback) {
            if (!hasPermission('delete')) {
                showSecurityAlert('No tiene permisos para eliminar registros');
                return false;
            }
            
            // Primera confirmaci√≥n
            if (!confirm(`¬øEst√° seguro de eliminar este ${itemType}?`)) {
                return false;
            }
            
            // Segunda confirmaci√≥n con detalles
            if (!confirm(`ATENCI√ìN: Esta acci√≥n es IRREVERSIBLE.\n\nEliminar√° permanentemente: ${itemType} ${itemId}\n\n¬øConfirma la eliminaci√≥n?`)) {
                return false;
            }
            
            // Confirmaci√≥n final con contrase√±a
            const password = prompt('Por seguridad, ingrese su contrase√±a para confirmar:');
            if (!password) {
                return false;
            }
            
            // Validar contrase√±a (simulado - en producci√≥n validar contra servidor)
            hashPassword(password).then(hashedPassword => {
                // En producci√≥n, validar contra la base de datos del usuario
                console.log('üîê Validando contrase√±a para eliminaci√≥n...');
                
                // Registrar la acci√≥n de eliminaci√≥n
                logSecurityAction('DELETE', itemType, itemId);
                
                // Ejecutar callback
                if (callback) callback();
                
                showSecurityAlert(`${itemType} eliminado correctamente`, 'success');
            }).catch(error => {
                console.error('üîê Error validando contrase√±a:', error);
                showSecurityAlert('Error en la validaci√≥n de seguridad');
            });
            
            return true;
        }
        
        // Funci√≥n para hashear contrase√±a (compatible con sistema de login)
        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }
        
        // Registrar acciones de seguridad
        function logSecurityAction(action, type, itemId) {
            const logEntry = {
                timestamp: new Date().toISOString(),
                user: currentUser.username,
                action: action,
                type: type,
                itemId: itemId,
                sessionToken: securityToken
            };
            
            // Guardar en log de seguridad
            const securityLog = JSON.parse(localStorage.getItem('security_log') || '[]');
            securityLog.push(logEntry);
            
            // Mantener solo los √∫ltimos 1000 registros
            if (securityLog.length > 1000) {
                securityLog.splice(0, securityLog.length - 1000);
            }
            
            localStorage.setItem('security_log', JSON.stringify(securityLog));
            
            console.log('üîê Acci√≥n registrada:', logEntry);
        }
        
        // Mostrar alertas de seguridad
        function showSecurityAlert(message, type = 'error') {
            const alert = document.createElement('div');
            alert.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: ${type === 'success' ? '#4caf50' : '#f44336'};
                color: white;
                padding: 20px 30px;
                border-radius: 10px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                z-index: 10000;
                font-size: 16px;
                font-weight: bold;
                text-align: center;
                max-width: 400px;
                animation: securityAlertAnimation 0.3s ease;
            `;
            
            alert.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}"></i>
                <br><br>
                ${message}
            `;
            
            document.body.appendChild(alert);
            
            setTimeout(() => {
                alert.style.animation = 'securityAlertAnimation 0.3s ease reverse';
                setTimeout(() => alert.remove(), 300);
            }, 3000);
        }
        
        // Redirigir a login si no hay sesi√≥n v√°lida
        function redirectToLogin() {
            alert('Sesi√≥n expirada. Ser√° redirigido al sistema de login.');
            window.location.href = 'index.html';
        }
        
        // Proteger datos contra modificaciones no autorizadas
        function protectDataIntegrity() {
            // Crear checksum de datos cr√≠ticos
            const criticalData = {
                surgical: surgicalData,
                cytological: cytologicalData,
                reports: { ...surgicalReports, ...cytologicalReports },
                photos: photoStorage
            };
            
            const dataChecksum = btoa(JSON.stringify(criticalData)).substring(0, 32);
            sessionStorage.setItem('data_checksum', dataChecksum);
            
            console.log('üîê Checksum de integridad creado:', dataChecksum);
        }
        
        // Verificar integridad de datos
        function verifyDataIntegrity() {
            const currentData = {
                surgical: surgicalData,
                cytological: cytologicalData,
                reports: { ...surgicalReports, ...cytologicalReports },
                photos: photoStorage
            };
            
            const currentChecksum = btoa(JSON.stringify(currentData)).substring(0, 32);
            const storedChecksum = sessionStorage.getItem('data_checksum');
            
            if (storedChecksum && currentChecksum !== storedChecksum) {
                console.warn('üîê ¬°ALERTA! Posible modificaci√≥n no autorizada de datos detectada');
                logSecurityAction('DATA_TAMPERING', 'INTEGRITY_CHECK', 'FAILED');
                return false;
            }
            
            return true;
        }
        
        // Estilo para animaciones de seguridad
        const securityStyles = document.createElement('style');
        securityStyles.innerHTML = `
            @keyframes securityAlertAnimation {
                from { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
                to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            }
            
            .security-protected {
                position: relative;
            }
            
            .security-protected::before {
                content: 'üîí';
                position: absolute;
                top: -5px;
                right: -5px;
                background: #ff5722;
                color: white;
                border-radius: 50%;
                width: 20px;
                height: 20px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 10px;
                z-index: 100;
            }
        `;
        document.head.appendChild(securityStyles);
        
        // üì∑ SISTEMA DE ALMACENAMIENTO PERSISTENTE DE FOTOS MEJORADO CON SEGURIDAD Y M√öLTIPLES CAPAS
        let photoStorage = JSON.parse(localStorage.getItem('photoStorage')) || {};
        
        // Estructura: { codAtencion: { photo1: {dataURL, timestamp, checksum}, photo2: {dataURL, timestamp, checksum} } }
        
        // Sistema de respaldo m√∫ltiple para fotos
        function savePhotoWithMultipleBackups(codAtencion, photoKey, photoData) {
            try {
                // 1. Guardar en photoStorage principal
                if (!photoStorage[codAtencion]) {
                    photoStorage[codAtencion] = {};
                }
                
                // A√±adir checksum para verificaci√≥n de integridad
                const photoWithMeta = {
                    ...photoData,
                    timestamp: new Date().toISOString(),
                    checksum: btoa(photoData.dataURL).substring(0, 32)
                };
                
                photoStorage[codAtencion][photoKey] = photoWithMeta;
                
                // 2. Guardar en localStorage (principal)
                localStorage.setItem('photoStorage', JSON.stringify(photoStorage));
                
                // 3. Respaldo en sessionStorage
                sessionStorage.setItem('photoStorage_backup', JSON.stringify(photoStorage));
                
                // 4. Respaldo espec√≠fico por paciente
                const patientPhotoKey = `photos_${codAtencion}`;
                localStorage.setItem(patientPhotoKey, JSON.stringify(photoStorage[codAtencion]));
                
                // 5. Guardar en IndexedDB si est√° disponible
                if (db) {
                    savePhotoToIndexedDB(codAtencion, photoStorage[codAtencion]);
                }
                
                // 6. Crear backup con timestamp
                const backupData = {
                    timestamp: new Date().toISOString(),
                    codAtencion: codAtencion,
                    photos: photoStorage[codAtencion]
                };
                localStorage.setItem(`photoBackup_${codAtencion}`, JSON.stringify(backupData));
                
                console.log(`üì∑ Foto ${photoKey} guardada con respaldos m√∫ltiples para ${codAtencion}`);
                return true;
                
            } catch (error) {
                console.error('‚ùå Error al guardar foto con respaldos m√∫ltiples:', error);
                
                // Intento de emergencia usando solo localStorage b√°sico
                try {
                    localStorage.setItem(`emergency_photo_${codAtencion}_${photoKey}`, JSON.stringify(photoData));
                    console.log('üì∑ Foto guardada en modo emergencia');
                    return true;
                } catch (emergencyError) {
                    console.error('‚ùå Error cr√≠tico: No se pudo guardar la foto en ning√∫n formato:', emergencyError);
                    return false;
                }
            }
        }
        
        // Funci√≥n para cargar fotos con sistema de recuperaci√≥n robusto
        function loadPhotosWithRecovery(codAtencion) {
            console.log(`üì∑ Iniciando carga robusta de fotos para: ${codAtencion}`);
            
            let photosLoaded = null;
            
            try {
                // 1. Intentar cargar desde photoStorage principal
                if (photoStorage[codAtencion]) {
                    photosLoaded = photoStorage[codAtencion];
                    console.log('üì∑ Fotos cargadas desde almacenamiento principal');
                }
                
                // 2. Si no hay datos, intentar desde respaldo espec√≠fico del paciente
                if (!photosLoaded) {
                    const patientPhotoKey = `photos_${codAtencion}`;
                    const patientPhotos = localStorage.getItem(patientPhotoKey);
                    if (patientPhotos) {
                        photosLoaded = JSON.parse(patientPhotos);
                        console.log('üì∑ Fotos recuperadas desde respaldo espec√≠fico del paciente');
                        
                        // Restaurar en photoStorage principal
                        photoStorage[codAtencion] = photosLoaded;
                        localStorage.setItem('photoStorage', JSON.stringify(photoStorage));
                    }
                }
                
                // 3. Si a√∫n no hay datos, intentar desde sessionStorage
                if (!photosLoaded) {
                    const sessionBackup = sessionStorage.getItem('photoStorage_backup');
                    if (sessionBackup) {
                        const sessionData = JSON.parse(sessionBackup);
                        if (sessionData[codAtencion]) {
                            photosLoaded = sessionData[codAtencion];
                            console.log('üì∑ Fotos recuperadas desde sessionStorage');
                            
                            // Restaurar en almacenamiento principal
                            photoStorage[codAtencion] = photosLoaded;
                            localStorage.setItem('photoStorage', JSON.stringify(photoStorage));
                        }
                    }
                }
                
                // 4. Si a√∫n no hay datos, intentar desde backup con timestamp
                if (!photosLoaded) {
                    const backupKey = `photoBackup_${codAtencion}`;
                    const backupData = localStorage.getItem(backupKey);
                    if (backupData) {
                        const backup = JSON.parse(backupData);
                        if (backup.photos) {
                            photosLoaded = backup.photos;
                            console.log('üì∑ Fotos recuperadas desde backup con timestamp');
                            
                            // Restaurar en almacenamiento principal
                            photoStorage[codAtencion] = photosLoaded;
                            localStorage.setItem('photoStorage', JSON.stringify(photoStorage));
                        }
                    }
                }
                
                // 5. √öltimo recurso: buscar fotos de emergencia
                if (!photosLoaded) {
                    photosLoaded = {};
                    for (let i = 1; i <= 6; i++) {
                        const emergencyKey = `emergency_photo_${codAtencion}_photo${i}`;
                        const emergencyPhoto = localStorage.getItem(emergencyKey);
                        if (emergencyPhoto) {
                            try {
                                photosLoaded[`photo${i}`] = JSON.parse(emergencyPhoto);
                                console.log(`üì∑ Foto ${i} recuperada desde almacenamiento de emergencia`);
                            } catch (e) {
                                console.error(`‚ùå Error al recuperar foto de emergencia ${i}:`, e);
                            }
                        }
                    }
                    
                    // Si encontramos fotos de emergencia, restaurar en almacenamiento principal
                    if (Object.keys(photosLoaded).length > 0) {
                        photoStorage[codAtencion] = photosLoaded;
                        localStorage.setItem('photoStorage', JSON.stringify(photoStorage));
                        console.log('üì∑ Fotos de emergencia restauradas en almacenamiento principal');
                    }
                }
                
                return photosLoaded;
                
            } catch (error) {
                console.error('‚ùå Error durante la carga robusta de fotos:', error);
                return null;
            }
        }
        
        // Funci√≥n para guardar foto en IndexedDB
        async function savePhotoToIndexedDB(codAtencion, photos) {
            if (!db) return;
            
            try {
                const transaction = db.transaction(['photoStorage'], 'readwrite');
                const store = transaction.objectStore('photoStorage');
                
                // Primero eliminar entrada existente
                await store.delete(codAtencion);
                
                // Luego agregar la nueva
                await store.add({ codAtencion, photos });
                
                console.log(`üì∑ Fotos guardadas en IndexedDB para ${codAtencion}`);
            } catch (error) {
                console.error('‚ùå Error al guardar fotos en IndexedDB:', error);
            }
        }
        
        // Funci√≥n para verificar integridad de fotos
        function verifyPhotoIntegrity(codAtencion) {
            const photos = photoStorage[codAtencion];
            if (!photos) return true;
            
            let integrityOk = true;
            
            Object.keys(photos).forEach(photoKey => {
                const photo = photos[photoKey];
                if (photo.checksum && photo.dataURL) {
                    const currentChecksum = btoa(photo.dataURL).substring(0, 32);
                    if (currentChecksum !== photo.checksum) {
                        console.warn(`‚ö†Ô∏è Checksum no coincide para ${photoKey} del paciente ${codAtencion}`);
                        integrityOk = false;
                    }
                }
            });
            
            return integrityOk;
        }
        
        // Funci√≥n para auto-reparaci√≥n y verificaci√≥n de fotos
        function autoRepairAndVerifyPhotos() {
            console.log('üì∑ Iniciando auto-reparaci√≥n y verificaci√≥n de fotos...');
            
            let repairedCount = 0;
            let totalPhotos = 0;
            
            // Verificar todas las fotos en el almacenamiento
            Object.keys(photoStorage).forEach(codAtencion => {
                const patientPhotos = photoStorage[codAtencion];
                
                Object.keys(patientPhotos).forEach(photoKey => {
                    totalPhotos++;
                    const photo = patientPhotos[photoKey];
                    
                    // Verificar y reparar datos faltantes
                    let needsRepair = false;
                    
                    if (!photo.timestamp) {
                        photo.timestamp = new Date().toISOString();
                        needsRepair = true;
                    }
                    
                    if (!photo.checksum && photo.dataURL) {
                        photo.checksum = btoa(photo.dataURL).substring(0, 32);
                        needsRepair = true;
                    }
                    
                    if (!photo.fileName) {
                        const photoId = photoKey.replace('photo', '');
                        photo.fileName = `foto_${photoId}_${codAtencion}.jpg`;
                        needsRepair = true;
                    }
                    
                    if (needsRepair) {
                        repairedCount++;
                        console.log(`üõ†Ô∏è Reparando foto ${photoKey} para paciente ${codAtencion}`);
                        
                        // Guardar con el sistema robusto
                        savePhotoWithMultipleBackups(codAtencion, photoKey, photo);
                    }
                });
            });
            
            console.log(`üì∑ Auto-reparaci√≥n completada: ${repairedCount}/${totalPhotos} fotos reparadas`);
            
            // Crear respaldo completo despu√©s de la reparaci√≥n
            if (repairedCount > 0) {
                localStorage.setItem('photoStorage', JSON.stringify(photoStorage));
                sessionStorage.setItem('photoStorage_backup', JSON.stringify(photoStorage));
                
                showSuccessMessage(`üõ†Ô∏è Sistema auto-reparado: ${repairedCount} foto${repairedCount !== 1 ? 's' : ''} actualizada${repairedCount !== 1 ? 's' : ''}`);
            }
            
            return { total: totalPhotos, repaired: repairedCount };
        }
        
        // Funci√≥n para limpiar fotos hu√©rfanas (sin paciente asociado)
        function cleanOrphanedPhotos() {
            console.log('üßπ Limpiando fotos hu√©rfanas...');
            
            let cleanedCount = 0;
            
            // Obtener c√≥digos de pacientes v√°lidos
            const validCodes = new Set();
            surgicalData.forEach(p => validCodes.add(p.codAtencion));
            cytologicalData.forEach(p => validCodes.add(p.codAtencion));
            
            // Verificar fotos en almacenamiento
            Object.keys(photoStorage).forEach(codAtencion => {
                if (!validCodes.has(codAtencion) && !codAtencion.startsWith('TEMP_')) {
                    console.log(`üßπ Eliminando fotos hu√©rfanas para c√≥digo: ${codAtencion}`);
                    delete photoStorage[codAtencion];
                    
                    // Limpiar tambi√©n los respaldos
                    localStorage.removeItem(`photos_${codAtencion}`);
                    localStorage.removeItem(`photoBackup_${codAtencion}`);
                    
                    cleanedCount++;
                }
            });
            
            if (cleanedCount > 0) {
                localStorage.setItem('photoStorage', JSON.stringify(photoStorage));
                sessionStorage.setItem('photoStorage_backup', JSON.stringify(photoStorage));
                
                console.log(`üßπ Limpieza completada: ${cleanedCount} conjunto${cleanedCount !== 1 ? 's' : ''} de fotos hu√©rfana${cleanedCount !== 1 ? 's' : ''} eliminada${cleanedCount !== 1 ? 's' : ''}`);
            }
            
            return cleanedCount;
        }
        
        // Funci√≥n de prueba para demostrar el sistema robusto de persistencia de fotos
        function testPhotoSystem() {
            console.log('üß™ INICIANDO PRUEBA DEL SISTEMA DE FOTOS...');
            
            // Simular datos de prueba
            const testCodAtencion = 'TEST_001';
            const testPhotoData = {
                dataURL: 'data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD//gA7Q1JFQVRPUjogZ2QtanBlZyB2MS4wICh1c2luZyBJSkcgSlBFRyB2ODApLCBxdWFsaXR5ID0gOTAK/9sAQwADAgIDAgIDAwMDBAMDBAUIBQUEBAUKBwcGCAwKDAwLCgsLDQ4SEA0OEQ4LCxAWEBETFBUVFQwPFxgWFBgSFBUU/9sAQwEDBAQFBAUJBQUJFA0LDRQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQU/8AAEQgAZABkAwEiAAIRAQMRAf/EAB8AAAEFAQEBAQEBAAAAAAAAAAABAgMEBQYHCAkKC//EALUQAAIBAwMEAgECBQYGAwAAAAABAgMEEQUGIQcSMUFRYXEUFSIygfAMI0KRobHBCSMzUvHxVNLwBPJRUvGi0kMGZBYXGBgqNhcXGBgqNhUXGBgqNhcXGxsqNhUXGBgqNhcXGxsqNhUXGBgqNhcXGxsqNhUXGBgqNhcXGxsqNhUXGBgqNhcXGxsqNhUXGBgqNhcXGxsqNhcXGBgqNhcXGxs/8QAHwEAAwEBAQEBAQEBAQAAAAAAAAECAwQFBgcICQoL/8QAtREAAgECBAQDBAcFBAQAAQJ3AAECAxEEBSExBhJBUQdhcRMiMoEIFEKRobHwCSMzUvAVYnLRChYkNOEl8RcYGRomJygpKjU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6goOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4uPk5ebn6Onq8vP09fb3+Pn6/9oADAMBAAIRAxEAPwA=',
                fileName: 'test_photo_001.jpg'
            };
            
            // Prueba 1: Guardar foto
            console.log('üíæ Prueba 1: Guardando foto de prueba...');
            const saveResult = savePhotoWithMultipleBackups(testCodAtencion, 'photo1', testPhotoData);
            console.log(`Resultado de guardado: ${saveResult ? '‚úÖ √âXITO' : '‚ùå FALLA'}`);
            
            // Prueba 2: Verificar integridad
            console.log('üîç Prueba 2: Verificando integridad...');
            const integrityResult = verifyPhotoIntegrity(testCodAtencion);
            console.log(`Integridad: ${integrityResult ? '‚úÖ OK' : '‚ùå COMPROMETIDA'}`);
            
            // Prueba 3: Cargar fotos
            console.log('üì∑ Prueba 3: Cargando fotos...');
            const loadedPhotos = loadPhotosWithRecovery(testCodAtencion);
            console.log(`Fotos cargadas: ${loadedPhotos ? Object.keys(loadedPhotos).length : 0}`);
            
            // Prueba 4: Auto-reparaci√≥n
            console.log('üõ†Ô∏è Prueba 4: Ejecutando auto-reparaci√≥n...');
            const repairResult = autoRepairAndVerifyPhotos();
            console.log(`Reparaci√≥n: ${repairResult.repaired}/${repairResult.total} fotos reparadas`);
            
            // Prueba 5: Limpiar datos de prueba
            console.log('üßπ Prueba 5: Limpiando datos de prueba...');
            if (photoStorage[testCodAtencion]) {
                delete photoStorage[testCodAtencion];
                localStorage.removeItem(`photos_${testCodAtencion}`);
                localStorage.removeItem(`photoBackup_${testCodAtencion}`);
                localStorage.setItem('photoStorage', JSON.stringify(photoStorage));
            }
            
            console.log('üéâ PRUEBA DEL SISTEMA COMPLETADA');
            
            return {
                save: saveResult,
                integrity: integrityResult,
                load: !!loadedPhotos,
                repair: repairResult
            };
        }
        
        // Funci√≥n para validar DNI (solo n√∫meros)
        function validateDNI(input) {
            // Remover cualquier car√°cter que no sea n√∫mero
            let value = input.value.replace(/\D/g, '');
            
            // Limitar a 8 d√≠gitos m√°ximo (DNI est√°ndar)
            if (value.length > 8) {
                value = value.substring(0, 8);
            }
            
            // Actualizar el valor del campo
            input.value = value;
            
            // Agregar validaci√≥n visual
            if (value.length === 8) {
                input.style.borderColor = '#4caf50';
                input.style.backgroundColor = '#f8fff8';
            } else if (value.length > 0 && value.length < 8) {
                input.style.borderColor = '#ff9800';
                input.style.backgroundColor = '#fff8e1';
            } else {
                input.style.borderColor = '#e0e0e0';
                input.style.backgroundColor = '#ffffff';
            }
        }
        
        // Funci√≥n para configurar validaci√≥n de DNI en un input
        function setupDNIValidation(inputElement) {
            if (!inputElement) return;
            
            // Validaci√≥n en tiempo real
            inputElement.addEventListener('input', function() {
                validateDNI(this);
            });
            
            // Prevenir entrada de caracteres no num√©ricos
            inputElement.addEventListener('keydown', function(e) {
                // Permitir teclas de control (backspace, delete, tab, escape, enter)
                if ([8, 9, 27, 13, 46].indexOf(e.keyCode) !== -1 ||
                    // Permitir Ctrl+A, Ctrl+C, Ctrl+V, Ctrl+X
                    (e.keyCode === 65 && e.ctrlKey === true) ||
                    (e.keyCode === 67 && e.ctrlKey === true) ||
                    (e.keyCode === 86 && e.ctrlKey === true) ||
                    (e.keyCode === 88 && e.ctrlKey === true) ||
                    // Permitir teclas de flecha
                    (e.keyCode >= 35 && e.keyCode <= 39)) {
                    return;
                }
                // Asegurar que solo se permitan n√∫meros (0-9)
                if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) && (e.keyCode < 96 || e.keyCode > 105)) {
                    e.preventDefault();
                }
            });
            
            // Validaci√≥n de pegado
            inputElement.addEventListener('paste', function(e) {
                e.preventDefault();
                let paste = (e.clipboardData || window.clipboardData).getData('text');
                // Solo mantener n√∫meros del contenido pegado
                paste = paste.replace(/\D/g, '');
                if (paste.length > 8) {
                    paste = paste.substring(0, 8);
                }
                this.value = paste;
                validateDNI(this);
            });
        }
        
        // Configurar validaci√≥n DNI para todos los campos relevantes
        function initializeDNIValidation() {
            // Campo DNI principal en registro de pacientes
            setupDNIValidation(document.getElementById('dni'));
            
            // Campo DNI en informe
            setupDNIValidation(document.getElementById('informe-dni'));
            
            // Campos DNI en filtros de b√∫squeda
            setupDNIValidation(document.getElementById('search-dni'));
            setupDNIValidation(document.getElementById('search-dni-cito'));
            
            console.log('‚úÖ Validaci√≥n de DNI configurada para todos los campos');
        }
        
        // Funci√≥n para formatear fecha a dd-mm-aaaa
        function formatDate(date) {
            const d = new Date(date);
            let month = '' + (d.getMonth() + 1);
            let day = '' + d.getDate();
            const year = d.getFullYear();

            if (month.length < 2) 
                month = '0' + month;
            if (day.length < 2) 
                day = '0' + day;

            return [day, month, year].join('-');
        }

        // ===============================================
        // SISTEMA ROBUSTO DE PERSISTENCIA DE DATOS
        // ===============================================
        
        // Base de datos IndexedDB para mayor persistencia
        let db;
        const DB_NAME = 'JCPathLabDB';
        const DB_VERSION = 1;
        
        // Inicializar IndexedDB
        function initIndexedDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    
                    // Crear almacenes de objetos si no existen
                    if (!db.objectStoreNames.contains('surgicalData')) {
                        db.createObjectStore('surgicalData', { keyPath: 'codAtencion' });
                    }
                    if (!db.objectStoreNames.contains('cytologicalData')) {
                        db.createObjectStore('cytologicalData', { keyPath: 'codAtencion' });
                    }
                    if (!db.objectStoreNames.contains('surgicalReports')) {
                        db.createObjectStore('surgicalReports', { keyPath: 'codAtencion' });
                    }
                    if (!db.objectStoreNames.contains('cytologicalReports')) {
                        db.createObjectStore('cytologicalReports', { keyPath: 'codAtencion' });
                    }
                    if (!db.objectStoreNames.contains('doctorsData')) {
                        db.createObjectStore('doctorsData', { keyPath: 'id' });
                    }
                    // üì∑ CREAR ALMAC√âN PARA FOTOS
                    if (!db.objectStoreNames.contains('photoStorage')) {
                        db.createObjectStore('photoStorage', { keyPath: 'codAtencion' });
                    }
                };
            });
        }
        
        // Guardar en IndexedDB
        function saveToIndexedDB(storeName, data) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject('Base de datos no inicializada');
                    return;
                }
                
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                
                // Limpiar almac√©n antes de guardar
                const clearRequest = store.clear();
                
                clearRequest.onsuccess = () => {
                    // Guardar datos
                    if (Array.isArray(data)) {
                        data.forEach(item => {
                            store.add(item);
                        });
                    } else if (storeName === 'photoStorage') {
                        // üì∑ MANEJO ESPECIAL PARA FOTOS
                        Object.entries(data).forEach(([codAtencion, photos]) => {
                            store.add({ codAtencion, photos });
                        });
                    } else {
                        // Para objetos como reports
                        Object.entries(data).forEach(([key, value]) => {
                            store.add({ codAtencion: key, ...value });
                        });
                    }
                };
                
                transaction.oncomplete = () => resolve();
                transaction.onerror = () => reject(transaction.error);
            });
        }
        
        // Cargar desde IndexedDB
        function loadFromIndexedDB(storeName) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    resolve([]);
                    return;
                }
                
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.getAll();
                
                request.onsuccess = () => {
                    resolve(request.result || []);
                };
                
                request.onerror = () => reject(request.error);
            });
        }
        
        // Sistema de sincronizaci√≥n en tiempo real
        function syncDataRealTime() {
            // Sincronizar cada 30 segundos
            setInterval(() => {
                saveAllDataRobust();
            }, 30000);
            
            // Sincronizar antes de cerrar la p√°gina
            window.addEventListener('beforeunload', (e) => {
                saveAllDataRobust();
                // Crear respaldo final
                createEmergencyBackup();
            });
            
            // Sincronizar al perder y recuperar el foco
            window.addEventListener('blur', saveAllDataRobust);
            window.addEventListener('focus', loadAllDataRobust);
        }
        
        // Funci√≥n para guardar todos los datos de forma robusta
        async function saveAllDataRobust() {
            try {
                // 1. Guardar en localStorage (m√©todo principal)
                localStorage.setItem('surgicalData', JSON.stringify(surgicalData));
                localStorage.setItem('cytologicalData', JSON.stringify(cytologicalData));
                localStorage.setItem('doctorsData', JSON.stringify(doctorsData));
                localStorage.setItem('plantillasData', JSON.stringify(plantillasData));
                localStorage.setItem('surgicalReports', JSON.stringify(surgicalReports));
                localStorage.setItem('cytologicalReports', JSON.stringify(cytologicalReports));
                // üì∑ ASEGURAR PERSISTENCIA DE FOTOS
                localStorage.setItem('photoStorage', JSON.stringify(photoStorage));
                
                // 2. Guardar en sessionStorage (respaldo inmediato)
                sessionStorage.setItem('surgicalData_backup', JSON.stringify(surgicalData));
                sessionStorage.setItem('cytologicalData_backup', JSON.stringify(cytologicalData));
                sessionStorage.setItem('doctorsData_backup', JSON.stringify(doctorsData));
                sessionStorage.setItem('surgicalReports_backup', JSON.stringify(surgicalReports));
                sessionStorage.setItem('cytologicalReports_backup', JSON.stringify(cytologicalReports));
                // üì∑ RESPALDO DE FOTOS EN SESSION STORAGE
                sessionStorage.setItem('photoStorage_backup', JSON.stringify(photoStorage));
                
                // 3. Guardar en IndexedDB (m√°xima persistencia)
                if (db) {
                    await saveToIndexedDB('surgicalData', surgicalData);
                    await saveToIndexedDB('cytologicalData', cytologicalData);
                    await saveToIndexedDB('surgicalReports', surgicalReports);
                    await saveToIndexedDB('cytologicalReports', cytologicalReports);
                    await saveToIndexedDB('doctorsData', doctorsData);
                    // üì∑ GUARDAR FOTOS EN INDEXEDDB
                    await saveToIndexedDB('photoStorage', photoStorage);
                }
                
                // 4. Crear respaldo con timestamp
                const timestamp = new Date().toISOString();
                const fullBackup = {
                    timestamp,
                    surgicalData,
                    cytologicalData,
                    surgicalReports,
                    cytologicalReports,
                    doctorsData,
                    plantillasData,
                    // üì∑ INCLUIR FOTOS EN RESPALDO COMPLETO
                    photoStorage
                };
                
                localStorage.setItem('lastBackup', JSON.stringify(fullBackup));
                localStorage.setItem('backupTimestamp', timestamp);
                
                console.log('‚úÖ Datos guardados exitosamente en todos los sistemas (incluyendo fotos)');
                
            } catch (error) {
                console.error('‚ùå Error al guardar datos:', error);
                // Intentar respaldo de emergencia
                createEmergencyBackup();
            }
        }
        
        // üè• FUNCI√ìN ESPEC√çFICA PARA PERSISTENCIA ROBUSTA DE M√âDICOS
        async function saveDoctorDataRobust() {
            try {
                console.log('üè• Iniciando guardado robusto de datos de m√©dicos...');
                
                // 1. Guardar en localStorage (principal)
                localStorage.setItem('doctorsData', JSON.stringify(doctorsData));
                
                // 2. Respaldo en sessionStorage
                sessionStorage.setItem('doctorsData_backup', JSON.stringify(doctorsData));
                
                // 3. Respaldo espec√≠fico con timestamp para m√©dicos
                const timestamp = new Date().toISOString();
                const doctorBackup = {
                    timestamp,
                    data: doctorsData,
                    count: doctorsData.length,
                    checksum: btoa(JSON.stringify(doctorsData)).substring(0, 32)
                };
                localStorage.setItem('doctorsBackup', JSON.stringify(doctorBackup));
                
                // 4. Guardar en IndexedDB si est√° disponible
                if (db) {
                    await saveToIndexedDB('doctorsData', doctorsData);
                    console.log('‚úÖ Datos de m√©dicos guardados en IndexedDB');
                }
                
                // 5. Crear m√∫ltiples respaldos de emergencia
                for (let i = 0; i < 3; i++) {
                    localStorage.setItem(`doctorsEmergency_${i}`, JSON.stringify({
                        backup: i + 1,
                        timestamp: new Date().toISOString(),
                        data: doctorsData
                    }));
                }
                
                // 6. Verificar integridad inmediatamente despu√©s del guardado
                if (await verifyDoctorDataIntegrity()) {
                    console.log('‚úÖ Integridad de datos de m√©dicos verificada');
                } else {
                    console.warn('‚ö†Ô∏è Problema de integridad detectado, creando respaldo adicional');
                    createDoctorEmergencyBackup();
                }
                
                console.log('üè• Guardado robusto de m√©dicos completado exitosamente');
                
            } catch (error) {
                console.error('‚ùå Error en guardado robusto de m√©dicos:', error);
                createDoctorEmergencyBackup();
            }
        }
        
        // üîç FUNCI√ìN PARA VERIFICAR INTEGRIDAD DE DATOS DE M√âDICOS
        async function verifyDoctorDataIntegrity() {
            try {
                const localData = JSON.parse(localStorage.getItem('doctorsData') || '[]');
                const backupData = JSON.parse(sessionStorage.getItem('doctorsData_backup') || '[]');
                
                if (localData.length !== backupData.length) {
                    console.warn('‚ö†Ô∏è Diferencia en cantidad de m√©dicos entre localStorage y sessionStorage');
                    return false;
                }
                
                // Verificar checksums si existen
                for (let doctor of localData) {
                    if (doctor.checksum) {
                        const expectedChecksum = btoa(doctor.nombreCompleto + doctor.especialidad + doctor.clinica).substring(0, 16);
                        if (doctor.checksum !== expectedChecksum) {
                            console.warn(`‚ö†Ô∏è Checksum inv√°lido para m√©dico ID: ${doctor.id}`);
                            return false;
                        }
                    }
                }
                
                return true;
            } catch (error) {
                console.error('‚ùå Error verificando integridad de m√©dicos:', error);
                return false;
            }
        }
        
        // üö® FUNCI√ìN DE RESPALDO DE EMERGENCIA ESPEC√çFICA PARA M√âDICOS
        function createDoctorEmergencyBackup() {
            try {
                const timestamp = Date.now();
                const emergencyKey = `doctorsEmergencyBackup_${timestamp}`;
                
                const emergencyData = {
                    timestamp: new Date().toISOString(),
                    data: doctorsData,
                    source: 'emergency_backup',
                    totalDoctors: doctorsData.length
                };
                
                // Guardar en m√∫ltiples ubicaciones
                localStorage.setItem(emergencyKey, JSON.stringify(emergencyData));
                sessionStorage.setItem(`emergency_doctors_${timestamp}`, JSON.stringify(emergencyData));
                
                // Mantener solo los 5 respaldos de emergencia m√°s recientes
                const allKeys = Object.keys(localStorage).filter(key => key.startsWith('doctorsEmergencyBackup_'));
                if (allKeys.length > 5) {
                    allKeys.sort().slice(0, -5).forEach(key => localStorage.removeItem(key));
                }
                
                console.log('üö® Respaldo de emergencia de m√©dicos creado:', emergencyKey);
                
            } catch (error) {
                console.error('‚ùå Error creando respaldo de emergencia de m√©dicos:', error);
            }
        }
        
        // üîß FUNCI√ìN PARA INICIALIZAR LA BASE DE DATOS INDEXEDDB
        async function initializeDatabase() {
            try {
                // Crear o conectar a la base de datos
                const db = new Dexie('JCPathLabDB');
                db.version(1).stores({
                    doctors: '++id, nombreCompleto, especialidad, clinica, fechaRegistro',
                    templates: '++id, nombre, tipo, descripcion, contenido, fechaCreacion',
                    patients: '++id, codAtencion, dni, nombres, apellidos, edad, telefono, sexo, familiarContacto, telefonoContacto, medicoSolicitante, fechaRegistro',
                    surgicalReports: '++id, codAtencion, tipo, fecha, macroscopica, microscopica, diagnostico, medico, firma, fotos',
                    cytologicalReports: '++id, codAtencion, tipo, fecha, descripcion, diagnostico, medico, firma, fotos',
                    photos: '++id, codAtencion, imageData, timestamp'
                });
                
                // Guardar datos actuales en la base de datos
                await saveDataToDatabase();
                
                console.log('‚úÖ Base de datos inicializada exitosamente');
            } catch (error) {
                console.error('‚ùå Error al inicializar la base de datos:', error);
            }
        }
        
        // üé® FUNCI√ìN PARA APLICAR ANIMACIONES A LA P√ÅGINA
        function applyPageAnimations() {
            // Aplicar animaciones a tarjetas
            const cards = document.querySelectorAll('.card');
            cards.forEach((card, index) => {
                // Retraso progresivo para efecto cascada
                setTimeout(() => {
                    card.classList.add('animated-fadeIn');
                }, index * 100);
            });
            
            // Aplicar animaciones a elementos del men√∫
            const menuItems = document.querySelectorAll('.menu-item');
            menuItems.forEach((item, index) => {
                setTimeout(() => {
                    item.classList.add('animated-slideInLeft');
                }, index * 50);
            });
            
            // Aplicar animaciones a botones
            const buttons = document.querySelectorAll('.btn');
            buttons.forEach(button => {
                button.classList.add('animated-pulse');
            });
            
            console.log('‚úÖ Animaciones aplicadas a la p√°gina');
        }
        
        // üíæ FUNCI√ìN PARA GUARDAR DATOS EN LA BASE DE DATOS
        async function saveDataToDatabase() {
            try {
                const db = new Dexie('JCPathLabDB');
                db.version(1).stores({
                    doctors: '++id, nombreCompleto, especialidad, clinica, fechaRegistro',
                    templates: '++id, nombre, tipo, descripcion, contenido, fechaCreacion',
                    patients: '++id, codAtencion, dni, nombres, apellidos, edad, telefono, sexo, familiarContacto, telefonoContacto, medicoSolicitante, fechaRegistro',
                    surgicalReports: '++id, codAtencion, tipo, fecha, macroscopica, microscopica, diagnostico, medico, firma, fotos',
                    cytologicalReports: '++id, codAtencion, tipo, fecha, descripcion, diagnostico, medico, firma, fotos',
                    photos: '++id, codAtencion, imageData, timestamp'
                });
                
                // Guardar m√©dicos
                if (doctorsData && doctorsData.length > 0) {
                    await db.doctors.clear();
                    await db.doctors.bulkAdd(doctorsData);
                }
                
                // Guardar plantillas
                if (plantillasData && plantillasData.length > 0) {
                    await db.templates.clear();
                    await db.templates.bulkAdd(plantillasData);
                }
                
                console.log('‚úÖ Datos guardados en la base de datos');
            } catch (error) {
                console.error('‚ùå Error al guardar datos en la base de datos:', error);
            }
        }
        
        // üîç FUNCI√ìN PARA RECUPERAR DATOS DE M√âDICOS PERDIDOS
        function recoverLostDoctorData() {
            console.log('üîç Iniciando recuperaci√≥n de datos de m√©dicos perdidos...');
            
            // Fuentes posibles de datos
            const sources = [
                () => localStorage.getItem('doctorsData'),
                () => sessionStorage.getItem('doctorsData_backup'),
                () => {
                    const backup = JSON.parse(localStorage.getItem('doctorsBackup') || '{}');
                    return backup.data ? JSON.stringify(backup.data) : null;
                }
            ];
            
            // Buscar respaldos de emergencia
            const emergencyKeys = Object.keys(localStorage)
                .filter(key => key.startsWith('doctorsEmergencyBackup_'))
                .sort()
                .reverse();
            
            for (const key of emergencyKeys) {
                sources.push(() => localStorage.getItem(key));
            }
            
            const sessionEmergencyKeys = Object.keys(sessionStorage)
                .filter(key => key.startsWith('emergency_doctors_'))
                .sort()
                .reverse();
            
            for (const key of sessionEmergencyKeys) {
                sources.push(() => sessionStorage.getItem(key));
            }
            
            // Intentar recuperar de cada fuente
            for (const source of sources) {
                try {
                    const data = source();
                    if (data) {
                        const parsedData = JSON.parse(data);
                        if (Array.isArray(parsedData) && parsedData.length > 0) {
                            doctorsData = parsedData;
                            saveDoctorDataRobust();
                            populateDoctorsSelect();
                            console.log('‚úÖ Datos de m√©dicos recuperados exitosamente');
                            alert('‚úÖ Datos de m√©dicos recuperados: ' + doctorsData.length + ' m√©dicos restaurados');
                            return true;
                        }
                    }
                } catch (e) {
                    console.warn('‚ö†Ô∏è Error al intentar recuperar de fuente:', e);
                }
            }
            
            console.log('‚ÑπÔ∏è No se encontraron datos de m√©dicos para recuperar');
            alert('‚ÑπÔ∏è No se encontraron datos de m√©dicos para recuperar');
            return false;
        }
        
        // üíæ FUNCI√ìN PARA EXPORTAR DATOS DE M√âDICOS
        function exportDoctorData() {
            try {
                const dataStr = JSON.stringify(doctorsData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `doctors_backup_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                console.log('‚úÖ Datos de m√©dicos exportados');
                alert('‚úÖ Datos de m√©dicos exportados exitosamente');
            } catch (error) {
                console.error('‚ùå Error al exportar datos de m√©dicos:', error);
                alert('‚ùå Error al exportar datos de m√©dicos');
            }
        }
        
        // üì• FUNCI√ìN PARA IMPORTAR DATOS DE M√âDICOS
        function importDoctorData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (Array.isArray(data)) {
                            doctorsData = data;
                            saveDoctorDataRobust();
                            populateDoctorsSelect();
                            alert('‚úÖ Datos de m√©dicos importados: ' + doctorsData.length + ' m√©dicos restaurados');
                        } else {
                            alert('‚ùå Archivo inv√°lido: no contiene un array de datos');
                        }
                    } catch (error) {
                        console.error('‚ùå Error al importar datos de m√©dicos:', error);
                        alert('‚ùå Error al importar datos de m√©dicos: archivo inv√°lido');
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }
        
        // Funci√≥n para cargar todos los datos de forma robusta
        async function loadAllDataRobust() {
            try {
                // 1. Intentar cargar desde localStorage
                let surgical = JSON.parse(localStorage.getItem('surgicalData') || '[]');
                let cytological = JSON.parse(localStorage.getItem('cytologicalData') || '[]');
                let surgicalRep = JSON.parse(localStorage.getItem('surgicalReports') || '{}');
                let cytologicalRep = JSON.parse(localStorage.getItem('cytologicalReports') || '{}');
                let doctors = JSON.parse(localStorage.getItem('doctorsData') || '[]');
                // üì∑ CARGAR FOTOS GUARDADAS
                let photos = JSON.parse(localStorage.getItem('photoStorage') || '{}');
                
                // 2. Si localStorage est√° vac√≠o, intentar desde sessionStorage
                if (surgical.length === 0 && cytological.length === 0) {
                    surgical = JSON.parse(sessionStorage.getItem('surgicalData_backup') || '[]');
                    cytological = JSON.parse(sessionStorage.getItem('cytologicalData_backup') || '[]');
                    surgicalRep = JSON.parse(sessionStorage.getItem('surgicalReports_backup') || '{}');
                    cytologicalRep = JSON.parse(sessionStorage.getItem('cytologicalReports_backup') || '{}');
                    // üì∑ CARGAR FOTOS DESDE SESSION STORAGE SI NO HAY EN LOCAL STORAGE
                    if (Object.keys(photos).length === 0) {
                        photos = JSON.parse(sessionStorage.getItem('photoStorage_backup') || '{}');
                    }
                }
                
                // 3. Si a√∫n est√° vac√≠o, intentar desde IndexedDB
                if (surgical.length === 0 && cytological.length === 0 && db) {
                    surgical = await loadFromIndexedDB('surgicalData');
                    cytological = await loadFromIndexedDB('cytologicalData');
                    
                    const surgicalReportsArray = await loadFromIndexedDB('surgicalReports');
                    const cytologicalReportsArray = await loadFromIndexedDB('cytologicalReports');
                    
                    // üì∑ CARGAR FOTOS DESDE INDEXEDDB
                    if (Object.keys(photos).length === 0) {
                        const photoStorageArray = await loadFromIndexedDB('photoStorage');
                        photos = {};
                        photoStorageArray.forEach(item => {
                            if (item.codAtencion && item.photos) {
                                photos[item.codAtencion] = item.photos;
                            }
                        });
                    }
                    
                    // Convertir arrays a objetos
                    surgicalRep = {};
                    cytologicalRep = {};
                    surgicalReportsArray.forEach(item => {
                        const { codAtencion, ...data } = item;
                        surgicalRep[codAtencion] = data;
                    });
                    cytologicalReportsArray.forEach(item => {
                        const { codAtencion, ...data } = item;
                        cytologicalRep[codAtencion] = data;
                    });
                }
                
                // 4. Si a√∫n est√° vac√≠o, intentar √∫ltimo respaldo
                if (surgical.length === 0 && cytological.length === 0) {
                    const lastBackup = JSON.parse(localStorage.getItem('lastBackup') || '{}');
                    if (lastBackup.surgicalData) {
                        surgical = lastBackup.surgicalData;
                        cytological = lastBackup.cytologicalData;
                        surgicalRep = lastBackup.surgicalReports || {};
                        cytologicalRep = lastBackup.cytologicalReports || {};
                        doctors = lastBackup.doctorsData || [];
                        // üì∑ CARGAR FOTOS DESDE √öLTIMO RESPALDO
                        if (Object.keys(photos).length === 0) {
                            photos = lastBackup.photoStorage || {};
                        }
                    }
                }
                
                // 5. Asignar datos cargados
                surgicalData = surgical;
                cytologicalData = cytological;
                surgicalReports = surgicalRep;
                cytologicalReports = cytologicalRep;
                photoStorage = photos;
                
                // 6. üè• RECUPERACI√ìN ESPEC√çFICA DE DATOS DE M√âDICOS
                if (doctors.length === 0) {
                    console.log('üè• Intentando recuperaci√≥n de datos de m√©dicos...');
                    
                    // a. Intentar desde sessionStorage
                    doctors = JSON.parse(sessionStorage.getItem('doctorsData_backup') || '[]');
                    
                    // b. Intentar desde IndexedDB
                    if (doctors.length === 0 && db) {
                        doctors = await loadFromIndexedDB('doctorsData');
                    }
                    
                    // c. Intentar desde respaldo espec√≠fico
                    if (doctors.length === 0) {
                        const doctorBackup = JSON.parse(localStorage.getItem('doctorsBackup') || '{}');
                        if (doctorBackup.data) {
                            doctors = doctorBackup.data;
                            console.log('‚úÖ Datos de m√©dicos recuperados desde respaldo espec√≠fico');
                        }
                    }
                    
                    // d. Intentar desde respaldos de emergencia
                    if (doctors.length === 0) {
                        const emergencyKeys = Object.keys(localStorage)
                            .filter(key => key.startsWith('doctorsEmergencyBackup_'))
                            .sort()
                            .reverse();
                        
                        for (const key of emergencyKeys) {
                            try {
                                const emergencyData = JSON.parse(localStorage.getItem(key) || '{}');
                                if (emergencyData.data && emergencyData.data.length > 0) {
                                    doctors = emergencyData.data;
                                    console.log(`‚úÖ Datos de m√©dicos recuperados desde respaldo de emergencia: ${key}`);
                                    break;
                                }
                            } catch (e) {
                                console.warn(`‚ö†Ô∏è Error cargando respaldo de emergencia ${key}:`, e);
                            }
                        }
                    }
                    
                    // e. Intentar desde respaldos de emergencia en sessionStorage
                    if (doctors.length === 0) {
                        const emergencySessionKeys = Object.keys(sessionStorage)
                            .filter(key => key.startsWith('emergency_doctors_'))
                            .sort()
                            .reverse();
                        
                        for (const key of emergencySessionKeys) {
                            try {
                                const emergencyData = JSON.parse(sessionStorage.getItem(key) || '{}');
                                if (emergencyData.data && emergencyData.data.length > 0) {
                                    doctors = emergencyData.data;
                                    console.log(`‚úÖ Datos de m√©dicos recuperados desde respaldo de emergencia en sessionStorage: ${key}`);
                                    break;
                                }
                            } catch (e) {
                                console.warn(`‚ö†Ô∏è Error cargando respaldo de emergencia de sessionStorage ${key}:`, e);
                            }
                        }
                    }
                }
                
                // 7. Inicializar datos de m√©dicos con datos por defecto si siguen vac√≠os
                if (doctors.length === 0) {
                    doctorsData = [
                        { 
                            id: 1, 
                            nombreCompleto: "DR. CARLOS GONZ√ÅLEZ P√âREZ",
                            especialidad: "Patolog√≠a General", 
                            clinica: "Cl√≠nica Central",
                            fechaRegistro: new Date().toISOString()
                        },
                        { 
                            id: 2, 
                            nombreCompleto: "DRA. MAR√çA L√ìPEZ MART√çNEZ",
                            especialidad: "Citolog√≠a", 
                            clinica: "Cl√≠nica Norte",
                            fechaRegistro: new Date().toISOString()
                        }
                    ];
                } else {
                    doctorsData = doctors;
                }
                
                console.log('‚úÖ Datos cargados exitosamente:', {
                    surgical: surgicalData.length,
                    cytological: cytologicalData.length,
                    doctors: doctorsData.length,
                    surgicalReports: Object.keys(surgicalReports).length,
                    cytologicalReports: Object.keys(cytologicalReports).length,
                    // üì∑ INCLUIR INFORMACI√ìN DE FOTOS EN LOG
                    photos: Object.keys(photoStorage).length
                });
                
            } catch (error) {
                console.error('‚ùå Error al cargar datos:', error);
                // Inicializar con datos por defecto
                initializeDefaultData();
            }
        }
        
        // Crear respaldo de emergencia
        function createEmergencyBackup() {
            try {
                const emergencyData = {
                    timestamp: new Date().toISOString(),
                    emergency: true,
                    surgicalData,
                    cytologicalData,
                    surgicalReports,
                    cytologicalReports,
                    doctorsData,
                    // üì∑ INCLUIR FOTOS EN RESPALDO DE EMERGENCIA
                    photoStorage
                };
                
                // M√∫ltiples ubicaciones de respaldo
                localStorage.setItem('emergency_backup', JSON.stringify(emergencyData));
                sessionStorage.setItem('emergency_backup', JSON.stringify(emergencyData));
                
                // Respaldo en cookies como √∫ltima opci√≥n
                const cookieData = btoa(JSON.stringify(emergencyData));
                if (cookieData.length < 4000) { // L√≠mite de cookies
                    document.cookie = `jcpathlab_emergency=${cookieData}; expires=` + new Date(Date.now() + 86400000).toUTCString();
                }
                
                console.log('üÜò Respaldo de emergencia creado');
            } catch (error) {
                console.error('‚ùå Error en respaldo de emergencia:', error);
            }
        }
        
        // Inicializar datos por defecto
        function initializeDefaultData() {
            surgicalData = [];
            cytologicalData = [];
            surgicalReports = {};
            cytologicalReports = {};
            doctorsData = [
                { 
                    id: 1, 
                    nombreCompleto: "DR. CARLOS GONZ√ÅLEZ P√âREZ",
                    especialidad: "Patolog√≠a General", 
                    clinica: "Cl√≠nica Central",
                    fechaRegistro: new Date().toISOString()
                },
                { 
                    id: 2, 
                    nombreCompleto: "DRA. MAR√çA L√ìPEZ MART√çNEZ",
                    especialidad: "Citolog√≠a", 
                    clinica: "Cl√≠nica Norte",
                    fechaRegistro: new Date().toISOString()
                }
            ];
            plantillasData = [];
        }
        
        // üñ•Ô∏è FUNCI√ìN PARA OPTIMIZAR VISUALIZACI√ìN SEG√öN TAMA√ëO DE PANTALLA
        function optimizeScreenDisplay() {
            const screenWidth = window.innerWidth;
            const screenHeight = window.innerHeight;
            const container = document.querySelector('.container');
            const content = document.querySelector('.content');
            
            // Ajustar contenedor seg√∫n tama√±o de pantalla
            if (screenWidth >= 1920) {
                // Pantallas muy grandes (4K, Ultrawide)
                if (container) {
                    container.style.maxWidth = '1600px';
                    container.style.padding = '0 40px';
                }
                if (content) {
                    content.style.padding = '40px';
                }
            } else if (screenWidth >= 1400) {
                // Pantallas grandes
                if (container) {
                    container.style.maxWidth = '1400px';
                    container.style.padding = '0 30px';
                }
                if (content) {
                    content.style.padding = '35px';
                }
            } else if (screenWidth >= 1200) {
                // Pantallas medianas-grandes
                if (container) {
                    container.style.maxWidth = '1200px';
                    container.style.padding = '0 25px';
                }
            } else if (screenWidth >= 992) {
                // Laptop est√°ndar
                if (container) {
                    container.style.maxWidth = '100%';
                    container.style.padding = '0 20px';
                }
                if (content) {
                    content.style.padding = '25px';
                }
            }
            
            // Ajustar tablas para mejor visualizaci√≥n
            const tables = document.querySelectorAll('.results-table');
            tables.forEach(table => {
                if (screenWidth >= 1400) {
                    table.style.fontSize = '1rem';
                } else if (screenWidth >= 992) {
                    table.style.fontSize = '0.95rem';
                } else if (screenWidth >= 768) {
                    table.style.fontSize = '0.9rem';
                } else {
                    table.style.fontSize = '0.85rem';
                }
            });
            
            // Ajustar botones seg√∫n pantalla
            const buttons = document.querySelectorAll('.btn');
            buttons.forEach(btn => {
                if (screenWidth >= 1400) {
                    btn.style.padding = '15px 25px';
                    btn.style.fontSize = '1.1rem';
                } else if (screenWidth <= 480) {
                    btn.style.padding = '10px 15px';
                    btn.style.fontSize = '0.9rem';
                }
            });
            
            console.log(`üñ•Ô∏è Pantalla optimizada: ${screenWidth}x${screenHeight}px`);
        }
        
        // Funci√≥n para ajustar el layout en tiempo real
        function adjustLayoutRealTime() {
            // Optimizar al cargar
            optimizeScreenDisplay();
            
            // Optimizar al cambiar tama√±o de ventana
            let resizeTimeout;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(() => {
                    optimizeScreenDisplay();
                }, 250); // Debounce para mejor rendimiento
            });
            
            // Optimizar al cambiar orientaci√≥n (m√≥viles/tablets)
            window.addEventListener('orientationchange', () => {
                setTimeout(() => {
                    optimizeScreenDisplay();
                }, 300);
            });
        }
        function transferToPreliminario(codAtencion, tipo) {
            try {
                let pacienteData;
                let informeData;
                
                // Buscar datos del paciente
                if (tipo === 'surgical') {
                    pacienteData = surgicalData.find(p => p.codAtencion === codAtencion);
                    informeData = surgicalReports[codAtencion];
                } else {
                    pacienteData = cytologicalData.find(p => p.codAtencion === codAtencion);
                    informeData = cytologicalReports[codAtencion];
                }
                
                if (pacienteData) {
                    // üì∑ OBTENER FOTOS DEL ALMACENAMIENTO PERSISTENTE
                    const patientPhotos = photoStorage[codAtencion] || {};
                    
                    console.log('üì∑ DEBUG - C√≥digo de atenci√≥n:', codAtencion);
                    console.log('üì∑ DEBUG - photoStorage completo:', photoStorage);
                    console.log('üì∑ DEBUG - Fotos del paciente:', patientPhotos);
                    console.log('üì∑ DEBUG - Claves de fotos encontradas:', Object.keys(patientPhotos));
                    
                    // Validar que las fotos tengan datos v√°lidos
                    const validPhotos = {};
                    Object.keys(patientPhotos).forEach(photoKey => {
                        const photo = patientPhotos[photoKey];
                        if (photo && photo.dataURL && photo.dataURL.startsWith('data:image/')) {
                            validPhotos[photoKey] = photo;
                            console.log(`‚úÖ Foto v√°lida: ${photoKey}, tama√±o: ${photo.dataURL.length} caracteres`);
                        } else {
                            console.log(`‚ùå Foto inv√°lida: ${photoKey}`, photo);
                        }
                    });
                    
                    // üîÑ PREPARAR DATOS PARA INFORME PRELIMINAR CON SEGUIMIENTO DE ORIGEN
                    const preliminarData = {
                        ...pacienteData,
                        informe: informeData || {},
                        tipo: tipo,
                        timestamp: new Date().toISOString(),
                        // üì∑ INCLUIR FOTOS VALIDADAS EN LA TRANSFERENCIA
                        photos: validPhotos,
                        // üéØ INFORMACI√ìN DE SEGUIMIENTO PARA NAVEGACI√ìN INTELIGENTE
                        sourceType: tipo,
                        returnUrl: 'pagina2.html#ver-informe',
                        originalContext: {
                            codAtencion: codAtencion,
                            section: 'ver-informe',
                            reportType: tipo,
                            timestamp: new Date().toISOString()
                        }
                    };
                    
                    console.log('üì∑ Fotos v√°lidas encontradas para transferir:', Object.keys(validPhotos));
                    console.log('üì∑ DEBUG - Datos completos para preliminar:', preliminarData);
                    
                    // üíæ GUARDAR DATOS CON SISTEMA DE PERSISTENCIA ROBUSTO
                    localStorage.setItem('preliminar_current', JSON.stringify(preliminarData));
                    sessionStorage.setItem('preliminar_current', JSON.stringify(preliminarData));
                    
                    // üîÑ RESPALDO ADICIONAL PARA NAVEGACI√ìN
                    localStorage.setItem('preliminar_source', JSON.stringify({
                        sourceType: tipo,
                        returnUrl: 'pagina2.html#ver-informe',
                        codAtencion: codAtencion,
                        timestamp: new Date().toISOString()
                    }));
                    
                    console.log('‚úÖ Datos transferidos a informe preliminar con seguimiento de origen:', {
                        codigo: codAtencion,
                        tipo: tipo,
                        tieneInforme: !!informeData,
                        fotos: Object.keys(patientPhotos).length
                    });
                    return true;
                }
                
                return false;
            } catch (error) {
                console.error('‚ùå Error al transferir datos:', error);
                return false;
            }
        }
        
        // Funci√≥n para verificar el estado de los datos
        function verificarEstadoDatos() {
            console.log('=== ESTADO ACTUAL DE LOS DATOS ===');
            console.log('Datos quir√∫rgicos en memoria:', surgicalData.length);
            console.log('Datos citol√≥gicos en memoria:', cytologicalData.length);
            console.log('Datos quir√∫rgicos en localStorage:', JSON.parse(localStorage.getItem('surgicalData') || '[]').length);
            console.log('Datos citol√≥gicos en localStorage:', JSON.parse(localStorage.getItem('cytologicalData') || '[]').length);
            console.log('=====================================');
        }
        
        // Funci√≥n de respaldo autom√°tico para prevenir p√©rdida de datos
        function backupAutomatico() {
            try {
                // Crear respaldo con timestamp
                const timestamp = new Date().toISOString();
                const backup = {
                    timestamp: timestamp,
                    surgicalData: surgicalData,
                    cytologicalData: cytologicalData,
                    doctorsData: doctorsData,
                    plantillasData: plantillasData,
                    surgicalReports: surgicalReports,
                    cytologicalReports: cytologicalReports
                };
                
                // Guardar respaldo en localStorage
                localStorage.setItem('backup_' + timestamp, JSON.stringify(backup));
                
                // Mantener solo los √∫ltimos 5 respaldos
                const backupKeys = Object.keys(localStorage).filter(key => key.startsWith('backup_'));
                if (backupKeys.length > 5) {
                    backupKeys.sort();
                    const oldestBackup = backupKeys[0];
                    localStorage.removeItem(oldestBackup);
                }
                
                console.log('Respaldo autom√°tico creado:', timestamp);
            } catch (error) {
                console.error('Error en respaldo autom√°tico:', error);
            }
        }
        
        // Funci√≥n para mostrar u ocultar p√°ginas - CORREGIDA
        function showPage(pageId) {
            // Ocultar todas las p√°ginas
            document.querySelectorAll('.page-content').forEach(page => {
                page.classList.remove('active');
            });
            
            // Mostrar la p√°gina solicitada
            const pageElement = document.getElementById(pageId);
            if (pageElement) {
                pageElement.classList.add('active');
            }
            
            // Actualizar el t√≠tulo de la p√°gina
            const pageTitles = {
                'registro-pacientes': 'Registro de Pacientes',
                'registro-medicos': 'Registro de M√©dicos',
                'resultados-quirurgicos': 'Resultados Quir√∫rgicos',
                'resultados-citologicos': 'Resultados Citol√≥gicos',
                'plantillas': 'Plantillas',
                'ver-informe': 'Informe Patol√≥gico'
            };
            
            if (pageTitles[pageId]) {
                document.getElementById('page-title').textContent = pageTitles[pageId];
            }
            
            // Actualizar el men√∫ activo
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Solo activar el elemento del men√∫ si no es la p√°gina de informe
            if (pageId !== 'ver-informe') {
                const menuItem = document.querySelector(`.menu-item[data-link="${pageId}"]`);
                if (menuItem) {
                    menuItem.classList.add('active');
                }
            }
        }
        
        // Funci√≥n para cargar m√©dicos en el select
        function populateDoctorsSelect() {
            const input = document.getElementById('requesting-doctor');
            const datalist = document.getElementById('doctors-options');
            if (!input || !datalist) return;
            
            // Limpiar opciones existentes
            datalist.innerHTML = '';
            
            // Agregar todas las opciones de m√©dicos
            doctorsData.forEach(doctor => {
                const option = document.createElement('option');
                option.value = doctor.nombreCompleto;
                option.textContent = doctor.nombreCompleto;
                datalist.appendChild(option);
            });
        }

        // Funci√≥n mejorada para autocompletar en tiempo real
        function setupRealTimeAutocomplete() {
            const input = document.getElementById('requesting-doctor');
            const datalist = document.getElementById('doctors-options');
            
            if (!input || !datalist) return;
            
            // Escuchar eventos de entrada para filtrar en tiempo real
            input.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase().trim();
                
                // Limpiar opciones existentes
                datalist.innerHTML = '';
                
                // Si hay texto, filtrar las opciones
                if (searchTerm.length > 0) {
                    const filteredDoctors = doctorsData.filter(doctor => 
                        doctor.nombreCompleto.toLowerCase().includes(searchTerm)
                    );
                    
                    // Agregar las opciones filtradas
                    filteredDoctors.forEach(doctor => {
                        const option = document.createElement('option');
                        option.value = doctor.nombreCompleto;
                        option.textContent = doctor.nombreCompleto;
                        datalist.appendChild(option);
                    });
                } else {
                    // Si no hay texto, mostrar todas las opciones
                    doctorsData.forEach(doctor => {
                        const option = document.createElement('option');
                        option.value = doctor.nombreCompleto;
                        option.textContent = doctor.nombreCompleto;
                        datalist.appendChild(option);
                    });
                }
            });
        }

        // Funci√≥n para cargar m√©dicos en el select del informe
        function populateDoctorsSelectForInforme() {
            const select = document.getElementById('informe-medico');
            if (!select) return;
            
            select.innerHTML = '<option value="">Seleccionar m√©dico</option>';
            
            doctorsData.forEach(doctor => {
                const option = document.createElement('option');
                option.value = doctor.nombreCompleto;
                option.textContent = doctor.nombreCompleto;
                select.appendChild(option);
            });
        }
        
        // Funci√≥n para migrar datos de m√©dicos del formato anterior al nuevo
        function migrateDoctorsData() {
            if (!doctorsData || doctorsData.length === 0) return;
            
            let hasMigrated = false;
            
            doctorsData = doctorsData.map(doctor => {
                // Si el m√©dico tiene la estructura antigua (apellidos, nombres, sexo)
                if (doctor.apellidos && doctor.nombres && !doctor.nombreCompleto) {
                    console.log('üîÑ Migrando m√©dico:', doctor);
                    
                    // Determinar prefijo basado en sexo
                    const prefix = doctor.sexo === 'Femenino' ? 'DRA.' : 'DR.';
                    
                    // Crear nuevo formato
                    const migratedDoctor = {
                        id: doctor.id,
                        nombreCompleto: `${prefix} ${doctor.apellidos.toUpperCase()}, ${doctor.nombres.toUpperCase()}`,
                        especialidad: doctor.especialidad,
                        clinica: doctor.clinica,
                        fechaRegistro: doctor.fechaRegistro || new Date().toISOString()
                    };
                    
                    hasMigrated = true;
                    return migratedDoctor;
                }
                
                // Si ya tiene la estructura nueva, mantenerla
                return doctor;
            });
            
            if (hasMigrated) {
                // Guardar datos migrados
                localStorage.setItem('doctorsData', JSON.stringify(doctorsData));
                console.log('‚úÖ Migraci√≥n de datos de m√©dicos completada');
            }
        }
        
        // Configurar modal de m√©dicos
        function setupDoctorModal() {
            console.log('üîß Configurando modal de m√©dicos...');
            
            const modal = document.getElementById('doctor-modal');
            const closeBtn = document.getElementById('close-doctor-modal');
            const cancelBtn = document.getElementById('cancel-doctor-modal');
            const saveBtn = document.getElementById('save-doctor-modal');
            
            // Nuevos botones de recuperaci√≥n de datos
            const recoverBtn = document.getElementById('recover-doctor-data');
            const exportBtn = document.getElementById('export-doctor-data');
            const importBtn = document.getElementById('import-doctor-data');
            
            // Abrir modal
            const openBtn = document.getElementById('open-doctor-modal');
            const registerBtn = document.getElementById('register-doctor-now-btn');
            
            if (registerBtn) {
                registerBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    openDoctorModal();
                });
            }
            
            if (openBtn) {
                openBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    openDoctorModal();
                });
            }
            
            // Cerrar modal
            if (closeBtn) {
                closeBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    closeDoctorModal();
                });
            }
            
            if (cancelBtn) {
                cancelBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    closeDoctorModal();
                });
            }
            
            // Cerrar modal al hacer clic fuera
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closeDoctorModal();
                    }
                });
            }
            
            // Guardar m√©dico
            if (saveBtn) {
                saveBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    saveDoctorFromModal();
                });
            }
            
            // Event listeners para recuperaci√≥n de datos de m√©dicos
            if (recoverBtn) {
                recoverBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    if (confirm('¬øDesea intentar recuperar datos de m√©dicos perdidos?')) {
                        recoverLostDoctorData();
                    }
                });
            }
            
            if (exportBtn) {
                exportBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    exportDoctorData();
                });
            }
            
            if (importBtn) {
                importBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    importDoctorData();
                });
            }
            
            console.log('‚úÖ Modal de m√©dicos configurado correctamente');
        }
        
        // Funci√≥n para abrir el modal de registro de m√©dicos
        function openDoctorModal() {
            console.log('üîß Abriendo modal de m√©dicos...');
            const modal = document.getElementById('doctor-modal');
            
            if (!modal) {
                console.error('‚ùå Modal no encontrado');
                alert('Error: No se pudo encontrar el modal de registro');
                return;
            }
            
            console.log('‚úÖ Modal encontrado, limpiando formulario...');
            // Limpiar formulario
            const nameField = document.getElementById('doctor-name');
            const specialtyField = document.getElementById('doctor-specialty');
            const clinicField = document.getElementById('doctor-clinic');
            
            if (nameField) nameField.value = '';
            if (specialtyField) specialtyField.value = '';
            if (clinicField) clinicField.value = '';
            
            // Mostrar modal con estilos espec√≠ficos para asegurar visibilidad
            modal.style.display = 'flex';
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.zIndex = '9999';
            modal.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            
            console.log('‚úÖ Modal mostrado correctamente');
        }
        
        // Funci√≥n para cerrar el modal de registro de m√©dicos
        function closeDoctorModal() {
            const modal = document.getElementById('doctor-modal');
            modal.style.display = 'none';
        }
        
        // Funci√≥n para guardar m√©dico desde el modal
        function saveDoctorFromModal() {
            const name = document.getElementById('doctor-name').value.trim();
            const specialty = document.getElementById('doctor-specialty').value.trim();
            const clinic = document.getElementById('doctor-clinic').value.trim();
            
            // Validar campos requeridos
            if (!name || !specialty || !clinic) {
                alert('Por favor complete todos los campos');
                return;
            }
            
            // Crear objeto m√©dico con nueva estructura y timestamp √∫nico
            const newDoctor = {
                id: Date.now() + Math.random(), // ID √∫nico con timestamp + random
                nombreCompleto: name.toUpperCase(),
                especialidad: specialty,
                clinica: clinic,
                fechaRegistro: new Date().toISOString(),
                // Metadatos para integridad
                createdBy: 'system',
                checksum: btoa(name + specialty + clinic).substring(0, 16)
            };
            
            // A√±adir a la lista de m√©dicos
            if (!doctorsData) {
                doctorsData = [];
            }
            doctorsData.push(newDoctor);
            
            // üîÑ GUARDAR CON SISTEMA ROBUSTO DE PERSISTENCIA MULTICAPA
            saveDoctorDataRobust();
            
            // üîê Registrar acci√≥n de seguridad
            logSecurityAction('CREATE', 'DOCTOR', newDoctor.id);
            
            // Cargar m√©dicos en los selects
            populateDoctorsSelect();

            // Actualizar tabla de m√©dicos
            loadDoctorsTable();
            
            // Cerrar modal
            closeDoctorModal();
            
            // Mostrar mensaje de √©xito
            showSecurityAlert('M√©dico registrado correctamente con m√°xima seguridad', 'success');
            
            console.log('‚úÖ M√©dico registrado con persistencia robusta:', newDoctor);
        }
        
        // Funci√≥n para cargar la tabla de m√©dicos
        function loadDoctorsTable() {
            const tbody = document.querySelector('#medicos-results-table tbody');
            if (!tbody || !doctorsData) return;
            
            tbody.innerHTML = '';
            
            doctorsData.forEach((doctor, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${doctor.nombreCompleto}</td>
                    <td>${doctor.especialidad}</td>
                    <td>${doctor.clinica}</td>
                    <td>
                        <button class="modify-btn" title="Modificar m√©dico" onclick="editDoctor(${doctor.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                    </td>
                    <td>
                        <button class="delete-btn" title="Eliminar m√©dico" onclick="deleteDoctor(${doctor.id})">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Funci√≥n para eliminar m√©dico
        function deleteDoctor(id) {
            if (confirm('¬øEst√° seguro de que desea eliminar este m√©dico?')) {
                doctorsData = doctorsData.filter(doctor => doctor.id !== id);
                
                // üîÑ GUARDAR CON SISTEMA ROBUSTO DE PERSISTENCIA MULTICAPA
                saveDoctorDataRobust();
                
                // üîê Registrar acci√≥n de seguridad
                logSecurityAction('DELETE', 'DOCTOR', id);
                
                loadDoctorsTable();
                populateDoctorsSelect();
                console.log('‚úÖ M√©dico eliminado con persistencia robusta con ID:', id);
                
                showSecurityAlert('M√©dico eliminado correctamente con m√°xima seguridad', 'success');
            }
        }
        
        // Funci√≥n para editar m√©dico
        function editDoctor(id) {
            const doctor = doctorsData.find(d => d.id === id);
            if (doctor) {
                document.getElementById('doctor-name').value = doctor.nombreCompleto;
                document.getElementById('doctor-specialty').value = doctor.especialidad;
                document.getElementById('doctor-clinic').value = doctor.clinica;
                
                // Cambiar el bot√≥n de guardar para actualizar
                const saveBtn = document.getElementById('save-doctor-modal');
                saveBtn.textContent = 'Actualizar M√©dico';
                saveBtn.onclick = function() {
                    updateDoctorFromModal(id);
                };
                
                openDoctorModal();
            }
        }
        
        // Funci√≥n para actualizar m√©dico desde el modal
        function updateDoctorFromModal(id) {
            const name = document.getElementById('doctor-name').value.trim();
            const specialty = document.getElementById('doctor-specialty').value.trim();
            const clinic = document.getElementById('doctor-clinic').value.trim();
            
            if (!name || !specialty || !clinic) {
                alert('Por favor complete todos los campos');
                return;
            }
            
            const doctorIndex = doctorsData.findIndex(d => d.id === id);
            if (doctorIndex !== -1) {
                // Actualizar datos con metadatos de integridad
                doctorsData[doctorIndex].nombreCompleto = name.toUpperCase();
                doctorsData[doctorIndex].especialidad = specialty;
                doctorsData[doctorIndex].clinica = clinic;
                doctorsData[doctorIndex].lastModified = new Date().toISOString();
                doctorsData[doctorIndex].checksum = btoa(name + specialty + clinic).substring(0, 16);
                
                // üîÑ GUARDAR CON SISTEMA ROBUSTO DE PERSISTENCIA MULTICAPA
                saveDoctorDataRobust();
                
                // üîê Registrar acci√≥n de seguridad
                logSecurityAction('UPDATE', 'DOCTOR', id);
                
                loadDoctorsTable();
                populateDoctorsSelect();
                closeDoctorModal();
                
                // Restaurar bot√≥n de guardar
                const saveBtn = document.getElementById('save-doctor-modal');
                saveBtn.textContent = 'Guardar M√©dico';
                saveBtn.onclick = saveDoctorFromModal;
                
                showSecurityAlert('M√©dico actualizado correctamente con m√°xima seguridad', 'success');
                console.log('‚úÖ M√©dico actualizado con persistencia robusta:', doctorsData[doctorIndex]);
            }
        }
        function limpiarFormularioRegistro() {
            // Limpiar todos los campos del formulario
            document.getElementById('service-type').value = '';
            document.getElementById('attention-code').value = '';
            document.getElementById('dni').value = '';
            document.getElementById('age').value = '';
            document.getElementById('first-name').value = '';
            document.getElementById('last-name').value = '';
            document.getElementById('phone').value = '';
            document.getElementById('gender').value = '';
            document.getElementById('contact-date').value = '';
            document.getElementById('contact-phone').value = '';
            document.getElementById('requesting-doctor').value = '';
            document.getElementById('study-reason').value = '';
            document.getElementById('clinic').value = '';
            
            // Resetear estilos de validaci√≥n
            document.querySelectorAll('input, select, textarea').forEach(field => {
                field.style.borderColor = '#e0e0e0';
            });
            
            // üî¢ REINICIALIZAR VALIDACI√ìN DE DNI DESPU√âS DE LIMPIAR
            setTimeout(() => {
                initializeDNIValidation();
            }, 100);
            
            // Limpiar el √°rea de subida de archivos si existe
            const fileUpload = document.querySelector('#orden-servicio-upload');
            if (fileUpload) {
                fileUpload.innerHTML = `
                    <i class="fas fa-cloud-upload-alt"></i>
                    <div class="file-text">Elegir archivos (JPG)</div>
                    <div class="file-text">Ning√∫n archivo seleccionado</div>
                `;
                fileUpload.style.borderColor = '#ccc';
                fileUpload.style.backgroundColor = '#f9f9f9';
            }
            
            // Ocultar mensajes de confirmaci√≥n y duplicado
            document.getElementById('confirmation-message').style.display = 'none';
            document.getElementById('duplicate-message').style.display = 'none';
        }
        
        // Funci√≥n para guardar paciente - CORREGIDA
        function guardarPaciente() {
            const serviceType = document.getElementById('service-type').value;
            const codAtencion = document.getElementById('attention-code').value;
            const dni = document.getElementById('dni').value;
            const edad = document.getElementById('age').value;
            const apellidos = document.getElementById('last-name').value;
            const nombres = document.getElementById('first-name').value;
            const telefono = document.getElementById('phone').value;
            const sexo = document.getElementById('gender').value;
            const contactoFamiliar = document.getElementById('contact-date').value;
            const telefonoContacto = document.getElementById('contact-phone').value;
            const medicoSolicitante = document.getElementById('requesting-doctor').value;
            const motivoEstudio = document.getElementById('study-reason').value;
            const clinica = document.getElementById('clinic').value;
            
            // Validar campos obligatorios
            if (!serviceType || !codAtencion || !dni || !apellidos || !nombres) {
                showSecurityAlert('Por favor complete todos los campos obligatorios');
                return;
            }
            
            // üîê Verificar permisos de creaci√≥n
            if (!hasPermission('create')) {
                showSecurityAlert('No tiene permisos para crear nuevos registros');
                return;
            }
            
            // üîê Verificar integridad de datos antes de agregar
            if (!verifyDataIntegrity()) {
                showSecurityAlert('Error de integridad de datos. Operaci√≥n cancelada.');
                return;
            }
            
            // Crear objeto con datos del paciente
            const paciente = {
                codAtencion,
                dni,
                edad,
                apellidos,
                nombres,
                telefono,
                sexo,
                contactoFamiliar,
                telefonoContacto,
                medicoSolicitante,
                motivoEstudio,
                clinica,
                serviceType,
                fechaRegistro: formatDate(new Date()) // Formato dd-mm-aaaa
            };
            
            // Guardar seg√∫n el tipo de servicio
            if (serviceType === 'hematoxilina') {
                // Verificar si ya existe el c√≥digo de atenci√≥n
                const existe = surgicalData.some(p => p.codAtencion === codAtencion);
                if (existe) {
                    document.getElementById('duplicate-message').style.display = 'block';
                    document.getElementById('confirmation-message').style.display = 'none';
                    return;
                }
                
                surgicalData.push(paciente);
                
                // Actualizar la tabla de resultados quir√∫rgicos inmediatamente
                cargarResultadosQuirurgicos();
                
            } else if (serviceType === 'citologia') {
                // Verificar si ya existe el c√≥digo de atenci√≥n
                const existe = cytologicalData.some(p => p.codAtencion === codAtencion);
                if (existe) {
                    document.getElementById('duplicate-message').style.display = 'block';
                    document.getElementById('confirmation-message').style.display = 'none';
                    return;
                }
                
                cytologicalData.push(paciente);
                
                // Actualizar la tabla de resultados citol√≥gicos inmediatamente
                cargarResultadosCitologicos();
            }
            
            // üîÑ GUARDAR CON SISTEMA ROBUSTO DE PERSISTENCIA
            saveAllDataRobust();
            
            // üîê Registrar acci√≥n de seguridad
            logSecurityAction('CREATE', 'PACIENTE', codAtencion);
            
            // Actualizar checksum de integridad
            protectDataIntegrity();
            
            // Mostrar mensaje de confirmaci√≥n
            showSecurityAlert('Paciente registrado correctamente', 'success');
            document.getElementById('confirmation-message').style.display = 'block';
            document.getElementById('duplicate-message').style.display = 'none';
            
            // Limpiar formulario inmediatamente despu√©s de guardar
            limpiarFormularioRegistro();
            
            // Ocultar mensaje despu√©s de 3 segundos
            setTimeout(() => {
                document.getElementById('confirmation-message').style.display = 'none';
            }, 3000);
        }
        
        // Funci√≥n para cargar datos en la tabla de resultados quir√∫rgicos
        function cargarResultadosQuirurgicos() {
            const tableBody = document.querySelector('#surgical-results-table tbody');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            surgicalData.forEach((paciente, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${paciente.codAtencion}</td>
                    <td>${paciente.dni}</td>
                    <td>${paciente.edad}</td>
                    <td>${paciente.apellidos}</td>
                    <td>${paciente.nombres}</td>
                    <td>${paciente.sexo}</td>
                    <td>${paciente.medicoSolicitante}</td>
                    <td>${paciente.clinica}</td>
                    <td>${paciente.fechaRegistro}</td>
                    <td>-</td>
                    <td>
                        <button class="informe-btn" onclick="mostrarInforme('${paciente.codAtencion}', 'surgical')">
                            <i class="fas fa-file-medical"></i> Ver Informe
                        </button>
                    </td>
                    <td>
                        <button class="delete-btn" onclick="eliminarPaciente('${paciente.codAtencion}', 'surgical')">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        // Funci√≥n para cargar datos en la tabla de resultados citol√≥gicos
        function cargarResultadosCitologicos() {
            const tableBody = document.querySelector('#cytological-results-table tbody');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            if (cytologicalData.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="13" style="text-align: center;">No hay resultados citol√≥gicos registrados</td></tr>';
                return;
            }
            
            cytologicalData.forEach((paciente, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${paciente.codAtencion}</td>
                    <td>${paciente.dni}</td>
                    <td>${paciente.edad}</td>
                    <td>${paciente.apellidos}</td>
                    <td>${paciente.nombres}</td>
                    <td>${paciente.sexo}</td>
                    <td>${paciente.medicoSolicitante}</td>
                    <td>${paciente.clinica}</td>
                    <td>${paciente.fechaRegistro}</td>
                    <td>-</td>
                    <td>
                        <button class="informe-btn" onclick="mostrarInforme('${paciente.codAtencion}', 'cytological')">
                            <i class="fas fa-file-medical"></i> Ver Informe
                        </button>
                    </td>
                    <td>
                        <button class="delete-btn" onclick="eliminarPaciente('${paciente.codAtencion}', 'cytological')">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        // üì∑ FUNCI√ìN PARA INICIALIZAR EL SISTEMA DE FOTOS
        function initializePhotoSystem() {
            console.log('üì∑ Inicializando sistema de fotos...');
            
            // Agregar animaciones CSS para toast notifications
            const toastStyle = document.createElement('style');
            toastStyle.textContent = `
                @keyframes slideIn {
                    from {
                        transform: translateX(100%);
                        opacity: 0;
                    }
                    to {
                        transform: translateX(0);
                        opacity: 1;
                    }
                }
                
                @keyframes slideOut {
                    from {
                        transform: translateX(0);
                        opacity: 1;
                    }
                    to {
                        transform: translateX(100%);
                        opacity: 0;
                    }
                }
            `;
            document.head.appendChild(toastStyle);
            
            console.log('‚úÖ Sistema de fotos inicializado');
        }
        
        // Funci√≥n para mostrar el informe
        function mostrarInforme(codAtencion, tipo) {
            let paciente;
            if (tipo === 'surgical') {
                paciente = surgicalData.find(p => p.codAtencion === codAtencion);
            } else {
                paciente = cytologicalData.find(p => p.codAtencion === codAtencion);
            }
            
            if (paciente) {
                // Usar la nueva funci√≥n de cambio de paciente
                switchToPatient(codAtencion, tipo);
                
                // Llenar los campos del formulario de informe
                document.getElementById('informe-cod-atencion').textContent = paciente.codAtencion;
                document.getElementById('informe-dni').value = paciente.dni;
                
                // Fix sexo field - convert to uppercase for matching
                const sexoValue = paciente.sexo ? paciente.sexo.toLowerCase() : '';
                const sexoSelect = document.getElementById('informe-sexo');
                for (let i = 0; i < sexoSelect.options.length; i++) {
                    if (sexoSelect.options[i].value.toLowerCase() === sexoValue) {
                        sexoSelect.selectedIndex = i;
                        break;
                    }
                }
                
                document.getElementById('informe-apellidos').value = paciente.apellidos;
                document.getElementById('informe-nombres').value = paciente.nombres;
                document.getElementById('informe-edad').value = paciente.edad;
                document.getElementById('informe-telefono').value = paciente.telefono;
                document.getElementById('informe-contacto').value = paciente.contactoFamiliar;
                document.getElementById('informe-tel-contacto').value = paciente.telefonoContacto;
                document.getElementById('informe-clinica').value = paciente.clinica;
                
                // Cargar m√©dicos en el select y seleccionar el m√©dico correspondiente
                populateDoctorsSelectForInforme();
                if (paciente.medicoSolicitante) {
                    const medicoSelect = document.getElementById('informe-medico');
                    for (let i = 0; i < medicoSelect.options.length; i++) {
                        if (medicoSelect.options[i].value === paciente.medicoSolicitante) {
                            medicoSelect.selectedIndex = i;
                            break;
                        }
                    }
                }
                
                document.getElementById('informe-motivo').value = paciente.motivoEstudio;
                
                // Calcular fecha de entrega (2 d√≠as despu√©s)
                const fechaReg = new Date(paciente.fechaRegistro.split('-').reverse().join('-')); // Convertir a formato v√°lido
                fechaReg.setDate(fechaReg.getDate() + 2);
                document.getElementById('fecha-entrega').textContent = formatDate(fechaReg);
                
                // Mostrar fecha de registro en formato d√≠a-mes-a√±o
                const fechaRegistroFormateada = formatDate(new Date(paciente.fechaRegistro.split('-').reverse().join('-')));
                document.getElementById('fecha-registro').textContent = fechaRegistroFormateada;
                
                // üì∑ CARGAR FOTOS GUARDADAS
                setTimeout(() => {
                    loadSavedPhotos();
                }, 100);
                
                // üìù CARGAR INFORME GUARDADO SI EXISTE
                setTimeout(() => {
                    cargarInformeGuardado();
                }, 200);
                
                // Mostrar la p√°gina de informe
                showPage('ver-informe');
                
                console.log(`‚úÖ Informe cargado: ${codAtencion} (${tipo}) con fotos`);
            }
        }
        
        // Funci√≥n para cargar informe guardado
        function cargarInformeGuardado() {
            if (!currentCodAtencion || !currentReportType) return;
            
            let informeData = null;
            if (currentReportType === 'surgical') {
                informeData = surgicalReports[currentCodAtencion];
            } else if (currentReportType === 'cytological') {
                informeData = cytologicalReports[currentCodAtencion];
            }
            
            if (informeData) {
                document.getElementById('macro-editor').innerHTML = informeData.macro || '';
                document.getElementById('micro-editor').innerHTML = informeData.micro || '';
                document.getElementById('diagnostico-editor').innerHTML = informeData.diagnostico || '';
            }
        }
        
        // Funci√≥n para guardar informe - MEJORADA CON SEGURIDAD Y PERSISTENCIA ROBUSTA
        function guardarInforme() {
            // Verificar permisos de escritura
            if (!hasPermission('save')) {
                showSecurityAlert('No tiene permisos para guardar informes');
                return;
            }
            
            if (!currentCodAtencion || !currentReportType) {
                showSecurityAlert('Error: No hay paciente seleccionado');
                return;
            }
            
            const informeData = {
                macro: getFormattedContent('macro-editor'),
                micro: getFormattedContent('micro-editor'),
                diagnostico: getFormattedContent('diagnostico-editor'),
                fechaGuardado: new Date().toISOString(),
                // üîê Agregar metadatos de seguridad
                lastModifiedBy: currentUser.username,
                securityToken: securityToken
            };
            
            // Validar que al menos uno de los campos tenga contenido
            const hasContent = informeData.macro.trim() || informeData.micro.trim() || informeData.diagnostico.trim();
            if (!hasContent) {
                showSecurityAlert('Por favor ingrese al menos una descripci√≥n antes de guardar');
                return;
            }
            
            if (currentReportType === 'surgical') {
                surgicalReports[currentCodAtencion] = informeData;
            } else if (currentReportType === 'cytological') {
                cytologicalReports[currentCodAtencion] = informeData;
            }
            
            // üì∑ ASEGURAR PERSISTENCIA DE FOTOS
            const currentPhotos = photoStorage[currentCodAtencion] || {};
            if (Object.keys(currentPhotos).length > 0) {
                console.log(`üì∑ Guardando ${Object.keys(currentPhotos).length} fotos para ${currentCodAtencion}`);
                localStorage.setItem('photoStorage', JSON.stringify(photoStorage));
            }
            
            // üîÑ GUARDAR CON SISTEMA ROBUSTO DE PERSISTENCIA
            saveAllDataRobust();
            
            // üîê Registrar acci√≥n de seguridad
            logSecurityAction('SAVE', 'INFORME', currentCodAtencion);
            
            // Actualizar checksum de integridad
            protectDataIntegrity();
            
            // Mostrar mensaje de √©xito con detalles
            const photoCount = Object.keys(currentPhotos).length;
            const successMessage = `Informe guardado correctamente\n‚úÖ Datos: Macro, Micro, Diagn√≥stico\nüì∑ Fotos: ${photoCount} imagen${photoCount !== 1 ? 'es' : ''}`;
            showSecurityAlert(successMessage, 'success');
            
            console.log('‚úÖ Informe guardado con seguridad:', {
                codigo: currentCodAtencion,
                tipo: currentReportType,
                fotos: photoCount,
                usuario: currentUser.username,
                contenido: {
                    macro: !!informeData.macro.trim(),
                    micro: !!informeData.micro.trim(),
                    diagnostico: !!informeData.diagnostico.trim()
                }
            });
        }
        
        // Funci√≥n para eliminar paciente - MEJORADA CON SISTEMA DE SEGURIDAD ROBUSTO
        function eliminarPaciente(codAtencion, tipo) {
            // Usar sistema de eliminaci√≥n segura
            secureDelete('paciente', codAtencion, () => {
                if (tipo === 'surgical') {
                    surgicalData = surgicalData.filter(p => p.codAtencion !== codAtencion);
                    // Eliminar informe asociado
                    delete surgicalReports[codAtencion];
                    cargarResultadosQuirurgicos();
                } else {
                    cytologicalData = cytologicalData.filter(p => p.codAtencion !== codAtencion);
                    // Eliminar informe asociado
                    delete cytologicalReports[codAtencion];
                    cargarResultadosCitologicos();
                }
                
                // üì∑ Eliminar fotos asociadas
                if (photoStorage[codAtencion]) {
                    delete photoStorage[codAtencion];
                    localStorage.setItem('photoStorage', JSON.stringify(photoStorage));
                }
                
                // üîÑ GUARDAR CON SISTEMA ROBUSTO DE PERSISTENCIA
                saveAllDataRobust();
                
                // Actualizar checksum de integridad
                protectDataIntegrity();
                
                console.log('‚úÖ Paciente eliminado y cambios persistidos con seguridad');
            });
        }
        
        // Funci√≥n para aplicar formato de texto
        function formatDoc(command, value = null) {
            document.execCommand(command, false, value);
        }
        
        // Funci√≥n para obtener el contenido HTML con formato preservado
        function getFormattedContent(editorId) {
            const editor = document.getElementById(editorId);
            if (!editor) return '';
            
            // Obtener el HTML sin procesar pero limpiar elementos peligrosos
            let content = editor.innerHTML || '';
            
            // Limpiar solo elementos peligrosos pero preservar formato
            content = content
                .replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '') // Remover scripts
                .replace(/<iframe\b[^<]*(?:(?!<\/iframe>)<[^<]*)*<\/iframe>/gi, '') // Remover iframes
                .replace(/<object\b[^<]*(?:(?!<\/object>)<[^<]*)*<\/object>/gi, '') // Remover objetos
                .replace(/<embed\b[^<]*(?:(?!<\/embed>)<[^<]*)*<\/embed>/gi, '') // Remover embeds
                .replace(/<form\b[^<]*(?:(?!<\/form>)<[^<]*)*<\/form>/gi, '') // Remover formularios
                .replace(/javascript:/gi, '') // Remover javascript: URLs
                .replace(/data:/gi, '') // Remover data: URLs potencialmente peligrosas
                .replace(/on\w+="[^"]*"/gi, '') // Remover event handlers
                .replace(/on\w+='[^']*'/gi, ''); // Remover event handlers con comillas simples
            
            // Asegurarse de que el HTML sea v√°lido
            const tempContainer = document.createElement('div');
            tempContainer.innerHTML = content;
            
            // Recorrer todos los elementos y limpiar atributos peligrosos
            const allElements = tempContainer.querySelectorAll('*');
            allElements.forEach(element => {
                // Remover atributos peligrosos
                Array.from(element.attributes).forEach(attr => {
                    if (attr.name.startsWith('on') || 
                        attr.name === 'src' && attr.value.startsWith('javascript:') ||
                        attr.name === 'href' && attr.value.startsWith('javascript:')) {
                        element.removeAttribute(attr.name);
                    }
                });
            });
            
            return tempContainer.innerHTML;
        }
        
        // Funci√≥n para abrir el modal de recorte de foto
        function openCropModal(photoId) {
            currentPhotoId = photoId;
            
            // Disparar el input file
            const fileInput = document.getElementById(`photo-input-${photoId}`);
            fileInput.click();
        }
        
        // Funci√≥n para manejar la selecci√≥n de foto
        function handlePhotoSelect(input, photoId) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                
                // Verificar que sea una imagen JPG
                if (!file.type.match('image/jpeg')) {
                    alert('Por favor, seleccione solo archivos JPG.');
                    return;
                }
                
                // Verificar tama√±o del archivo (m√°ximo 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    alert('El archivo es demasiado grande. Por favor, seleccione una imagen menor a 5MB.');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    originalImage = new Image();
                    originalImage.src = e.target.result;
                    originalImage.onload = function() {
                        // Mostrar el modal de recorte
                        document.getElementById('crop-modal').style.display = 'flex';
                        
                        // Mostrar la imagen en el modal de recorte
                        const cropPreview = document.getElementById('crop-preview');
                        cropPreview.src = e.target.result;
                        
                        // Esperar a que la imagen se cargue en el DOM
                        setTimeout(() => {
                            initCropBox();
                        }, 100);
                    };
                };
                reader.readAsDataURL(file);
            }
        }
        
        // Funci√≥n para inicializar el cuadro de recorte MEJORADA
        function initCropBox() {
            const cropArea = document.getElementById('crop-area');
            const cropPreview = document.getElementById('crop-preview');
            cropBox = document.getElementById('crop-box');
            
            if (!cropArea || !cropPreview || !cropBox) {
                console.error('Elementos del crop no encontrados');
                return;
            }
            
            // Esperar a que la imagen se renderice completamente
            setTimeout(() => {
                // Calcular el tama√±o disponible
                const areaRect = cropArea.getBoundingClientRect();
                const imgRect = cropPreview.getBoundingClientRect();
                
                // Tama√±o inicial del cuadro de recorte (cuadrado)
                const initialSize = Math.min(imgRect.width, imgRect.height) * 0.6;
                
                // Posicionar el cuadro de recorte en el centro de la imagen
                const centerX = (areaRect.width - initialSize) / 2;
                const centerY = (areaRect.height - initialSize) / 2;
                
                // Configurar el cuadro de recorte
                cropBox.style.width = initialSize + 'px';
                cropBox.style.height = initialSize + 'px';
                cropBox.style.left = centerX + 'px';
                cropBox.style.top = centerY + 'px';
                cropBox.style.display = 'block';
                
                console.log('‚úÖ Cuadro de recorte inicializado:', {
                    size: initialSize,
                    x: centerX,
                    y: centerY
                });
                
                // Configurar eventos de interacci√≥n
                setupCropInteractions();
                
            }, 200);
        }
        
        // Funci√≥n para configurar las interacciones del cuadro de recorte
        function setupCropInteractions() {
            const cropHandle = document.getElementById('crop-handle');
            
            // Eventos para arrastrar el cuadro
            cropBox.addEventListener('mousedown', startDragging);
            
            // Eventos para redimensionar con el controlador
            if (cropHandle) {
                cropHandle.addEventListener('mousedown', startResizing);
            }
            
            // Eventos para dispositivos t√°ctiles
            cropBox.addEventListener('touchstart', startDragging);
            if (cropHandle) {
                cropHandle.addEventListener('touchstart', startResizing);
            }
        }
        
        // Funci√≥n para iniciar el arrastre MEJORADA
        function startDragging(e) {
            e.preventDefault();
            e.stopPropagation();
            
            // No arrastrar si se est√° redimensionando
            if (isResizing) return;
            
            isDragging = true;
            
            // Obtener posici√≥n inicial
            const clientX = e.clientX || (e.touches && e.touches[0].clientX);
            const clientY = e.clientY || (e.touches && e.touches[0].clientY);
            
            dragStartX = clientX;
            dragStartY = clientY;
            originalBoxX = cropBox.offsetLeft;
            originalBoxY = cropBox.offsetTop;
            
            // Agregar eventos de movimiento y fin de arrastre
            document.addEventListener('mousemove', handleDragging);
            document.addEventListener('mouseup', stopDragging);
            document.addEventListener('touchmove', handleDragging, { passive: false });
            document.addEventListener('touchend', stopDragging);
            
            // Cambiar cursor
            document.body.style.cursor = 'grabbing';
            cropBox.style.cursor = 'grabbing';
        }
        
        // Funci√≥n para manejar el arrastre
        function handleDragging(e) {
            if (!isDragging) return;
            
            e.preventDefault();
            
            const clientX = e.clientX || (e.touches && e.touches[0].clientX);
            const clientY = e.clientY || (e.touches && e.touches[0].clientY);
            
            // Calcular nueva posici√≥n
            const deltaX = clientX - dragStartX;
            const deltaY = clientY - dragStartY;
            
            let newX = originalBoxX + deltaX;
            let newY = originalBoxY + deltaY;
            
            // Obtener l√≠mites del √°rea de recorte
            const cropArea = document.getElementById('crop-area');
            const cropPreview = document.getElementById('crop-preview');
            
            if (!cropArea || !cropPreview) return;
            
            const areaRect = cropArea.getBoundingClientRect();
            const imgRect = cropPreview.getBoundingClientRect();
            
            // Calcular l√≠mites basados en la imagen
            const imgLeft = imgRect.left - areaRect.left;
            const imgTop = imgRect.top - areaRect.top;
            const imgRight = imgLeft + imgRect.width;
            const imgBottom = imgTop + imgRect.height;
            
            // Aplicar restricciones para mantener el cuadro dentro de la imagen
            const boxWidth = cropBox.offsetWidth;
            const boxHeight = cropBox.offsetHeight;
            
            newX = Math.max(imgLeft, Math.min(newX, imgRight - boxWidth));
            newY = Math.max(imgTop, Math.min(newY, imgBottom - boxHeight));
            
            // Aplicar nueva posici√≥n
            cropBox.style.left = newX + 'px';
            cropBox.style.top = newY + 'px';
        }
        
        // Funci√≥n para detener el arrastre
        function stopDragging() {
            isDragging = false;
            
            // Remover eventos
            document.removeEventListener('mousemove', handleDragging);
            document.removeEventListener('mouseup', stopDragging);
            document.removeEventListener('touchmove', handleDragging);
            document.removeEventListener('touchend', stopDragging);
            
            // Restaurar cursor
            document.body.style.cursor = '';
            cropBox.style.cursor = 'move';
        }
        
        // Funci√≥n para iniciar el redimensionamiento MEJORADA
        function startResizing(e) {
            e.preventDefault();
            e.stopPropagation();
            
            isResizing = true;
            
            const clientX = e.clientX || (e.touches && e.touches[0].clientX);
            const clientY = e.clientY || (e.touches && e.touches[0].clientY);
            
            dragStartX = clientX;
            dragStartY = clientY;
            
            // Agregar eventos de redimensionamiento
            document.addEventListener('mousemove', handleResizing);
            document.addEventListener('mouseup', stopResizing);
            document.addEventListener('touchmove', handleResizing, { passive: false });
            document.addEventListener('touchend', stopResizing);
            
            // Cambiar cursor
            document.body.style.cursor = 'nwse-resize';
        }
        
        // Funci√≥n para manejar el redimensionamiento PROPORCIONAL
        function handleResizing(e) {
            if (!isResizing) return;
            
            e.preventDefault();
            
            const clientX = e.clientX || (e.touches && e.touches[0].clientX);
            const clientY = e.clientY || (e.touches && e.touches[0].clientY);
            
            // Calcular cambio en el tama√±o (usar la distancia m√°xima para mantener proporci√≥n)
            const deltaX = clientX - dragStartX;
            const deltaY = clientY - dragStartY;
            const delta = Math.max(deltaX, deltaY); // Usar el cambio mayor para mantener cuadrado
            
            const currentSize = cropBox.offsetWidth;
            let newSize = currentSize + delta;
            
            // Tama√±o m√≠nimo y m√°ximo
            const minSize = 50;
            
            // Obtener l√≠mites basados en la imagen y posici√≥n actual
            const cropArea = document.getElementById('crop-area');
            const cropPreview = document.getElementById('crop-preview');
            
            if (!cropArea || !cropPreview) return;
            
            const areaRect = cropArea.getBoundingClientRect();
            const imgRect = cropPreview.getBoundingClientRect();
            
            // Calcular tama√±o m√°ximo basado en la posici√≥n actual
            const imgLeft = imgRect.left - areaRect.left;
            const imgTop = imgRect.top - areaRect.top;
            const imgRight = imgLeft + imgRect.width;
            const imgBottom = imgTop + imgRect.height;
            
            const currentLeft = cropBox.offsetLeft;
            const currentTop = cropBox.offsetTop;
            
            const maxSizeX = imgRight - currentLeft;
            const maxSizeY = imgBottom - currentTop;
            const maxSize = Math.min(maxSizeX, maxSizeY);
            
            // Aplicar restricciones
            newSize = Math.max(minSize, Math.min(newSize, maxSize));
            
            // Aplicar nuevo tama√±o (manteniendo proporci√≥n cuadrada)
            cropBox.style.width = newSize + 'px';
            cropBox.style.height = newSize + 'px';
            
            // Actualizar punto de referencia para el siguiente movimiento
            dragStartX = clientX;
            dragStartY = clientY;
        }
        
        // Funci√≥n para detener el redimensionamiento
        function stopResizing() {
            isResizing = false;
            
            // Remover eventos
            document.removeEventListener('mousemove', handleResizing);
            document.removeEventListener('mouseup', stopResizing);
            document.removeEventListener('touchmove', handleResizing);
            document.removeEventListener('touchend', stopResizing);
            
            // Restaurar cursor
            document.body.style.cursor = '';
        }
        
        // Funci√≥n para guardar el recorte MEJORADA
        function saveCrop() {
            if (!originalImage || !cropBox) {
                alert('Error: No se puede guardar el recorte. Intente de nuevo.');
                return;
            }
            
            try {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // Tama√±o de recorte deseado (alta calidad)
                const outputSize = 400; // Aumentado para mejor calidad
                
                // Establecer el tama√±o del canvas
                canvas.width = outputSize;
                canvas.height = outputSize;
                
                // Obtener elementos necesarios
                const cropArea = document.getElementById('crop-area');
                const cropPreview = document.getElementById('crop-preview');
                
                if (!cropArea || !cropPreview) {
                    throw new Error('Elementos del crop no encontrados');
                }
                
                // Calcular factores de escala
                const imgRect = cropPreview.getBoundingClientRect();
                const areaRect = cropArea.getBoundingClientRect();
                
                const scaleX = originalImage.width / imgRect.width;
                const scaleY = originalImage.height / imgRect.height;
                
                // Calcular coordenadas de recorte relativas al √°rea
                const cropX = (cropBox.offsetLeft - (imgRect.left - areaRect.left)) * scaleX;
                const cropY = (cropBox.offsetTop - (imgRect.top - areaRect.top)) * scaleY;
                const cropWidth = cropBox.offsetWidth * scaleX;
                const cropHeight = cropBox.offsetHeight * scaleY;
                
                // Validar coordenadas
                if (cropX < 0 || cropY < 0 || cropWidth <= 0 || cropHeight <= 0) {
                    throw new Error('Coordenadas de recorte inv√°lidas');
                }
                
                console.log('üîç Coordenadas de recorte:', {
                    cropX, cropY, cropWidth, cropHeight,
                    originalWidth: originalImage.width,
                    originalHeight: originalImage.height
                });
                
                // Dibujar la imagen recortada en el canvas
                ctx.drawImage(
                    originalImage,
                    Math.max(0, cropX), 
                    Math.max(0, cropY), 
                    Math.min(cropWidth, originalImage.width - cropX), 
                    Math.min(cropHeight, originalImage.height - cropY),
                    0, 0, outputSize, outputSize
                );
                
                // Obtener la imagen recortada como data URL
                const croppedImageUrl = canvas.toDataURL('image/jpeg', 0.9);
                
                // üíæ GUARDAR EN ALMACENAMIENTO PERSISTENTE
                const codAtencion = getCurrentPatientCode();
                console.log('üì∑ Guardando foto para paciente:', codAtencion);
                
                if (codAtencion) {
                    // Preparar datos de la foto
                    const photoData = {
                        dataURL: croppedImageUrl,
                        fileName: `foto_${currentPhotoId}_${codAtencion}.jpg`
                    };
                    
                    const photoKey = `photo${currentPhotoId}`;
                    
                    // Usar sistema robusto de guardado
                    const saveSuccess = savePhotoWithMultipleBackups(codAtencion, photoKey, photoData);
                    
                    if (saveSuccess) {
                        console.log('üì∑ Foto guardada exitosamente con respaldos m√∫ltiples:', {
                            paciente: codAtencion,
                            foto: photoKey,
                            tama√±o: croppedImageUrl.length,
                            timestamp: new Date().toISOString()
                        });
                        
                        // Verificar integridad
                        const integrityOk = verifyPhotoIntegrity(codAtencion);
                        if (integrityOk) {
                            console.log(`‚úÖ Integridad de fotos verificada para paciente ${codAtencion}`);
                        } else {
                            console.warn(`‚ö†Ô∏è Advertencia: Problemas de integridad detectados para paciente ${codAtencion}`);
                        }
                        
                    } else {
                        console.error('‚ùå Error cr√≠tico: No se pudo guardar la foto');
                        showSecurityAlert('Error: No se pudo guardar la foto. Intente nuevamente.', 'error');
                    }
                } else {
                    console.error('‚ùå Error: No se pudo obtener c√≥digo de paciente para guardar foto');
                }
                
                // Mostrar la imagen recortada en la previsualizaci√≥n
                const previewImg = document.getElementById(`preview-${currentPhotoId}`);
                const controlsDiv = document.getElementById(`controls-${currentPhotoId}`);
                const photoUploadDiv = document.getElementById(`photo-${currentPhotoId}`);
                
                if (previewImg && controlsDiv && photoUploadDiv) {
                    previewImg.src = croppedImageUrl;
                    previewImg.style.display = 'block';
                    controlsDiv.style.display = 'flex';
                    
                    // Ocultar el texto de "Haga clic"
                    const photoText = photoUploadDiv.querySelector('.photo-text');
                    const photoIcon = photoUploadDiv.querySelector('i');
                    if (photoText) photoText.style.display = 'none';
                    if (photoIcon) photoIcon.style.display = 'none';
                    
                    // Cambiar estilo del contenedor
                    photoUploadDiv.style.borderColor = '#4caf50';
                    photoUploadDiv.style.backgroundColor = '#f8fff8';
                }
                
                // Cerrar el modal
                document.getElementById('crop-modal').style.display = 'none';
                
                // Mostrar mensaje de √©xito
                showSuccessMessage(`Foto ${currentPhotoId} guardada correctamente`);
                
            } catch (error) {
                console.error('‚ùå Error al guardar el recorte:', error);
                alert('Error al guardar la foto. Por favor, intente de nuevo.');
            }
        }
        
        // Funci√≥n para mostrar el estado de las fotos del paciente actual
        function showPhotoStatus(codAtencion) {
            if (!codAtencion) return;
            
            const patientPhotos = photoStorage[codAtencion] || {};
            const photoCount = Object.keys(patientPhotos).length;
            
            if (photoCount > 0) {
                console.log(`üì∑ Estado de fotos para ${codAtencion}: ${photoCount} foto${photoCount !== 1 ? 's' : ''} guardada${photoCount !== 1 ? 's' : ''}`);
                
                // Verificar integridad
                const integrityOk = verifyPhotoIntegrity(codAtencion);
                
                if (integrityOk) {
                    showSuccessMessage(`üì∑ ${photoCount} foto${photoCount !== 1 ? 's' : ''} cargada${photoCount !== 1 ? 's' : ''} ‚úÖ`);
                } else {
                    showSecurityAlert(`‚ö†Ô∏è ${photoCount} foto${photoCount !== 1 ? 's' : ''} cargada${photoCount !== 1 ? 's' : ''} (verificar integridad)`, 'warning');
                }
            }
        }
        
        // NUEVA FUNCI√ìN: Limpiar campos de patolog√≠a para nuevo paciente
        function clearPathologyFieldsForNewPatient() {
            console.log('üßπ Limpiando campos de patolog√≠a para nuevo paciente...');
            
            // 1. Limpiar descripciones macrosc√≥picas y microsc√≥picas
            const macroEditor = document.getElementById('macro-editor');
            const microEditor = document.getElementById('micro-editor');
            const diagnosticoEditor = document.getElementById('diagnostico-editor');
            
            if (macroEditor) {
                macroEditor.innerHTML = '';
                console.log('üßπ Campo descripci√≥n macrosc√≥pica limpiado');
            }
            
            if (microEditor) {
                microEditor.innerHTML = '';
                console.log('üßπ Campo descripci√≥n microsc√≥pica limpiado');
            }
            
            if (diagnosticoEditor) {
                diagnosticoEditor.innerHTML = '';
                console.log('üßπ Campo diagn√≥stico limpiado');
            }
            
            // 2. Limpiar todas las fotos adjuntas
            clearAllPhotosForNewPatient();
            
            // 3. Resetear selecciones de plantillas
            const categoriasMacro = document.getElementById('categoria-macro');
            const categoriasMicro = document.getElementById('categoria-micro');
            const plantillaMacro = document.getElementById('plantilla-macro');
            const plantillaMicro = document.getElementById('plantilla-micro');
            
            if (categoriasMacro) categoriasMacro.value = '';
            if (categoriasMicro) categoriasMicro.value = '';
            if (plantillaMacro) plantillaMacro.value = '';
            if (plantillaMicro) plantillaMicro.value = '';
            
            console.log('‚úÖ Campos de patolog√≠a limpiados completamente para nuevo paciente');
        }
        
        // NUEVA FUNCI√ìN: Limpiar todas las fotos para nuevo paciente
        function clearAllPhotosForNewPatient() {
            console.log('üì∑ Limpiando todas las fotos para nuevo paciente...');
            
            // Limpiar fotos de la interfaz (slots 1-6)
            for (let i = 1; i <= 6; i++) {
                const previewImg = document.getElementById(`preview-${i}`);
                const controlsDiv = document.getElementById(`controls-${i}`);
                const photoUploadDiv = document.getElementById(`photo-${i}`);
                
                if (previewImg) {
                    previewImg.src = '';
                    previewImg.style.display = 'none';
                }
                
                if (controlsDiv) {
                    controlsDiv.style.display = 'none';
                }
                
                if (photoUploadDiv) {
                    // Restaurar texto y estilo original
                    const photoText = photoUploadDiv.querySelector('.photo-text');
                    const photoIcon = photoUploadDiv.querySelector('i');
                    if (photoText) {
                        photoText.style.display = 'block';
                        photoText.textContent = 'Haga clic o arrastre una foto (JPG)';
                    }
                    if (photoIcon) photoIcon.style.display = 'block';
                    
                    photoUploadDiv.style.borderColor = '#ccc';
                    photoUploadDiv.style.backgroundColor = '#f9f9f9';
                }
            }
            
            console.log('‚úÖ Todas las fotos limpiadas de la interfaz');
        }

        // Funci√≥n mejorada para cambiar de paciente con manejo de fotos
        function switchToPatient(codAtencion, reportType) {
            try {
                // Guardar el estado actual antes de cambiar
                if (currentCodAtencion && currentCodAtencion !== codAtencion) {
                    console.log(`üîÑ Cambiando de paciente ${currentCodAtencion} a ${codAtencion}`);
                    
                    // Asegurar que las fotos del paciente actual est√©n guardadas
                    const currentPhotos = photoStorage[currentCodAtencion] || {};
                    if (Object.keys(currentPhotos).length > 0) {
                        console.log(`üì∑ Asegurando persistencia de ${Object.keys(currentPhotos).length} fotos del paciente actual`);
                        localStorage.setItem('photoStorage', JSON.stringify(photoStorage));
                    }
                    
                    // LIMPIAR CAMPOS DE PATOLOG√çA PARA NUEVO PACIENTE
                    clearPathologyFieldsForNewPatient();
                }
                
                // Actualizar variables globales
                currentCodAtencion = codAtencion;
                currentReportType = reportType;
                
                // Cargar fotos del nuevo paciente (si existe informe previo)
                loadSavedPhotos();
                
                // Mostrar estado de fotos
                showPhotoStatus(codAtencion);
                
                console.log(`‚úÖ Cambio de paciente completado: ${codAtencion} (${reportType})`);
                
            } catch (error) {
                console.error('‚ùå Error al cambiar de paciente:', error);
                showSecurityAlert('Error al cambiar de paciente. Intente nuevamente.', 'error');
            }
        }
        
        // Funci√≥n para obtener el c√≥digo del paciente actual
        function getCurrentPatientCode() {
            // 1. Intentar obtener desde las variables globales actuales
            if (currentCodAtencion && currentCodAtencion.trim()) {
                return currentCodAtencion.trim();
            }
            
            // 2. Intentar obtener desde el formulario de informe
            const codInput = document.getElementById('cod-atencion');
            if (codInput && codInput.value.trim()) {
                return codInput.value.trim();
            }
            
            // 3. Intentar obtener desde elementos del DOM del informe
            const codElement = document.getElementById('informe-codigo');
            if (codElement && codElement.textContent.trim()) {
                return codElement.textContent.trim();
            }
            
            // 4. Fallback: usar valor por defecto temporal
            console.warn('‚ö†Ô∏è No se pudo obtener c√≥digo de paciente, usando temporal');
            return 'TEMP_' + Date.now();
        }
        
        // Funci√≥n para eliminar foto - MEJORADA CON SISTEMA ROBUSTO
        function removePhoto(photoId) {
            if (confirm('¬øEst√° seguro de que desea eliminar esta foto?')) {
                const codAtencion = getCurrentPatientCode();
                const photoKey = `photo${photoId}`;
                
                // Limpiar desde todos los almacenamientos
                if (photoStorage[codAtencion] && photoStorage[codAtencion][photoKey]) {
                    // 1. Eliminar del almacenamiento principal
                    delete photoStorage[codAtencion][photoKey];
                    localStorage.setItem('photoStorage', JSON.stringify(photoStorage));
                    
                    // 2. Actualizar respaldo en sessionStorage
                    sessionStorage.setItem('photoStorage_backup', JSON.stringify(photoStorage));
                    
                    // 3. Limpiar respaldo espec√≠fico del paciente si no hay m√°s fotos
                    const patientPhotoKey = `photos_${codAtencion}`;
                    if (Object.keys(photoStorage[codAtencion]).length === 0) {
                        localStorage.removeItem(patientPhotoKey);
                        localStorage.removeItem(`photoBackup_${codAtencion}`);
                    } else {
                        localStorage.setItem(patientPhotoKey, JSON.stringify(photoStorage[codAtencion]));
                    }
                    
                    // 4. Limpiar almacenamiento de emergencia
                    localStorage.removeItem(`emergency_photo_${codAtencion}_${photoKey}`);
                    
                    // 5. Actualizar IndexedDB si est√° disponible
                    if (db && Object.keys(photoStorage[codAtencion]).length > 0) {
                        savePhotoToIndexedDB(codAtencion, photoStorage[codAtencion]);
                    }
                    
                    console.log(`üì∑ Foto ${photoId} eliminada de todos los almacenamientos`);
                }
                
                // Limpiar interfaz
                const previewImg = document.getElementById(`preview-${photoId}`);
                const controlsDiv = document.getElementById(`controls-${photoId}`);
                const photoUploadDiv = document.getElementById(`photo-${photoId}`);
                
                if (previewImg) {
                    previewImg.src = '';
                    previewImg.style.display = 'none';
                }
                
                if (controlsDiv) {
                    controlsDiv.style.display = 'none';
                }
                
                if (photoUploadDiv) {
                    // Restaurar texto y estilo original
                    const photoText = photoUploadDiv.querySelector('.photo-text');
                    const photoIcon = photoUploadDiv.querySelector('i');
                    if (photoText) photoText.style.display = 'block';
                    if (photoIcon) photoIcon.style.display = 'block';
                    
                    photoUploadDiv.style.borderColor = '#ccc';
                    photoUploadDiv.style.backgroundColor = '#f9f9f9';
                }
                
                console.log(`‚úÖ Foto ${photoId} eliminada`);
            }
        }
        
        // Funci√≥n para cargar fotos guardadas - MEJORADA CON SISTEMA ROBUSTO
        function loadSavedPhotos() {
            const codAtencion = getCurrentPatientCode();
            console.log('üì∑ Cargando fotos para:', codAtencion);
            
            if (!codAtencion) {
                console.log('üì∑ No hay c√≥digo de paciente actual');
                return;
            }
            
            // Usar sistema robusto de carga
            const savedPhotos = loadPhotosWithRecovery(codAtencion);
            
            if (!savedPhotos || Object.keys(savedPhotos).length === 0) {
                console.log('üì∑ No hay fotos guardadas para este paciente');
                return;
            }
            
            console.log('üì∑ Fotos cargadas exitosamente:', Object.keys(savedPhotos));
            
            // Verificar integridad antes de mostrar
            const integrityOk = verifyPhotoIntegrity(codAtencion);
            if (!integrityOk) {
                console.warn('‚ö†Ô∏è Advertencia: Se detectaron problemas de integridad en las fotos');
                showSecurityAlert('Advertencia: Se detectaron posibles problemas con las fotos guardadas', 'warning');
            }
            
            // Cargar cada foto guardada
            Object.keys(savedPhotos).forEach(photoKey => {
                const photoId = photoKey.replace('photo', '');
                const photoData = savedPhotos[photoKey];
                
                console.log(`üì∑ Procesando foto ${photoId}:`, {
                    timestamp: photoData.timestamp,
                    hasDataURL: !!photoData.dataURL,
                    dataURLLength: photoData.dataURL ? photoData.dataURL.length : 0,
                    hasChecksum: !!photoData.checksum
                });
                
                if (photoData && photoData.dataURL) {
                    const previewImg = document.getElementById(`preview-${photoId}`);
                    const controlsDiv = document.getElementById(`controls-${photoId}`);
                    const photoUploadDiv = document.getElementById(`photo-${photoId}`);
                    
                    console.log(`üì∑ Elementos DOM para foto ${photoId}:`, {
                        previewImg: !!previewImg,
                        controlsDiv: !!controlsDiv,
                        photoUploadDiv: !!photoUploadDiv
                    });
                    
                    if (previewImg && controlsDiv && photoUploadDiv) {
                        // Configurar imagen
                        previewImg.src = photoData.dataURL;
                        previewImg.style.display = 'block';
                        previewImg.crossOrigin = 'anonymous';
                        
                        // Mostrar controles
                        controlsDiv.style.display = 'flex';
                        
                        // Ocultar texto original
                        const photoText = photoUploadDiv.querySelector('.photo-text');
                        const photoIcon = photoUploadDiv.querySelector('i');
                        if (photoText) photoText.style.display = 'none';
                        if (photoIcon) photoIcon.style.display = 'none';
                        
                        // Cambiar estilo del contenedor
                        photoUploadDiv.style.borderColor = '#4caf50';
                        photoUploadDiv.style.backgroundColor = '#e8f5e9';
                        
                        console.log(`‚úÖ Foto ${photoId} cargada exitosamente`);
                        
                        // Mostrar timestamp si existe
                        if (photoData.timestamp) {
                            const timestampDiv = controlsDiv.querySelector('.photo-timestamp') || 
                                                 (() => {
                                                     const div = document.createElement('div');
                                                     div.className = 'photo-timestamp';
                                                     div.style.cssText = 'font-size: 0.7rem; color: #666; margin-top: 4px;';
                                                     controlsDiv.appendChild(div);
                                                     return div;
                                                 })();
                            
                            const date = new Date(photoData.timestamp);
                            timestampDiv.textContent = `Guardada: ${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;
                        }
                        
                    } else {
                        console.log(`‚ùå No se encontraron elementos DOM para foto ${photoId}`);
                    }
                } else {
                    console.log(`‚ùå Datos de foto inv√°lidos para ${photoKey}`);
                }
            });
            
            console.log('üì∑ Proceso de carga de fotos completado exitosamente');
            
            // Mostrar mensaje de √©xito
            const photoCount = Object.keys(savedPhotos).length;
            showSuccessMessage(`üì∑ ${photoCount} foto${photoCount !== 1 ? 's' : ''} cargada${photoCount !== 1 ? 's' : ''} exitosamente`);
        }
        
        // Funci√≥n para mostrar mensajes de √©xito
        function showSuccessMessage(message) {
            // Crear y mostrar toast notification
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #4caf50;
                color: white;
                padding: 12px 24px;
                border-radius: 6px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 10000;
                font-size: 14px;
                animation: slideIn 0.3s ease;
            `;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            // Remover despu√©s de 3 segundos
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }
        
        // üì± FUNCIONES M√ìVILES MEJORADAS
        function initializeMobileFeatures() {
            const menuToggle = document.querySelector('.menu-toggle');
            const sidebar = document.querySelector('.sidebar');
            const mainContent = document.querySelector('.main-content');
            
            // Toggle del men√∫ m√≥vil
            if (menuToggle && sidebar) {
                menuToggle.addEventListener('click', function() {
                    sidebar.classList.toggle('active');
                    
                    // Agregar overlay para cerrar sidebar en m√≥vil
                    if (sidebar.classList.contains('active')) {
                        createMobileOverlay();
                    } else {
                        removeMobileOverlay();
                    }
                });
            }
            
            // Cerrar sidebar al hacer clic en un item del men√∫ (m√≥vil)
            const menuItems = document.querySelectorAll('.menu-item');
            menuItems.forEach(item => {
                item.addEventListener('click', function() {
                    if (window.innerWidth <= 1024) {
                        sidebar.classList.remove('active');
                        removeMobileOverlay();
                    }
                });
            });
            
            // Mejorar interacciones t√°ctiles
            enhanceTouchInteractions();
            
            // Detectar gestos de swipe para m√≥vil
            initializeSwipeGestures();
        }
        
        function createMobileOverlay() {
            let overlay = document.querySelector('.mobile-overlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.className = 'mobile-overlay';
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.5);
                    z-index: 99;
                    display: block;
                `;
                
                overlay.addEventListener('click', function() {
                    document.querySelector('.sidebar').classList.remove('active');
                    removeMobileOverlay();
                });
                
                document.body.appendChild(overlay);
            }
        }
        
        function removeMobileOverlay() {
            const overlay = document.querySelector('.mobile-overlay');
            if (overlay) {
                overlay.remove();
            }
        }
        
        function enhanceTouchInteractions() {
            // Mejorar botones para dispositivos t√°ctiles
            const buttons = document.querySelectorAll('.btn, .action-btn, .menu-item');
            buttons.forEach(button => {
                // Agregar efecto de tap visual
                button.addEventListener('touchstart', function() {
                    this.style.transform = 'scale(0.95)';
                    this.style.transition = 'transform 0.1s';
                }, { passive: true });
                
                button.addEventListener('touchend', function() {
                    this.style.transform = 'scale(1)';
                }, { passive: true });
                
                button.addEventListener('touchcancel', function() {
                    this.style.transform = 'scale(1)';
                }, { passive: true });
            });
        }
        
        function initializeSwipeGestures() {
            let startX = 0;
            let startY = 0;
            let currentX = 0;
            let currentY = 0;
            
            document.addEventListener('touchstart', function(e) {
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
            }, { passive: true });
            
            document.addEventListener('touchmove', function(e) {
                currentX = e.touches[0].clientX;
                currentY = e.touches[0].clientY;
            }, { passive: true });
            
            document.addEventListener('touchend', function(e) {
                const diffX = startX - currentX;
                const diffY = startY - currentY;
                
                // Solo procesar si es un swipe horizontal significativo
                if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) {
                    const sidebar = document.querySelector('.sidebar');
                    
                    if (diffX > 0 && window.innerWidth <= 1024) {
                        // Swipe izquierda - cerrar sidebar
                        sidebar.classList.remove('active');
                        removeMobileOverlay();
                    } else if (diffX < -50 && window.innerWidth <= 1024 && startX < 20) {
                        // Swipe derecha desde el borde - abrir sidebar
                        sidebar.classList.add('active');
                        createMobileOverlay();
                    }
                }
            }, { passive: true });
        }
        
        // Funci√≥n para eliminar foto
        function removePhoto(photoId) {
            document.getElementById(`preview-${photoId}`).src = '';
            document.getElementById(`preview-${photoId}`).style.display = 'none';
            document.getElementById(`controls-${photoId}`).style.display = 'none';
            document.getElementById(`photo-input-${photoId}`).value = '';
        }
        
        // Inicializar p√°gina - C√ìDIGO CORREGIDO
        document.addEventListener('DOMContentLoaded', function() {
            // üì± INICIALIZAR FUNCIONES M√ìVILES PRIMERO
            initializeMobileFeatures();
            
            // Configurar event listeners para el men√∫ - CORREGIDO
            document.querySelectorAll('.menu-item').forEach(item => {
                item.addEventListener('click', function() {
                    const pageId = this.getAttribute('data-link');
                    showPage(pageId);
                });
            });
            
            // Configurar botones de formato
            document.querySelectorAll('.format-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const command = this.getAttribute('data-command');
                    formatDoc(command);
                });
            });
            
            // Configurar selectores de formato (nuevo)
            document.querySelectorAll('.format-select').forEach(select => {
                select.addEventListener('change', function() {
                    const command = this.getAttribute('data-command');
                    const value = this.value;
                    if (value) {
                        formatDoc(command, value);
                        this.value = ''; // Resetear el select despu√©s de aplicar
                    }
                });
            });
            
            // Configurar bot√≥n volver
            document.getElementById('volver-btn').addEventListener('click', function() {
                if (currentReportType === 'surgical') {
                    showPage('resultados-quirurgicos');
                } else {
                    showPage('resultados-citologicos');
                }
            });
            
            // Configurar bot√≥n de informe preliminar
            document.getElementById('preliminary-btn').addEventListener('click', function() {
                // Transferir datos actuales a informe preliminar
                if (currentCodAtencion && currentReportType) {
                    const transferExitoso = transferToPreliminario(currentCodAtencion, currentReportType);
                    if (transferExitoso) {
                        // Redirigir a informe-preliminar.html
                        window.open('informe-preliminar.html', '_blank');
                    } else {
                        alert('Error al transferir datos al informe preliminar');
                    }
                } else {
                    alert('No hay datos de paciente cargados para generar el informe preliminar');
                }
            });
            
            // Configurar bot√≥n guardar
            document.getElementById('guardar-btn').addEventListener('click', guardarInforme);
            
            // Configurar bot√≥n firmar
            document.getElementById('firmar-btn').addEventListener('click', function() {
                alert('Informe firmado por el Dr. Castillo');
            });
            
            // Configurar bot√≥n de guardar paciente
            document.getElementById('save-btn').addEventListener('click', guardarPaciente);
            
            // Configurar bot√≥n de salir
            document.getElementById('exit-btn').addEventListener('click', function() {
                if (confirm('¬øEst√° seguro de que desea salir?')) {
                    showPage('registro-pacientes');
                }
            });
            
            // Configurar fecha actual
            const today = new Date();
            const deliveryDate = new Date();
            deliveryDate.setDate(today.getDate() + 2);
            
            document.getElementById('registration-date').textContent = formatDate(today);
            document.getElementById('delivery-date').textContent = formatDate(deliveryDate);
            
            // Configurar el evento para el cambio de tipo de servicio
            document.getElementById('service-type').addEventListener('change', function() {
                const serviceType = this.value;
                const codAtencionInput = document.getElementById('attention-code');
                
                if (serviceType === 'hematoxilina') {
                    codAtencionInput.value = '25Q-';
                } else if (serviceType === 'citologia') {
                    codAtencionInput.value = '25C-';
                } else {
                    codAtencionInput.value = '';
                }
            });
            
            // Configurar subida de archivos para orden de servicio
            const fileUpload = document.querySelector('#orden-servicio-upload');
            if (fileUpload) {
                fileUpload.addEventListener('click', function() {
                    const fileInput = document.createElement('input');
                    fileInput.type = 'file';
                    fileInput.accept = 'image/jpeg';
                    fileInput.style.display = 'none';
                    
                    fileInput.addEventListener('change', function() {
                        if (this.files.length > 0) {
                            const fileName = this.files[0].name;
                            fileUpload.innerHTML = `
                                <i class="fas fa-file-image"></i>
                                <div class="file-text">Archivo seleccionado</div>
                                <div class="file-text">${fileName}</div>
                            `;
                            fileUpload.style.borderColor = '#4caf50';
                            fileUpload.style.backgroundColor = '#e8f5e9';
                        }
                    });
                    
                    document.body.appendChild(fileInput);
                    fileInput.click();
                    document.body.removeChild(fileInput);
                });
            }
            
            // Configurar eventos para el recorte de foto
            document.getElementById('cancel-crop').addEventListener('click', function() {
                document.getElementById('crop-modal').style.display = 'none';
            });
            
            document.getElementById('save-crop').addEventListener('click', saveCrop);
            
            // Cargar m√©dicos en los selects
            populateDoctorsSelect();
            
            // üî¢ CONFIGURAR VALIDACI√ìN DE DNI PARA TODOS LOS CAMPOS
            initializeDNIValidation();
            
            // Configurar modal de registro de m√©dicos
            setupDoctorModal();
            
            // üîß AGREGAR FUNCI√ìN DE PRUEBA PARA MODAL
            window.testDoctorModal = function() {
                console.log('üîß Ejecutando prueba manual del modal...');
                const modal = document.getElementById('doctor-modal');
                const btn = document.getElementById('register-btn-med');
                
                console.log('Elementos encontrados:', {
                    modal: !!modal,
                    modalDisplay: modal ? modal.style.display : 'no encontrado',
                    button: !!btn,
                    buttonVisible: btn ? window.getComputedStyle(btn).display : 'no encontrado'
                });
                
                if (modal) {
                    console.log('üîß Forzando apertura del modal...');
                    openDoctorModal();
                    
                    setTimeout(() => {
                        console.log('Estado del modal despu√©s de 1 segundo:', {
                            display: modal.style.display,
                            zIndex: modal.style.zIndex,
                            visibility: window.getComputedStyle(modal).visibility
                        });
                    }, 1000);
                } else {
                    console.error('‚ùå Modal no encontrado');
                }
            };
            
            console.log('üîß Funci√≥n de prueba disponible: testDoctorModal()');
            
            // üîß VERIFICAR QUE LA P√ÅGINA DE M√âDICOS TENGA EL BOT√ìN
            setTimeout(() => {
                const currentPage = document.getElementById('registro-medicos');
                if (currentPage) {
                    const registerButton = currentPage.querySelector('#register-btn-med');
                    console.log('üîß Bot√≥n en p√°gina de m√©dicos:', {
                        found: !!registerButton,
                        id: registerButton ? registerButton.id : 'no encontrado',
                        hasEventListeners: registerButton ? 'verificar en DevTools' : 'no aplicable'
                    });
                }
            }, 2000);
            
            // üîÑ MIGRAR DATOS DE M√âDICOS SI ES NECESARIO
            migrateDoctorsData();
            
            // Cargar tabla de m√©dicos
            loadDoctorsTable();
            
            // üîê VALIDAR SESI√ìN DE USUARIO ANTES DE CONTINUAR
            if (!validateUserSession()) {
                return; // Si no hay sesi√≥n v√°lida, la funci√≥n redirige al login
            }
            
            // üì∑ INICIALIZAR FUNCIONALIDAD DE FOTOS
            initializePhotoSystem();
            
            // üõ†Ô∏è AUTO-REPARACI√ìN Y VERIFICACI√ìN DE FOTOS
            setTimeout(() => {
                const repairResult = autoRepairAndVerifyPhotos();
                const cleanedCount = cleanOrphanedPhotos();
                
                console.log(`üì∑ Sistema de fotos inicializado: ${repairResult.total} fotos total, ${repairResult.repaired} reparadas, ${cleanedCount} hu√©rfanas eliminadas`);
            }, 1000);
            
            // üîÑ INICIALIZAR SISTEMA ROBUSTO DE PERSISTENCIA
            initIndexedDB().then(async () => {
                console.log('‚úÖ IndexedDB inicializada correctamente');
                
                // Cargar datos con sistema robusto
                await loadAllDataRobust();
                
                // Cargar las tablas con los datos existentes
                cargarResultadosQuirurgicos();
                cargarResultadosCitologicos();
                
                // Iniciar sincronizaci√≥n en tiempo real
                syncDataRealTime();
                
                // üñ•Ô∏è ACTIVAR OPTIMIZACI√ìN DE PANTALLA
                adjustLayoutRealTime();
                
                console.log('üîÑ Sistema de persistencia robusto activado');
                
            }).catch(error => {
                console.warn('‚ö†Ô∏è IndexedDB no disponible, usando localStorage:', error);
                
                // Fallback a sistema anterior mejorado
                loadAllDataRobust();
                cargarResultadosQuirurgicos();
                cargarResultadosCitologicos();
                syncDataRealTime();
                
                // üîê PROTEGER INTEGRIDAD DE DATOS INICIAL
                protectDataIntegrity();
                
                // üîê VERIFICAR INTEGRIDAD PERI√ìDICAMENTE (cada 5 minutos)
                setInterval(() => {
                    if (!verifyDataIntegrity()) {
                        console.warn('üîê Se detect√≥ posible modificaci√≥n no autorizada de datos');
                        showSecurityAlert('Se detect√≥ una modificaci√≥n inesperada en los datos. Por seguridad, se recomienda recargar la p√°gina.');
                    }
                }, 300000); // 5 minutos
                
                // üîê VERIFICAR SESI√ìN V√ÅLIDA PERI√ìDICAMENTE (cada 30 minutos)
                setInterval(() => {
                    if (!validateUserSession()) {
                        console.warn('üîê Sesi√≥n expirada detectada');
                        showSecurityAlert('Su sesi√≥n ha expirado por seguridad. Ser√° redirigido al login.');
                        setTimeout(() => {
                            redirectToLogin();
                        }, 3000);
                    }
                }, 1800000); // 30 minutos
                
                // üîê CREAR RESPALDO AUTOM√ÅTICO CADA HORA
                setInterval(() => {
                    console.log('üîê Creando respaldo autom√°tico de seguridad...');
                    createEmergencyBackup();
                    protectDataIntegrity();
                }, 3600000); // 1 hora
                
                // üñ•Ô∏è ACTIVAR OPTIMIZACI√ìN DE PANTALLA (Fallback)
                adjustLayoutRealTime();
            });
            
            // Mostrar la p√°gina inicial
            showPage('registro-pacientes');
            
            // üîÑ VERIFICAR Y MANEJAR RETORNO DESDE INFORME PRELIMINAR
            setTimeout(() => {
                checkReturnFromPreliminary();
            }, 1000);
        });
        
        // üîÑ FUNCI√ìN PARA MANEJAR RETORNO DESDE INFORME PRELIMINAR
        function checkReturnFromPreliminary() {
            try {
                // Verificar si hay contexto de retorno
                const returnContext = localStorage.getItem('return_context') || sessionStorage.getItem('return_context');
                const restoreContext = localStorage.getItem('restore_informe_context');
                
                if (returnContext || restoreContext) {
                    let contextData;
                    
                    if (returnContext) {
                        contextData = JSON.parse(returnContext);
                        console.log('üîÑ Contexto de retorno encontrado:', contextData);
                    } else if (restoreContext) {
                        contextData = JSON.parse(restoreContext);
                        console.log('üîÑ Contexto de restauraci√≥n encontrado:', contextData);
                    }
                    
                    if (contextData && contextData.codAtencion) {
                        // Restaurar el informe autom√°ticamente
                        const codAtencion = contextData.codAtencion;
                        const tipo = contextData.reportType || contextData.tipo;
                        
                        console.log(`üîÑ Restaurando informe: ${codAtencion} (${tipo})`);
                        
                        // Mostrar la p√°gina de informe
                        showPage('ver-informe');
                        
                        // Cargar el informe espec√≠fico
                        setTimeout(() => {
                            mostrarInforme(codAtencion, tipo);
                        }, 500);
                        
                        // Limpiar contextos despu√©s de usar
                        localStorage.removeItem('return_context');
                        sessionStorage.removeItem('return_context');
                        localStorage.removeItem('restore_informe_context');
                        
                        console.log('‚úÖ Contexto de retorno procesado exitosamente');
                    }
                }
            } catch (error) {
                console.error('‚ùå Error al procesar contexto de retorno:', error);
                // Limpiar contextos da√±ados
                localStorage.removeItem('return_context');
                sessionStorage.removeItem('return_context');
                localStorage.removeItem('restore_informe_context');
            }
        }
        
        // Cargar script de integraci√≥n de recuperaci√≥n de datos
        const dataRecoveryScript = document.createElement('script');
        dataRecoveryScript.src = 'data_recovery_integration.js';
        dataRecoveryScript.async = true;
        document.head.appendChild(dataRecoveryScript);
        
        // Inicializar base de datos IndexedDB
        initializeDatabase();
        
        // Aplicar animaciones a elementos cuando la p√°gina carga
        applyPageAnimations();
    </script>
</body>
</html>