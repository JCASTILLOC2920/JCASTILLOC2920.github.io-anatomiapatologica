<!DOCTYPE html>
<html lang="es">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JC PATH LAB | Informe Preliminar</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Dexie.js for IndexedDB wrapper -->
    <script src="https://unpkg.com/dexie@3.2.2/dist/dexie.js"></script>
    <style>
        :root {
            --primary: #1e88e5;
            --primary-dark: #0d47a1;
            --secondary: #ff9800;
            --secondary-dark: #f57c00;
            --text: #333;
            --text-light: #666;
            --bg: #f0f2f5;
            --sidebar-bg: #2c3e50;
            --sidebar-hover: #34495e;
            --card-bg: #ffffff;
            --border: #e0e0e0;
            --success: #4caf50;
            --error: #e53935;
            --table-header: #e3f2fd;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        
        /* Animaciones sutiles */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideInUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.01); }
            100% { transform: scale(1); }
        }
        
        .animated-fadeIn {
            animation: fadeIn 0.8s ease-out;
        }
        
        .animated-slideInUp {
            animation: slideInUp 0.8s ease-out;
        }
        
        .animated-pulse {
            animation: pulse 2s ease-in-out infinite;
        }
        
        /* Aplicar animaciones a elementos clave */
        .a4-container {
            animation: fadeIn 0.8s ease-out;
        }
        
        .report-header {
            animation: slideInUp 0.8s ease-out;
        }
        
        .report-section {
            animation: fadeIn 0.8s ease-out;
        }
        
        .report-section:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .report-section:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        .report-section:nth-child(4) {
            animation-delay: 0.6s;
        }
        
        body {
            background-color: var(--bg);
            color: var(--text);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            font-family: Arial, sans-serif;
            position: relative;
        }
        
        /* Contenedor A4 */
        .a4-container {
            width: 21cm;
            min-height: 29.7cm;
            background: white;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            padding: 1.5cm;
            box-sizing: border-box;
            margin-bottom: 20px;
            font-family: Arial, sans-serif;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        
        .preliminary-report {
            padding: 0;
            background: white;
            font-family: Arial, sans-serif;
            color: #333;
            line-height: 1.6;
            width: 100%;
            margin: 0 auto;
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .report-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
        }
        
        .report-header img {
            width: 100%;
            max-width: 1044px;
            height: auto;
            display: block;
            margin: 0 auto;
        }
        
        .patient-info {
            margin-bottom: 20px;
        }
        
        .patient-info h3 {
            font-size: 13pt;
            font-weight: bold;
            margin-bottom: 10px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
            text-align: justify;
            font-family: Arial, sans-serif;
        }
        
        .patient-data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-family: Arial, sans-serif;
        }
        
        .patient-data-table td {
            padding: 4px;
            border: 1px solid #ddd;
            vertical-align: top;
            font-size: 9pt;
            line-height: 1.2;
            font-family: Arial, sans-serif;
        }
        
        .patient-data-table .codigo-cell {
            font-size: 16pt;
            font-weight: bold;
            text-align: center;
            vertical-align: middle;
            background-color: #f0f7ff;
            padding: 2px 4px;
            font-family: Arial, sans-serif;
        }
        
        .patient-data-table .info-cell {
            padding: 4px;
            font-family: Arial, sans-serif;
        }
        
        .report-section {
            margin-bottom: 20px;
        }
        
        .report-section h3 {
            font-size: 13pt;
            font-weight: bold;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #ddd;
            text-align: justify;
            font-family: Arial, sans-serif;
        }
        
        .report-content {
            padding-left: 20px;
            font-size: 10pt;
            font-family: Arial, sans-serif;
            text-align: justify;
            line-height: 1.2;
        }
        
        .diagnosis-section {
            margin-top: 25px;
            font-weight: bold;
        }
        
        .diagnosis-title {
            font-size: 12pt;
            text-align: left;
            margin-bottom: 15px;
            font-weight: bold;
            font-family: Arial, sans-serif;
        }
        
        .diagnosis-section .report-content {
            font-size: 12pt;
            text-align: left;
            padding-left: 0;
            font-family: Arial, sans-serif;
        }
        
        .decorative-line {
            width: 100%;
            max-width: 1031px;
            height: 7px;
            display: block;
            margin: 10px 0;
        }
        
        /* Pie de p√°gina dentro del A4 */
        .report-footer-container {
            margin-top: auto;
            padding-top: 30px;
            page-break-inside: avoid;
        }
        
        /* Asegurar que el contenido principal no empuje las fotos fuera de la p√°gina */
        .preliminary-report {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        
        .diagnosis-section {
            margin-bottom: 30px;
        }
        
        .signature-section {
            text-align: right;
            margin-bottom: 20px;
        }
        
        .signature-image {
            width: 169px; /* Reducido 20% desde 211px original */
            height: 91px; /* Reducido 20% desde 114px original */
            display: block;
            margin-left: auto;
        }
        
        /* üì∑ ESTILOS MEJORADOS PARA LA SECCI√ìN DE FOTOS EN EL INFORME */
        .photos-section {
            margin: 30px 0 20px 0;
            page-break-inside: avoid;
            clear: both;
            /* Posicionar las fotos en la parte inferior */
            margin-top: auto;
            padding-top: 40px;
        }
        
        .photos-section h3 {
            font-size: 13pt;
            font-weight: bold;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 2px solid #333;
            color: #333;
            text-align: center;
            text-transform: uppercase;
        }
        
        .photos-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 25px;
            justify-content: center;
            align-items: flex-start;
            margin: 25px 0;
            page-break-inside: avoid;
        }
        
        .photo-item {
            text-align: center;
            page-break-inside: avoid;
            max-width: 220px;
            margin: 0 auto;
            break-inside: avoid;
        }
        
        .photo-label {
            font-size: 11pt;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            padding: 6px 12px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #ddd;
        }
        
        .attached-photo {
            max-width: 200px;
            max-height: 200px;
            width: auto;
            height: auto;
            border: 2px solid #333;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            object-fit: contain;
            background: white;
            padding: 6px;
        }
        
        .page-footer {
            text-align: center;
            margin-top: 25px; /* Aumentado para bajar m√°s l√≠neas la imagen */
        }
        
        .footer-image {
            max-width: 100%;
            height: auto;
            max-height: 17px;
            display: block;
            margin: 0 auto;
        }
        
        .document-footer {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            font-family: Arial, sans-serif;
            width: 100%;
        }
        
        .footer-left {
            font-size: 9pt;
            text-align: left;
            font-family: Arial, sans-serif;
        }
        
        .footer-right {
            font-size: 8pt;
            text-align: right;
            font-family: Arial, sans-serif;
        }
        
        .footer-right span {
            margin-left: 10px;
        }
        
        .button-container {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
            width: 21cm;
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            text-decoration: none;
            font-family: Arial, sans-serif;
        }
        
        .btn:hover {
            background: linear-gradient(135deg, #1976d2, #0d47a1);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .btn i {
            margin-right: 8px;
        }

        .btn-print {
            background: linear-gradient(135deg, var(--secondary), var(--secondary-dark));
        }
        
        .btn-print:hover {
            background: linear-gradient(135deg, #f57c00, #e65100);
        }

        /* Botones de acci√≥n principales - SIEMPRE EN LA PARTE SUPERIOR */
        .button-container {
            background: white;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            position: sticky;
            top: 10px;
            z-index: 100;
        }
        
        .btn-print {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            border-radius: 6px;
            padding: 12px 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .btn-print:hover {
            background: linear-gradient(135deg, var(--primary-dark), #0d47a1);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .btn-edit {
            background: linear-gradient(135deg, var(--secondary), var(--secondary-dark));
            color: white;
            border: none;
            border-radius: 6px;
            padding: 12px 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .btn-edit:hover {
            background: linear-gradient(135deg, var(--secondary-dark), #e65100);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .btn-back {
            background: linear-gradient(135deg, #6c757d, #495057);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 12px 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .btn-back:hover {
            background: linear-gradient(135deg, #495057, #343a40);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        /* üì± DISE√ëO RESPONSIVO MEJORADO PARA TODOS LOS DISPOSITIVOS */
        
        /* Mejoras para dispositivos t√°ctiles */
        @media (hover: none) and (pointer: coarse) {
            .btn-print, .btn-edit, .btn-back {
                min-height: 44px; /* Tama√±o m√≠nimo recomendado para touch */
                padding: 14px 20px;
                font-size: 16px;
            }
            
            .patient-data-table td {
                padding: 12px 8px;
                font-size: 10pt;
            }
            
            .report-content {
                font-size: 11pt;
                line-height: 1.4;
            }
        }
        
        /* Pantallas muy peque√±as (320px - 479px) */
        @media (max-width: 479px) {
            body {
                padding: 10px;
            }
            
            .a4-container {
                width: 100%;
                padding: 8px;
                margin-bottom: 10px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            }
            
            .button-container {
                flex-direction: column;
                gap: 8px;
                padding: 12px;
                margin-bottom: 15px;
            }
            
            .btn-print, .btn-edit, .btn-back {
                width: 100%;
                justify-content: center;
                padding: 12px 16px;
                font-size: 14px;
            }
            
            .report-header img {
                max-width: 100%;
                height: auto;
            }
            
            .patient-data-table {
                font-size: 7pt;
                width: 100%;
            }
            
            .patient-data-table td {
                padding: 4px 2px;
                font-size: 7pt;
                line-height: 1.2;
            }
            
            .codigo-cell {
                font-size: 14pt !important;
                padding: 4px 2px;
                text-align: center;
            }
            
            .report-content {
                font-size: 8pt;
                line-height: 1.2;
                padding-left: 8px;
            }
            
            .report-section h3 {
                font-size: 10pt;
                margin-bottom: 6px;
            }
            
            .diagnosis-title {
                font-size: 9pt;
                margin-bottom: 8px;
            }
            
            .signature-image {
                width: 100px;
                height: auto;
            }
            
            .footer-left, .footer-right {
                font-size: 7pt;
            }
            
            .decorative-line {
                max-width: 100%;
                height: 5px;
            }
        }
        
        @media print {
            body {
                padding: 0;
                background: white;
                font-family: Arial, sans-serif;
            }
            
            .a4-container {
                width: 100%;
                height: 100%;
                box-shadow: none;
                padding: 0;
                margin: 0;
                font-family: Arial, sans-serif;
            }
            
            .button-container {
                display: none;
            }
            
            .preliminary-report {
                font-family: Arial, sans-serif;
            }
            
            .document-footer {
                position: fixed;
                bottom: 30px;
                width: calc(100% - 3cm);
                left: 1.5cm;
            }
            
            /* Estilos de impresi√≥n para fotos - MEJORADOS PARA PAGINACI√ìN A4 */
            .photos-section {
                margin: 30px 0 20px 0;
                page-break-inside: avoid;
                /* Si no hay espacio suficiente, crear nueva p√°gina */
                page-break-before: auto;
                orphans: 2;
                widows: 2;
            }
            
            .photos-section h3 {
                page-break-after: avoid;
                font-size: 12pt;
                margin-bottom: 20px;
                border-bottom: 2px solid #333;
            }
            
            .photos-grid {
                gap: 20px;
                justify-content: center;
                page-break-inside: avoid;
                display: flex;
                flex-wrap: wrap;
            }
            
            .photo-item {
                page-break-inside: avoid;
                break-inside: avoid;
                margin: 10px;
            }
            
            .attached-photo {
                max-width: 160px;
                max-height: 160px;
                border: 2px solid #333;
                box-shadow: none;
                page-break-inside: avoid;
                break-inside: avoid;
            }
            
            .photo-label {
                font-size: 10pt;
                background: none;
                border: 1px solid #333;
                color: #333;
                margin-bottom: 8px;
            }
            
            /* Asegurar que el pie de p√°gina se mantenga en su lugar */
            .report-footer-container {
                page-break-inside: avoid;
                margin-top: 40px;
            }
        }
        
        /* üñ•Ô∏è MEJORAS PARA DIFERENTES TAMA√ëOS DE PANTALLA */
        
        /* Pantallas muy grandes */
        @media (min-width: 1920px) {
            .a4-container {
                width: 23cm;
                padding: 2cm;
            }
            
            .report-content {
                font-size: 11pt;
                line-height: 1.3;
            }
            
            .patient-data-table td {
                font-size: 10pt;
                padding: 6px;
            }
        }
        
        /* Pantallas grandes */
        @media (min-width: 1400px) and (max-width: 1919px) {
            .a4-container {
                width: 22cm;
                padding: 1.8cm;
            }
            
            .report-content {
                font-size: 10pt;
                line-height: 1.25;
            }
        }
        
        /* Tablets grandes */
        @media (min-width: 992px) and (max-width: 1399px) {
            .a4-container {
                width: 95%;
                max-width: 21cm;
                padding: 1.5cm;
            }
        }
        
        /* Tablets */
        @media (min-width: 769px) and (max-width: 991px) {
            .a4-container {
                width: 98%;
                padding: 1.2cm;
            }
            
            .report-content {
                font-size: 9pt;
                line-height: 1.15;
                padding-left: 15px;
            }
            
            .patient-data-table td {
                font-size: 8pt;
                padding: 3px;
            }
            
            .codigo-cell {
                font-size: 16pt !important;
            }
        }

        @media (max-width: 860px) {
            .a4-container {
                width: 100%;
                padding: 15px;
            }
            
            .button-container {
                width: 100%;
                flex-direction: column;
            }
            
            .report-content {
                font-size: 9pt;
                line-height: 1.1;
                padding-left: 10px;
            }
            
            .patient-data-table td {
                font-size: 8pt;
                padding: 2px;
                line-height: 1.1;
            }
            
            .codigo-cell {
                font-size: 16pt !important;
            }
            
            .report-section h3 {
                font-size: 12pt;
            }
            
            .diagnosis-title {
                font-size: 11pt;
            }
        }
        
        /* M√≥viles */
        @media (max-width: 480px) {
            .a4-container {
                padding: 10px;
            }
            
            .report-content {
                font-size: 8pt;
                line-height: 1.05;
                padding-left: 5px;
            }
            
            .patient-data-table td {
                font-size: 7pt;
                padding: 2px;
            }
            
            .codigo-cell {
                font-size: 16pt !important;
                padding: 1px 2px;
            }
            
            .report-section h3 {
                font-size: 11pt;
                margin-bottom: 8px;
            }
            
            .diagnosis-title {
                font-size: 10pt;
                margin-bottom: 10px;
            }
            
            .signature-image {
                width: 120px; /* Reducido 20% desde 150px original */
                height: auto;
            }
            
            /* Responsive para fotos en m√≥viles */
            .photos-grid {
                flex-direction: column;
                align-items: center;
                gap: 15px;
            }
            
            .photo-item {
                max-width: 150px;
            }
            
            .attached-photo {
                max-width: 140px;
                max-height: 140px;
            }
        }
    </style>
</head>
<body>
    <!-- Botones de acci√≥n responsivos -->
    <div class="button-container">
        <button class="btn-back" onclick="goBack()">
            <i class="fas fa-arrow-left"></i> Volver
        </button>
        <button class="btn-edit" onclick="editReport()">
            <i class="fas fa-edit"></i> Editar
        </button>
        <button class="btn-print" onclick="generarPDF()">
            <i class="fas fa-file-pdf"></i> Generar PDF
        </button>
    </div>
    
    <div class="a4-container">
        <div class="preliminary-report" id="preliminary-report-content">
            <div class="report-header">
                <img src="./informe-preliminar_files/encabezado.png" alt="JC PATH LAB - Encabezado">
            </div>
            
            <div class="patient-info">
                <h3>DATOS DEL PACIENTE</h3>
                <table class="patient-data-table">
                    <tbody><tr>
                        <td class="info-cell" width="70%">
                            <strong>APELLIDOS Y NOMBRES:</strong> VARGAS LOZANO ROSA
                        </td>
                        <td rowspan="2" class="codigo-cell" width="30%">
                            2KQ-402
                        </td>
                    </tr>
                    <tr>
                        <td class="info-cell">
                            <strong>SEXO:</strong> FEMENINO
                        </td>
                    </tr>
                    <tr>
                        <td class="info-cell">
                            <strong>FECHA RECEPCI√ìN:</strong> <span class="fecha-formateada">04-08-2025</span>
                        </td>
                        <td class="info-cell">
                            <strong>FECHA INFORME:</strong> <span class="fecha-formateada">06-08-2025</span>
                        </td>
                    </tr>
                    <tr>
                        <td class="info-cell">
                            <strong>M√âDICO:</strong> -
                        </td>
                        <td class="info-cell">
                            <strong>CL√çNICA:</strong> -
                        </td>
                    </tr>
                </tbody></table>
            </div>
            
            <div class="report-section">
                <h3>DESCRIPCI√ìN MACROSC√ìPICA</h3>
                <img src="./informe-preliminar_files/linea1.png" alt="L√≠nea decorativa" class="decorative-line">
                <div class="report-content">Se reciben m√∫ltiples fragmentos irregulares de tejido, de coloraci√≥n marr√≥n rojiza, de consistencia blanda, el mayor de 0.8 x 0.5 x 0.3 cm.</div>
            </div>
            
            <div class="report-section">
                <h3>DESCRIPCI√ìN MICROSC√ìPICA</h3>
                <img src="./informe-preliminar_files/linea2.png" alt="L√≠nea decorativa" class="decorative-line">
                <div class="report-content">Se observa tejido de granulaci√≥n con abundantes c√©lulas inflamatorias cr√≥nicas (linfocitos, plasmocitos) y presencia de c√©lulas gigantes multinucleadas. No se observa evidencia de malignidad.</div>
            </div>
            
            <div class="diagnosis-section">
                <div class="diagnosis-title">DIAGN√ìSTICO HISTOL√ìGICO:</div>
                <div class="report-content">Granuloma pi√≥geno.</div>
            </div>
            
            <!-- Pie de p√°gina dentro del A4 -->
            <div class="report-footer-container">
                <div class="signature-section">
                    <img src="./informe-preliminar_files/firma.png" alt="Firma del Dr. Joseph Castillo" class="signature-image">
                </div>
                
                <div class="page-footer">
                    <img src="./informe-preliminar_files/piedepagina.png" alt="Pie de p√°gina" class="footer-image">
                </div>
                
                <div class="document-footer">
                    <div class="footer-left">
                        2KQ-402 VARGAS LOZANO ROSA
                    </div>
                    <div class="footer-right">
                        <span>p√°gina 1 de 1</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="button-container">
        <button onclick="volverAlInformePatologico()" class="btn" id="return-btn">
            <i class="fas fa-arrow-left"></i> Volver
        </button>
        <button onclick="generarPDF()" class="btn btn-print">
            <i class="fas fa-print"></i> Imprimir
        </button>
    </div>

    <script>
        // üîê SISTEMA DE SEGURIDAD PARA INFORME PRELIMINAR
        let currentUser = null;
        let userPermissions = 'lectura';
        
        // Validar sesi√≥n antes de mostrar datos
        function validateSessionForReport() {
            try {
                const userData = sessionStorage.getItem('current_user');
                if (!userData) {
                    console.warn('üîê No hay sesi√≥n activa en informe preliminar');
                    alert('Sesi√≥n expirada. Ser√° redirigido al sistema de login.');
                    window.location.href = 'index.html';
                    return false;
                }
                
                const user = JSON.parse(userData);
                currentUser = user;
                userPermissions = user.permissions || 'lectura';
                
                console.log('üîê Sesi√≥n v√°lida en informe preliminar:', {
                    usuario: currentUser.username,
                    permisos: userPermissions
                });
                
                return true;
            } catch (error) {
                console.error('üîê Error validando sesi√≥n en informe preliminar:', error);
                window.location.href = 'index.html';
                return false;
            }
        }
        
        // Registrar acceso al informe preliminar
        function logReportAccess() {
            const logEntry = {
                timestamp: new Date().toISOString(),
                user: currentUser ? currentUser.username : 'unknown',
                action: 'VIEW_REPORT',
                type: 'PRELIMINARY_REPORT',
                itemId: datosPaciente.codAtencion || 'unknown'
            };
            
            const securityLog = JSON.parse(localStorage.getItem('security_log') || '[]');
            securityLog.push(logEntry);
            localStorage.setItem('security_log', JSON.stringify(securityLog));
            
            console.log('üîê Acceso a informe preliminar registrado:', logEntry);
        }
        
        // üîÑ SISTEMA ROBUSTO PARA CARGAR DATOS DE PACIENTE
        let datosPaciente = {};
        
        // Funci√≥n para cargar datos desde el sistema de persistencia
        function cargarDatosPaciente() {
            // üîê Validar sesi√≥n antes de cargar datos
            if (!validateSessionForReport()) {
                return false;
            }
            
            try {
                // 1. Intentar cargar desde datos transferidos (m√©todo principal)
                let datosTransferidos = localStorage.getItem('preliminar_current');
                if (!datosTransferidos) {
                    datosTransferidos = sessionStorage.getItem('preliminar_current');
                }
                
                if (datosTransferidos) {
                    const datos = JSON.parse(datosTransferidos);
                    console.log('‚úÖ Datos cargados desde transferencia:', datos);
                    
                    // Extraer informaci√≥n del informe si existe
                    const informe = datos.informe || {};
                    
                    datosPaciente = {
                        codAtencion: datos.codAtencion || '25Q-001',
                        dni: datos.dni || '',
                        sexo: (datos.sexo || 'MASCULINO').toUpperCase(),
                        apellidos: (datos.apellidos || '').toUpperCase(),
                        nombres: (datos.nombres || '').toUpperCase(),
                        edad: datos.edad || '',
                        medicoSolicitante: datos.medicoSolicitante || '-',
                        clinica: datos.clinica || '-',
                        macro: informe.macro ? preserveFormattingHTML(informe.macro) : 'Descripci√≥n macrosc√≥pica no disponible.',
                        micro: informe.micro ? preserveFormattingHTML(informe.micro) : 'Descripci√≥n microsc√≥pica no disponible.',
                        diagnostico: informe.diagnostico ? preserveFormattingHTML(informe.diagnostico) : 'Diagn√≥stico no disponible.',
                        fechaRecepcion: formatearFecha(datos.fechaRegistro) || getCurrentDateFormatted(),
                        fechaInforme: getDeliveryDateFormatted(datos.fechaRegistro) || getDeliveryDateFormatted(),
                        // üì∑ INCLUIR FOTOS TRANSFERIDAS
                        photos: datos.photos || {},
                        // üîÑ SEGUIMIENTO DE ORIGEN PARA NAVEGACI√ìN INTELIGENTE
                        sourceType: datos.tipo || 'surgical',
                        returnUrl: 'pagina2.html#ver-informe'
                    };
                    
                    console.log('üì∑ Fotos cargadas en informe preliminar:', Object.keys(datosPaciente.photos));
                    console.log('üì∑ Detalle de fotos cargadas:', datosPaciente.photos);
                    
                    // üîê Registrar acceso exitoso al informe
                    logReportAccess();
                    
                    return true;
                }
                
                // 2. Si no hay datos transferidos, intentar desde par√°metros URL
                const params = getQueryParams();
                if (Object.keys(params).length > 0) {
                    datosPaciente = {
                        codAtencion: params.codAtencion || '25Q-001',
                        dni: params.dni || '',
                        sexo: (params.sexo || 'MASCULINO').toUpperCase(),
                        apellidos: (params.apellidos || '').toUpperCase(),
                        nombres: (params.nombres || '').toUpperCase(),
                        edad: params.edad || '',
                        medicoSolicitante: params.medicoSolicitante || '-',
                        clinica: params.clinica || '-',
                        macro: params.macro || 'Descripci√≥n macrosc√≥pica no disponible.',
                        micro: params.micro || 'Descripci√≥n microsc√≥pica no disponible.',
                        diagnostico: params.diagnostico || 'Diagn√≥stico no disponible.',
                        fechaRecepcion: formatearFecha(params.fechaRecepcion) || getCurrentDateFormatted(),
                        fechaInforme: formatearFecha(params.fechaInforme) || getDeliveryDateFormatted()
                    };
                    
                    console.log('‚úÖ Datos cargados desde URL');
                    return true;
                }
                
                // 3. Datos por defecto si no se encontr√≥ nada
                datosPaciente = {
                    codAtencion: '25Q-001',
                    dni: '',
                    sexo: 'FEMENINO',
                    apellidos: 'EJEMPLO',
                    nombres: 'PACIENTE',
                    edad: '40',
                    medicoSolicitante: '-',
                    clinica: '-',
                    macro: 'Descripci√≥n macrosc√≥pica pendiente.',
                    micro: 'Descripci√≥n microsc√≥pica pendiente.',
                    diagnostico: 'Diagn√≥stico pendiente.',
                    fechaRecepcion: getCurrentDateFormatted(),
                    fechaInforme: getDeliveryDateFormatted()
                };
                
                console.log('‚ö†Ô∏è Usando datos por defecto');
                return false;
                
            } catch (error) {
                console.error('‚ùå Error al cargar datos del paciente:', error);
                // Inicializar con datos de emergencia
                datosPaciente = {
                    codAtencion: '25Q-ERROR',
                    dni: '',
                    sexo: 'NO ESPECIFICADO',
                    apellidos: 'ERROR',
                    nombres: 'CARGA',
                    edad: '',
                    medicoSolicitante: '-',
                    clinica: '-',
                    macro: 'Error al cargar descripci√≥n macrosc√≥pica.',
                    micro: 'Error al cargar descripci√≥n microsc√≥pica.',
                    diagnostico: 'Error al cargar diagn√≥stico.',
                    fechaRecepcion: getCurrentDateFormatted(),
                    fechaInforme: getDeliveryDateFormatted()
                };
                return false;
            }
        }
        
        // üé® FUNCI√ìN PARA PRESERVAR FORMATO EXACTO DEL INFORME PATOL√ìGICO
        function preserveFormattingHTML(htmlContent) {
            if (!htmlContent) return '';
            
            // Crear un elemento temporal para procesar el HTML
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = htmlContent;
            
            // Limpiar solo elementos peligrosos pero preservar formato
            let cleanHTML = htmlContent
                .replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '') // Remover scripts
                .replace(/<iframe\b[^<]*(?:(?!<\/iframe>)<[^<]*)*<\/iframe>/gi, '') // Remover iframes
                .replace(/<object\b[^<]*(?:(?!<\/object>)<[^<]*)*<\/object>/gi, '') // Remover objetos
                .replace(/<embed\b[^<]*(?:(?!<\/embed>)<[^<]*)*<\/embed>/gi, '') // Remover embeds
                .replace(/<form\b[^<]*(?:(?!<\/form>)<[^<]*)*<\/form>/gi, '') // Remover formularios
                .replace(/<input\b[^<]*(?:(?!<\/input>)<[^<]*)*<\/input>/gi, '') // Remover inputs
                .replace(/javascript:/gi, '') // Remover javascript: URLs
                .replace(/data:/gi, '') // Remover data: URLs potencialmente peligrosas
                .replace(/on\w+="[^"]*"/gi, '') // Remover event handlers
                .replace(/on\w+='[^']*'/gi, ''); // Remover event handlers con comillas simples
            
            // Asegurarse de que el HTML sea v√°lido
            const tempContainer = document.createElement('div');
            tempContainer.innerHTML = cleanHTML;
            
            // Recorrer todos los elementos y limpiar atributos peligrosos
            const allElements = tempContainer.querySelectorAll('*');
            allElements.forEach(element => {
                // Preservar atributos de estilo y formato
                const preservedAttributes = ['style', 'class', 'id', 'align'];
                
                // Remover atributos peligrosos
                Array.from(element.attributes).forEach(attr => {
                    if (attr.name.startsWith('on') || 
                        attr.name === 'src' && attr.value.startsWith('javascript:') ||
                        attr.name === 'href' && attr.value.startsWith('javascript:') ||
                        attr.name === 'data' && attr.value.startsWith('javascript:')) {
                        element.removeAttribute(attr.name);
                    }
                });
            });
            
            return tempContainer.innerHTML;
        }
        
        // FUNCI√ìN OBSOLETA - Mantenida para compatibilidad
        function stripHTML(html) {
            console.warn('‚ö†Ô∏è stripHTML est√° obsoleta, usar preserveFormattingHTML');
            return preserveFormattingHTML(html);
        }
        
        // Funci√≥n para obtener fecha actual formateada
        function getCurrentDateFormatted() {
            const now = new Date();
            const day = String(now.getDate()).padStart(2, '0');
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const year = now.getFullYear();
            return `${day}-${month}-${year}`;
        }
        
        // Funci√≥n para obtener fecha de entrega (2 d√≠as despu√©s)
        function getDeliveryDateFormatted(fechaRegistro) {
            let fecha;
            if (fechaRegistro) {
                // Si viene en formato dd-mm-yyyy, convertir a Date
                const partes = fechaRegistro.split('-');
                if (partes.length === 3) {
                    fecha = new Date(partes[2], partes[1] - 1, partes[0]);
                } else {
                    fecha = new Date(fechaRegistro);
                }
            } else {
                fecha = new Date();
            }
            
            fecha.setDate(fecha.getDate() + 2);
            
            const day = String(fecha.getDate()).padStart(2, '0');
            const month = String(fecha.getMonth() + 1).padStart(2, '0');
            const year = fecha.getFullYear();
            return `${day}-${month}-${year}`;
        }

        // Funci√≥n para actualizar el n√∫mero de p√°ginas din√°micamente
        function updatePageCount() {
            const reportContent = document.getElementById('preliminary-report-content');
            if (!reportContent) return;
            
            // Calcular altura aproximada del contenido
            const contentHeight = reportContent.scrollHeight;
            const a4Height = 297 * 3.78; // A4 height in pixels (approx 1122px)
            
            // Estimar n√∫mero de p√°ginas basado en altura del contenido
            const estimatedPages = Math.max(1, Math.ceil(contentHeight / a4Height));
            
            // Actualizar el pie de p√°gina
            const pageNumberElement = document.getElementById('page-number');
            if (pageNumberElement) {
                pageNumberElement.textContent = `p√°gina 1 de ${estimatedPages}`;
            }
            
            console.log(`üìÑ Contenido estimado en ${estimatedPages} p√°gina(s) - Altura: ${contentHeight}px`);
        }
        
        // Funci√≥n para formatear fecha de YYYY-MM-DD a DD-MM-YYYY
        function formatearFecha(fecha) {
            if (!fecha) return '';
            const partes = fecha.split('-');
            if (partes.length === 3) {
                return `${partes[2]}-${partes[1]}-${partes[0]}`;
            }
            return fecha;
        }

        // Funci√≥n para obtener par√°metros de la URL
        function getQueryParams() {
            const params = {};
            const queryString = window.location.search.substring(1);
            const pairs = queryString.split('&');
            
            for (let i = 0; i < pairs.length; i++) {
                const pair = pairs[i].split('=');
                params[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1] || '');
            }
            
            return params;
        }
        
        // Funci√≥n para generar el contenido del informe MEJORADA CON FOTOS
        function generarContenidoInforme() {
            console.log('üìù Generando contenido con datos:', datosPaciente);
            
            // üì∑ GENERAR SECCI√ìN DE FOTOS SI EXISTEN
            let fotosHTML = '';
            if (datosPaciente.photos && Object.keys(datosPaciente.photos).length > 0) {
                console.log('üì∑ Fotos encontradas para el informe:', Object.keys(datosPaciente.photos));
                console.log('üì∑ Contenido completo de fotos:', datosPaciente.photos);
                
                const photos = datosPaciente.photos;
                const photoKeys = Object.keys(photos).filter(key => photos[key] && photos[key].dataURL);
                
                console.log('üì∑ Fotos v√°lidas con dataURL:', photoKeys);
                
                if (photoKeys.length > 0) {
                    fotosHTML = `
                        <div class="photos-section">
                            <h3>FOTOS ADJUNTAS</h3>
                            <div class="photos-grid">
                    `;
                    
                    photoKeys.forEach((photoKey, index) => {
                        const photoData = photos[photoKey];
                        const photoNumber = index + 1;
                        
                        console.log(`üì∑ Procesando foto ${photoNumber}:`, photoKey, 'DataURL length:', photoData.dataURL ? photoData.dataURL.length : 0);
                        
                        fotosHTML += `
                            <div class="photo-item">
                                <div class="photo-label">Foto ${photoNumber}</div>
                                <img src="${photoData.dataURL}" alt="Foto adjunta ${photoNumber}" class="attached-photo">
                            </div>
                        `;
                    });
                    
                    fotosHTML += `
                            </div>
                        </div>
                    `;
                    
                    console.log('üì∑ HTML de fotos generado, longitud:', fotosHTML.length);
                } else {
                    console.log('üì∑ No se encontraron fotos v√°lidas con dataURL');
                }
            } else {
                console.log('üì∑ No hay fotos en datosPaciente.photos');
            }
            
            // Funci√≥n para escapar HTML (solo para datos de texto plano, no para contenido HTML formateado)
            function escapeHtml(text) {
                if (!text) return '';
                const map = {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#039;'
                };
                
                return text.replace(/[&<>"]/g, function(m) { return map[m]; });
            }
            
            // Usar DOMParser para manejar mejor el contenido HTML formateado
            function insertFormattedHTML(content) {
                if (!content) return '';
                
                // Crear un contenedor temporal para procesar el contenido
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = content;
                
                // Procesar estilos para asegurar compatibilidad
                const allElements = tempDiv.querySelectorAll('*');
                allElements.forEach(element => {
                    // Asegurar que los estilos de fuente sean compatibles
                    const computedStyle = window.getComputedStyle(element);
                    
                    // Si el elemento tiene estilo de fuente, asegurarse de que se preserve
                    if (computedStyle.fontFamily || computedStyle.fontSize || computedStyle.fontWeight) {
                        // Crear un estilo en l√≠nea que preserve estos atributos
                        const styleAttrs = [];
                        
                        if (computedStyle.fontFamily && computedStyle.fontFamily !== 'Arial') {
                            styleAttrs.push(`font-family: ${computedStyle.fontFamily}`);
                        }
                        
                        if (computedStyle.fontSize && computedStyle.fontSize !== 'medium') {
                            styleAttrs.push(`font-size: ${computedStyle.fontSize}`);
                        }
                        
                        if (computedStyle.fontWeight && computedStyle.fontWeight !== 'normal') {
                            styleAttrs.push(`font-weight: ${computedStyle.fontWeight}`);
                        }
                        
                        if (computedStyle.fontStyle && computedStyle.fontStyle !== 'normal') {
                            styleAttrs.push(`font-style: ${computedStyle.fontStyle}`);
                        }
                        
                        if (computedStyle.textDecoration && computedStyle.textDecoration !== 'none') {
                            styleAttrs.push(`text-decoration: ${computedStyle.textDecoration}`);
                        }
                        
                        // Aplicar estilos en l√≠nea si hay alguno
                        if (styleAttrs.length > 0) {
                            element.style.cssText = styleAttrs.join('; ');
                        }
                    }
                });
                
                // Para contenido HTML formateado, usar directamente sin escapar
                return tempDiv.innerHTML;
            }
            
            // Generar el contenido del informe con formato preservado
            const macroContent = datosPaciente.macro || 'Descripci√≥n macrosc√≥pica no disponible.';
            const microContent = datosPaciente.micro || 'Descripci√≥n microsc√≥pica no disponible.';
            const diagContent = datosPaciente.diagnostico || 'Diagn√≥stico no disponible.';
            
            // Usar innerHTML directamente para preservar el formato HTML
            return `
                <div class="report-header">
                    <img src="encabezado.png" alt="JC PATH LAB - Encabezado">
                </div>
                
                <div class="patient-info">
                    <h3>DATOS DEL PACIENTE</h3>
                    <table class="patient-data-table">
                        <tr>
                            <td class="info-cell" width="70%">
                                <strong>APELLIDOS Y NOMBRES:</strong> ${escapeHtml(datosPaciente.apellidos)} ${escapeHtml(datosPaciente.nombres)}
                            </td>
                            <td rowspan="2" class="codigo-cell" width="30%">
                                ${escapeHtml(datosPaciente.codAtencion)}
                            </td>
                        </tr>
                        <tr>
                            <td class="info-cell">
                                <strong>SEXO:</strong> ${escapeHtml(datosPaciente.sexo)}
                            </td>
                        </tr>
                        <tr>
                            <td class="info-cell">
                                <strong>FECHA RECEPCI√ìN:</strong> ${escapeHtml(datosPaciente.fechaRecepcion)}
                            </td>
                            <td class="info-cell">
                                <strong>FECHA INFORME:</strong> ${escapeHtml(datosPaciente.fechaInforme)}
                            </td>
                        </tr>
                        <tr>
                            <td class="info-cell">
                                <strong>M√âDICO:</strong> ${escapeHtml(datosPaciente.medicoSolicitante)}
                            </td>
                            <td class="info-cell">
                                <strong>CL√çNICA:</strong> ${escapeHtml(datosPaciente.clinica)}
                            </td>
                        </tr>
                    </table>
                </div>
                
                <div class="report-section">
                    <h3>DESCRIPCI√ìN MACROSC√ìPICA</h3>
                    <img src="linea1.png" alt="L√≠nea decorativa" class="decorative-line">
                    <div class="report-content">${insertFormattedHTML(macroContent)}</div>
                </div>
                
                <div class="report-section">
                    <h3>DESCRIPCI√ìN MICROSC√ìPICA</h3>
                    <img src="linea2.png" alt="L√≠nea decorativa" class="decorative-line">
                    <div class="report-content">${insertFormattedHTML(microContent)}</div>
                </div>
                
                <div class="diagnosis-section">
                    <div class="diagnosis-title">DIAGN√ìSTICO HISTOL√ìGICO:</div>
                    <div class="report-content">${insertFormattedHTML(diagContent)}</div>
                </div>
                
                ${fotosHTML}
                
                <!-- Pie de p√°gina dentro del A4 -->
                <div class="report-footer-container">
                    <div class="signature-section">
                        <img src="firma.png" alt="Firma del Dr. Joseph Castillo" class="signature-image">
                    </div>
                    
                    <div class="page-footer">
                        <img src="piedepagina.png" alt="Pie de p√°gina" class="footer-image">
                    </div>
                    
                    <div class="document-footer">
                        <div class="footer-left">
                            ${escapeHtml(datosPaciente.codAtencion)} ${escapeHtml(datosPaciente.apellidos)} ${escapeHtml(datosPaciente.nombres)}
                        </div>
                        <div class="footer-right">
                            <span id="page-number">p√°gina 1 de ${datosPaciente.photos && Object.keys(datosPaciente.photos).length > 0 ? 'X' : '1'}</span>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // üíæ FUNCI√ìN MEJORADA PARA GENERAR PDF CON FORMATO A4 PERFECTO - CORREGIDA PARA CORS
        function generarPDF() {
            console.log('üíæ Iniciando generaci√≥n de PDF...');
            
            // Verificar que las librer√≠as est√©n cargadas
            if (typeof html2canvas === 'undefined') {
                console.error('‚ùå html2canvas no est√° cargado');
                alert('‚ùå Error: Librer√≠a html2canvas no disponible. Por favor, recargue la p√°gina.');
                return;
            }
            
            if (typeof window.jspdf === 'undefined' && typeof jsPDF === 'undefined') {
                console.error('‚ùå jsPDF no est√° cargado');
                alert('‚ùå Error: Librer√≠a jsPDF no disponible. Por favor, recargue la p√°gina.');
                return;
            }
            
            const element = document.getElementById('preliminary-report-content');
            
            if (!element) {
                console.error('‚ùå Elemento del reporte no encontrado');
                alert('‚ùå Error: Contenido del reporte no encontrado.');
                return;
            }
            
            // üîß CONFIGURACI√ìN MEJORADA PARA EVITAR PROBLEMAS DE CORS
            const options = {
                scale: 2, // Reducir escala para evitar problemas de memoria
                useCORS: true,
                allowTaint: false, // Cambiar a false para evitar canvas contaminado
                logging: false,
                backgroundColor: '#ffffff',
                width: element.scrollWidth,
                height: element.scrollHeight,
                scrollX: 0,
                scrollY: 0,
                windowWidth: 1200,
                windowHeight: 1600,
                foreignObjectRendering: true, // Mejorar renderizado
                imageTimeout: 15000, // Timeout para im√°genes
                removeContainer: true
            };
            
            // Mostrar mensaje de progreso
            const printButton = document.querySelector('.btn-print');
            const originalButtonText = printButton.innerHTML;
            printButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generando PDF...';
            printButton.disabled = true;
            
            // üñºÔ∏è PROCESAR IM√ÅGENES PARA EVITAR CORS
            const images = element.querySelectorAll('img');
            const imagePromises = [];
            
            images.forEach((img, index) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // Crear nueva imagen con crossOrigin
                const newImg = new Image();
                newImg.crossOrigin = 'anonymous';
                
                const imagePromise = new Promise((resolve) => {
                    newImg.onload = function() {
                        try {
                            canvas.width = this.naturalWidth;
                            canvas.height = this.naturalHeight;
                            ctx.drawImage(this, 0, 0);
                            
                            // Reemplazar la imagen original con el canvas
                            const dataURL = canvas.toDataURL('image/png');
                            img.src = dataURL;
                            img.crossOrigin = 'anonymous';
                            resolve();
                        } catch (error) {
                            console.warn(`Imagen ${index} no pudo ser procesada:`, error);
                            // Mantener imagen original como fallback
                            resolve();
                        }
                    };
                    
                    newImg.onerror = function() {
                        console.warn(`Error cargando imagen ${index}`);
                        resolve(); // Continuar aunque la imagen falle
                    };
                    
                    newImg.src = img.src;
                });
                
                imagePromises.push(imagePromise);
            });
            
            // Esperar a que todas las im√°genes se procesen
            Promise.all(imagePromises).then(() => {
                // Esperar un poco m√°s para que las im√°genes se rendericen
                setTimeout(() => {
                    html2canvas(element, options).then(canvas => {
                        try {
                            const imgData = canvas.toDataURL('image/png', 0.95);
                            
                            // üéØ ACCESO CORRECTO A jsPDF
                            let jsPDFClass;
                            if (typeof window.jspdf !== 'undefined' && window.jspdf.jsPDF) {
                                jsPDFClass = window.jspdf.jsPDF;
                            } else if (typeof jsPDF !== 'undefined') {
                                jsPDFClass = jsPDF;
                            } else {
                                throw new Error('jsPDF no est√° disponible');
                            }
                            
                            // Configuraci√≥n A4 precisa (210 x 297 mm)
                            const pdf = new jsPDFClass({
                                orientation: 'portrait',
                                unit: 'mm',
                                format: 'a4',
                                compress: true
                            });
                            
                            // Dimensiones A4 en mm
                            const pdfWidth = 210;
                            const pdfHeight = 297;
                            
                            // Calcular dimensiones manteniendo proporci√≥n
                            const imgWidth = pdfWidth;
                            const imgHeight = (canvas.height * pdfWidth) / canvas.width;
                            
                            let yPosition = 0;
                            
                            // Si la imagen es m√°s alta que una p√°gina A4
                            if (imgHeight > pdfHeight) {
                                // Calcular cu√°ntas p√°ginas necesitamos
                                const totalPages = Math.ceil(imgHeight / pdfHeight);
                                
                                console.log(`üìÑ Creando PDF de ${totalPages} p√°ginas para contenido con fotos`);
                                
                                for (let i = 0; i < totalPages; i++) {
                                    if (i > 0) {
                                        pdf.addPage();
                                    }
                                    
                                    const yOffset = -(i * pdfHeight);
                                    pdf.addImage(imgData, 'PNG', 0, yOffset, imgWidth, imgHeight, '', 'FAST');
                                }
                                
                                // Actualizar el pie de p√°gina con el n√∫mero correcto de p√°ginas
                                for (let pageNum = 1; pageNum <= totalPages; pageNum++) {
                                    pdf.setPage(pageNum);
                                    
                                    // A√±adir pie de p√°gina en cada p√°gina
                                    pdf.setFontSize(8);
                                    pdf.setFont('helvetica', 'normal');
                                    
                                    const footerY = pdfHeight - 15;
                                    const codigo = (datosPaciente.codAtencion || 'SIN-CODIGO').toUpperCase();
                                    const apellido = (datosPaciente.apellidos || '').toUpperCase();
                                    const nombre = (datosPaciente.nombres || '').toUpperCase();
                                    
                                    pdf.text(`${codigo} ${apellido} ${nombre}`, 20, footerY);
                                    pdf.text(`p√°gina ${pageNum} de ${totalPages}`, pdfWidth - 50, footerY);
                                }
                            } else {
                                // Si cabe en una sola p√°gina, centrar verticalmente
                                yPosition = (pdfHeight - imgHeight) / 2;
                                pdf.addImage(imgData, 'PNG', 0, yPosition, imgWidth, imgHeight, '', 'FAST');
                            }
                            
                            // üè∑Ô∏è NOMBRE DEL ARCHIVO: CODIGO_APELLIDO_NOMBRE en MAY√öSCULAS
                            const codigo = (datosPaciente.codAtencion || 'SIN-CODIGO').toUpperCase();
                            const apellido = (datosPaciente.apellidos || 'SIN-APELLIDO').toUpperCase().replace(/\s+/g, '_');
                            const nombre = (datosPaciente.nombres || 'SIN-NOMBRE').toUpperCase().replace(/\s+/g, '_');
                            
                            const fileName = `${codigo}_${apellido}_${nombre}.pdf`
                                .replace(/[^A-Z0-9_\-\.]/g, '_') // Limpiar caracteres especiales
                                .replace(/_+/g, '_') // M√∫ltiples guiones bajos a uno solo
                                .replace(/^_|_$/g, ''); // Remover guiones bajos al inicio y final
                            
                            console.log(`‚úÖ PDF generado: ${fileName}`);
                            
                            // Guardar el PDF
                            pdf.save(fileName);
                            
                            // Restaurar bot√≥n
                            printButton.innerHTML = originalButtonText;
                            printButton.disabled = false;
                            
                            // Mostrar mensaje de √©xito
                            setTimeout(() => {
                                alert(`‚úÖ PDF generado exitosamente:\n${fileName}`);
                            }, 500);
                            
                        } catch (error) {
                            console.error('‚ùå Error al generar PDF:', error);
                            
                            // Restaurar bot√≥n
                            printButton.innerHTML = originalButtonText;
                            printButton.disabled = false;
                            
                            // Intentar m√©todo alternativo sin im√°genes
                            if (error.message.includes('tainted') || error.message.includes('CORS')) {
                                alert('‚ö†Ô∏è Problema con las im√°genes del reporte.\nIntentando generar PDF solo con texto...');
                                generarPDFSinImagenes();
                            } else {
                                alert('‚ùå Error al generar el PDF. Detalles: ' + error.message + '\nPor favor, int√©ntelo nuevamente.');
                            }
                        }
                    }).catch(error => {
                        console.error('‚ùå Error en html2canvas:', error);
                        
                        // Restaurar bot√≥n
                        printButton.innerHTML = originalButtonText;
                        printButton.disabled = false;
                        
                        if (error.message.includes('tainted') || error.message.includes('CORS')) {
                            alert('‚ö†Ô∏è Problema con las im√°genes del reporte.\nIntentando generar PDF solo con texto...');
                            generarPDFSinImagenes();
                        } else {
                            alert('‚ùå Error al procesar la imagen. Detalles: ' + error.message + '\nPor favor, int√©ntelo nuevamente.');
                        }
                    });
                }, 1000); // Esperar 1 segundo para que las im√°genes se procesen
            });
        }
        
        // üìÑ FUNCI√ìN ALTERNATIVA PARA GENERAR PDF SIN IM√ÅGENES
        function generarPDFSinImagenes() {
            try {
                // Acceso a jsPDF
                let jsPDFClass;
                if (typeof window.jspdf !== 'undefined' && window.jspdf.jsPDF) {
                    jsPDFClass = window.jspdf.jsPDF;
                } else if (typeof jsPDF !== 'undefined') {
                    jsPDFClass = jsPDF;
                } else {
                    throw new Error('jsPDF no est√° disponible');
                }
                
                const pdf = new jsPDFClass({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });
                
                // Configurar fuente
                pdf.setFont('helvetica', 'normal');
                
                let yPosition = 20;
                const lineHeight = 7;
                const margin = 20;
                const pageWidth = 210;
                const contentWidth = pageWidth - (margin * 2);
                
                // T√≠tulo del laboratorio
                pdf.setFontSize(16);
                pdf.setFont('helvetica', 'bold');
                pdf.text('JC PATH LAB', margin, yPosition);
                yPosition += lineHeight * 2;
                
                // Datos del paciente
                pdf.setFontSize(12);
                pdf.text('DATOS DEL PACIENTE', margin, yPosition);
                yPosition += lineHeight;
                
                pdf.setFontSize(10);
                pdf.setFont('helvetica', 'normal');
                
                // Informaci√≥n del paciente
                const info = [
                    `APELLIDOS Y NOMBRES: ${datosPaciente.apellidos} ${datosPaciente.nombres}`,
                    `C√ìDIGO: ${datosPaciente.codAtencion}`,
                    `SEXO: ${datosPaciente.sexo}`,
                    `FECHA RECEPCI√ìN: ${datosPaciente.fechaRecepcion}`,
                    `FECHA INFORME: ${datosPaciente.fechaInforme}`,
                    `M√âDICO: ${datosPaciente.medicoSolicitante}`,
                    `CL√çNICA: ${datosPaciente.clinica}`
                ];
                
                info.forEach(line => {
                    const splitText = pdf.splitTextToSize(line, contentWidth);
                    pdf.text(splitText, margin, yPosition);
                    yPosition += lineHeight * splitText.length;
                });
                
                yPosition += lineHeight;
                
                // Descripci√≥n macrosc√≥pica
                pdf.setFont('helvetica', 'bold');
                pdf.text('DESCRIPCI√ìN MACROSC√ìPICA', margin, yPosition);
                yPosition += lineHeight;
                
                pdf.setFont('helvetica', 'normal');
                const macroText = pdf.splitTextToSize(datosPaciente.macro, contentWidth);
                pdf.text(macroText, margin, yPosition);
                yPosition += lineHeight * macroText.length + lineHeight;
                
                // Descripci√≥n microsc√≥pica
                pdf.setFont('helvetica', 'bold');
                pdf.text('DESCRIPCI√ìN MICROSC√ìPICA', margin, yPosition);
                yPosition += lineHeight;
                
                pdf.setFont('helvetica', 'normal');
                const microText = pdf.splitTextToSize(datosPaciente.micro, contentWidth);
                pdf.text(microText, margin, yPosition);
                yPosition += lineHeight * microText.length + lineHeight;
                
                // Diagn√≥stico
                pdf.setFont('helvetica', 'bold');
                pdf.text('DIAGN√ìSTICO HISTOL√ìGICO:', margin, yPosition);
                yPosition += lineHeight;
                
                pdf.setFont('helvetica', 'normal');
                const diagText = pdf.splitTextToSize(datosPaciente.diagnostico, contentWidth);
                pdf.text(diagText, margin, yPosition);
                
                // Nombre del archivo
                const codigo = (datosPaciente.codAtencion || 'SIN-CODIGO').toUpperCase();
                const apellido = (datosPaciente.apellidos || 'SIN-APELLIDO').toUpperCase().replace(/\s+/g, '_');
                const nombre = (datosPaciente.nombres || 'SIN-NOMBRE').toUpperCase().replace(/\s+/g, '_');
                
                const fileName = `${codigo}_${apellido}_${nombre}_TEXT.pdf`
                    .replace(/[^A-Z0-9_\-\.]/g, '_')
                    .replace(/_+/g, '_')
                    .replace(/^_|_$/g, '');
                
                pdf.save(fileName);
                
                alert(`‚úÖ PDF de texto generado exitosamente:\n${fileName}`);
                
            } catch (error) {
                console.error('‚ùå Error en PDF alternativo:', error);
                alert('‚ùå Error al generar PDF alternativo. Int√©ntelo m√°s tarde.');
            }
        }
        
        // üîÑ NAVEGACI√ìN INTELIGENTE DE RETORNO - CORREGIDA
        function volverAlInformePatologico() {
            try {
                // Obtener informaci√≥n del origen
                const sourceType = datosPaciente.sourceType || 'surgical';
                const codAtencion = datosPaciente.codAtencion;
                
                console.log(`üîÑ Volviendo al informe: ${sourceType} - ${codAtencion}`);
                
                // Guardar informaci√≥n para restaurar el contexto en pagina2.html
                const returnContext = {
                    codAtencion: codAtencion,
                    reportType: sourceType,
                    action: 'return_from_preliminary',
                    timestamp: new Date().toISOString(),
                    showInforme: true
                };
                
                // Guardar contexto en m√∫ltiples ubicaciones para m√°xima confiabilidad
                localStorage.setItem('return_context', JSON.stringify(returnContext));
                sessionStorage.setItem('return_context', JSON.stringify(returnContext));
                localStorage.setItem('restore_informe_context', JSON.stringify({
                    codAtencion: codAtencion,
                    tipo: sourceType,
                    timestamp: new Date().toISOString()
                }));
                
                console.log(`üîÑ Navegando de vuelta a pagina2.html`);
                
                // üéØ NAVEGACI√ìN CORRECTA: Cerrar esta ventana y volver a la anterior
                if (window.opener) {
                    // Si se abri√≥ como popup, cerrar y enfocar la ventana padre
                    window.opener.focus();
                    window.close();
                } else {
                    // Si no, navegar directamente a pagina2.html
                    window.location.href = 'pagina2.html';
                }
                
            } catch (error) {
                console.error('‚ùå Error en navegaci√≥n de retorno:', error);
                
                // Fallback: volver a la p√°gina principal
                console.log('üîÑ Usando navegaci√≥n de fallback');
                window.location.href = 'pagina2.html';
            }
        }
        
        // üîß FUNCI√ìN PARA INICIALIZAR LA BASE DE DATOS INDEXEDDB
        async function initializeDatabase() {
            try {
                // Crear o conectar a la base de datos
                const db = new Dexie('JCPathLabDB');
                db.version(1).stores({
                    doctors: '++id, nombreCompleto, especialidad, clinica, fechaRegistro',
                    templates: '++id, nombre, tipo, descripcion, contenido, fechaCreacion',
                    patients: '++id, codAtencion, dni, nombres, apellidos, edad, telefono, sexo, familiarContacto, telefonoContacto, medicoSolicitante, fechaRegistro',
                    surgicalReports: '++id, codAtencion, tipo, fecha, macroscopica, microscopica, diagnostico, medico, firma, fotos',
                    cytologicalReports: '++id, codAtencion, tipo, fecha, descripcion, diagnostico, medico, firma, fotos',
                    photos: '++id, codAtencion, imageData, timestamp'
                });
                
                console.log('‚úÖ Base de datos JCPathLabDB inicializada exitosamente');
            } catch (error) {
                console.error('‚ùå Error al inicializar la base de datos:', error);
            }
        }
        
        // üì± FUNCIONALIDADES M√ìVILES MEJORADAS
        function initializeMobileFeatures() {
            // Mejorar interacciones t√°ctiles
            enhanceTouchInteractions();
            
            // Ajustar layout seg√∫n orientaci√≥n
            handleOrientationChange();
            
            // Detectar dispositivo m√≥vil
            detectMobileDevice();
            
            // Optimizar para impresi√≥n m√≥vil
            optimizeMobilePrint();
        }
        
        function enhanceTouchInteractions() {
            // Mejorar botones para dispositivos t√°ctiles
            const buttons = document.querySelectorAll('.btn-print, .btn-edit, .btn-back');
            buttons.forEach(button => {
                // Agregar efecto de tap visual
                button.addEventListener('touchstart', function() {
                    this.style.transform = 'scale(0.95)';
                    this.style.transition = 'transform 0.1s';
                }, { passive: true });
                
                button.addEventListener('touchend', function() {
                    this.style.transform = 'scale(1)';
                }, { passive: true });
                
                button.addEventListener('touchcancel', function() {
                    this.style.transform = 'scale(1)';
                }, { passive: true });
            });
        }
        
        function handleOrientationChange() {
            function adjustForOrientation() {
                const isLandscape = window.innerWidth > window.innerHeight;
                const isMobile = window.innerWidth <= 768;
                
                if (isMobile && isLandscape) {
                    // Ajustar para m√≥viles en paisaje
                    document.body.style.padding = '5px';
                    const container = document.querySelector('.a4-container');
                    if (container) {
                        container.style.width = '100%';
                        container.style.padding = '10px';
                    }
                    
                    const buttonContainer = document.querySelector('.button-container');
                    if (buttonContainer) {
                        buttonContainer.style.flexDirection = 'row';
                        buttonContainer.style.padding = '8px';
                    }
                } else if (isMobile) {
                    // Restaurar para m√≥viles en retrato
                    document.body.style.padding = '10px';
                    const container = document.querySelector('.a4-container');
                    if (container) {
                        container.style.width = '100%';
                        container.style.padding = '8px';
                    }
                }
            }
            
            // Ejecutar al cargar
            adjustForOrientation();
            
            // Ejecutar al cambiar orientaci√≥n
            window.addEventListener('orientationchange', () => {
                setTimeout(adjustForOrientation, 300);
            });
            
            // Ejecutar al redimensionar
            window.addEventListener('resize', adjustForOrientation);
        }
        
        function detectMobileDevice() {
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            const isTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
            
            if (isMobile || isTouch) {
                document.body.classList.add('mobile-device');
                
                // Optimizar fuentes para m√≥vil
                const reportContent = document.querySelectorAll('.report-content');
                reportContent.forEach(content => {
                    content.style.fontSize = window.innerWidth <= 480 ? '8pt' : '9pt';
                });
            }
        }
        
        function optimizeMobilePrint() {
            // A√±adir estilo para optimizar la impresi√≥n en m√≥viles
            const style = document.createElement('style');
            style.textContent = `
                @media print and (max-width: 768px) {
                    .button-container {
                        display: none !important;
                    }
                    
                    .a4-container {
                        width: 100% !important;
                        padding: 10px !important;
                        box-shadow: none !important;
                        margin: 0 !important;
                    }
                    
                    .report-content {
                        font-size: 9pt !important;
                        line-height: 1.2 !important;
                    }
                    
                    .patient-data-table td {
                        font-size: 8pt !important;
                        padding: 2px !important;
                    }
                }
            `;
            document.head.appendChild(style);
        }
        
        // Funciones de navegaci√≥n para botones
        function goBack() {
            // Verificar si hay historial de navegaci√≥n
            if (document.referrer && document.referrer !== window.location.href) {
                window.history.back();
            } else {
                // Fallback a la p√°gina principal del sistema
                window.location.href = 'pagina2.html';
            }
        }
        
        function editReport() {
            // Redirigir a la p√°gina de edici√≥n con par√°metros
            const urlParams = new URLSearchParams(window.location.search);
            const codAtencion = urlParams.get('codAtencion') || 'SIN-CODIGO';
            const reportType = urlParams.get('reportType') || 'surgical';
            
            // Construir URL de retorno con par√°metros
            const returnUrl = `pagina2.html#ver-informe?codAtencion=${codAtencion}&reportType=${reportType}`;
            window.location.href = returnUrl;
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìÑ Iniciando carga de informe preliminar...');
            
            // üì± Inicializar funcionalidades m√≥viles
            initializeMobileFeatures();
            
            // üîß Inicializar base de datos
            initializeDatabase();
            
            // üîç VERIFICAR LIBRER√çAS AL CARGAR
            console.log('üîç Verificando librer√≠as:');
            console.log('html2canvas disponible:', typeof html2canvas !== 'undefined');
            console.log('jsPDF window.jspdf:', typeof window.jspdf !== 'undefined');
            console.log('jsPDF global:', typeof jsPDF !== 'undefined');
            
            if (typeof html2canvas === 'undefined') {
                console.error('‚ùå html2canvas NO est√° cargado');
            }
            
            if (typeof window.jspdf === 'undefined' && typeof jsPDF === 'undefined') {
                console.error('‚ùå jsPDF NO est√° cargado');
            } else {
                console.log('‚úÖ jsPDF cargado correctamente');
            }
            
            // Cargar datos del paciente
            const datosEncontrados = cargarDatosPaciente();
            
            if (datosEncontrados) {
                console.log('‚úÖ Datos del paciente cargados exitosamente');
            } else {
                console.log('‚ö†Ô∏è Usando datos por defecto o de emergencia');
            }
            
            // Generar contenido del informe
            const informeContainer = document.getElementById('preliminary-report-content');
            // Usar DOMParser para manejar mejor el contenido HTML
            const parser = new DOMParser();
            const doc = parser.parseFromString(generarContenidoInforme(), 'text/html');
            informeContainer.innerHTML = doc.body.innerHTML;
            
            console.log('‚úÖ Informe preliminar generado correctamente');
            
            // üìÑ ACTUALIZAR N√öMERO DE P√ÅGINAS DIN√ÅMICAMENTE
            setTimeout(() => {
                updatePageCount();
            }, 500); // Esperar a que el contenido se renderice completamente
            
            // Limpiar datos temporales despu√©s de usar
            setTimeout(() => {
                localStorage.removeItem('preliminar_current');
                sessionStorage.removeItem('preliminar_current');
            }, 1000);
        });
    </script>
</body>
</html>