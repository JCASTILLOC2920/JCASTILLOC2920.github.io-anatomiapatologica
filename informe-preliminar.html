<!DOCTYPE html>
<html lang="es">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JC PATH LAB | Informe Preliminar</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Dexie.js for IndexedDB wrapper -->
    <script src="https://unpkg.com/dexie@3.2.2/dist/dexie.js"></script>
    <style>:root{--primary:#1e88e5;--primary-dark:#0d47a1;--secondary:#ff9800;--secondary-dark:#f57c00;--text:#333;--text-light:#666;--bg:#f0f2f5;--sidebar-bg:#2c3e50;--sidebar-hover:#34495e;--card-bg:#fff;--border:#e0e0e0;--success:#4caf50;--error:#e53935;--table-header:#e3f2fd}*{margin:0;padding:0;box-sizing:border-box;font-family:Arial,sans-serif}body{background-color:var(--bg);color:var(--text);display:flex;flex-direction:column;justify-content:center;align-items:center;min-height:100vh;padding:20px;font-family:Arial,sans-serif;position:relative}.a4-container{width:21cm;min-height:29.7cm;background:#fff;box-shadow:0 4px 20px rgba(0,0,0,.1);padding:1.5cm;box-sizing:border-box;margin-bottom:20px;font-family:Arial,sans-serif;position:relative;display:flex;flex-direction:column}.preliminary-report{padding:0;background:#fff;font-family:Arial,sans-serif;color:#333;line-height:1.6;width:100%;margin:0 auto;flex:1;display:flex;flex-direction:column}.report-header{text-align:center;margin-bottom:20px;padding-bottom:10px}.report-header img{width:100%;max-width:1044px;height:auto;display:block;margin:0 auto}.patient-info{margin-bottom:20px}.patient-info h3{font-size:13pt;font-weight:700;margin-bottom:10px;border-bottom:1px solid #ddd;padding-bottom:5px;text-align:justify;font-family:Arial,sans-serif}.patient-data-table{width:100%;border-collapse:collapse;margin:15px 0;font-family:Arial,sans-serif}.patient-data-table td{padding:4px;border:1px solid #ddd;vertical-align:top;font-size:9pt;line-height:1.2;font-family:Arial,sans-serif}.patient-data-table .codigo-cell{font-size:16pt;font-weight:700;text-align:center;vertical-align:middle;background-color:#f0f7ff;padding:2px 4px;font-family:Arial,sans-serif}.patient-data-table .info-cell{padding:4px;font-family:Arial,sans-serif}.report-section{margin-bottom:20px}.report-section h3{font-size:13pt;font-weight:700;margin-bottom:10px;padding-bottom:5px;border-bottom:1px solid #ddd;text-align:justify;font-family:Arial,sans-serif}.report-content{padding-left:10px;font-size:10pt;text-align:justify;font-family:Arial,sans-serif}.decorative-line{width:100%;height:auto;margin-bottom:10px}.diagnosis-section{margin-top:20px;padding-top:10px;border-top:1px solid #eee}.diagnosis-title{font-size:13pt;font-weight:700;text-align:center;margin-bottom:10px;font-family:Arial,sans-serif}.report-footer-container{margin-top:auto;padding-top:20px;width:100%}.signature-section{text-align:center;margin-bottom:10px}.signature-image{width:200px;height:auto}.report-footer-line{border-bottom:2px solid #333;margin-bottom:5px}.document-footer{display:flex;justify-content:space-between;font-size:8pt;color:#666}.button-container{position:fixed;top:20px;right:20px;display:flex;flex-direction:column;gap:10px;z-index:1001}.btn-back,.btn-print,.btn-edit{background-color:var(--primary);color:#fff;border:none;border-radius:50%;width:50px;height:50px;font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 10px rgba(0,0,0,.2);transition:all .3s}.btn-back:hover,.btn-print:hover,.btn-edit:hover{background-color:var(--primary-dark);transform:scale(1.1)}#loading-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,.8);display:none;align-items:center;justify-content:center;flex-direction:column;z-index:1002}#loading-overlay i{font-size:40px;color:var(--primary);margin-bottom:15px}#loading-overlay p{font-size:18px;color:var(--text)}.photos-section{page-break-before:auto}.photos-grid{display:flex;gap:10px;margin-top:10px}.report-photo{max-width:50%;height:auto;border:1px solid #ddd}
        @media print {
            body {
                background-color: #fff;
            }
            .button-container {
                display: none;
            }
            .a4-container {
                box-shadow: none;
                margin: 0;
                padding: 1cm;
            }
            .report-content {
                padding-left: 0;
            }
            img {
                visibility: visible !important;
            }
        }
    </style>
</head>
<body>
    <div id="loading-overlay">
        <i class="fas fa-spinner fa-spin"></i>
        <p>Generando PDF, por favor espere...</p>
    </div>
    <!-- Botones de acción responsivos -->
    <div class="button-container">
        <button class="btn-back" onclick="goBack()">
            <i class="fas fa-arrow-left"></i> Volver
        </button>
        <button class="btn-edit" onclick="editReport()">
            <i class="fas fa-edit"></i> Editar
        </button>
        <button class="btn-print" onclick="generarPDF()">
            <i class="fas fa-file-pdf"></i> Generar PDF
        </button>
    </div>
    
    <div class="a4-container">
        <div class="preliminary-report" id="preliminary-report-content">
            
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            function generarContenidoInforme() {
                const data = JSON.parse(sessionStorage.getItem('preliminaryReportData'));
                if (!data) {
                    document.getElementById('preliminary-report-content').innerHTML = '<p>No hay datos para mostrar. Por favor, genere el informe desde la página de detalles del paciente.</p>';
                    return;
                }

                document.getElementById('preliminary-report-content').innerHTML = `
                    <div class="report-header">
                        <img src="/encabezado.png" alt="JC PATH LAB - Encabezado">
                    </div>
                    
                    <div class="patient-info">
                        <h3>DATOS DEL PACIENTE</h3>
                        <table class="patient-data-table">
                            <tbody><tr>
                                <td class="info-cell" width="70%">
                                    <strong>APELLIDOS Y NOMBRES:</strong> ${data.last_name} ${data.first_name}
                                </td>
                                <td rowspan="2" class="codigo-cell" width="30%">
                                    ${data.attention_code}
                                </td>
                            </tr>
                            <tr>
                                <td class="info-cell">
                                    <strong>SEXO:</strong> ${data.gender}
                                </td>
                            </tr>
                            <tr>
                                <td class="info-cell">
                                    <strong>FECHA RECEPCIÓN:</strong> <span class="fecha-formateada">${data.registration_date}</span>
                                </td>
                                <td class="info-cell">
                                    <strong>FECHA INFORME:</strong> <span class="fecha-formateada">${new Date().toLocaleDateString('es-ES', {day: '2-digit', month: '2-digit', year: 'numeric'})}</span>
                                </td>
                            </tr>
                            <tr>
                                <td class="info-cell">
                                    <strong>MÉDICO:</strong> ${data.requesting_doctor}
                                </td>
                                <td class="info-cell">
                                    <strong>CLÍNICA:</strong> ${data.clinic}
                                </td>
                            </tr>
                        </tbody></table>
                    </div>
                    
                    <div class="report-section">
                        <h3>DESCRIPCIÓN MACROSCÓPICA</h3>
                        <img src="/linea1.png" alt="Línea decorativa" class="decorative-line">
                        <div class="report-content">${data.macro_description}</div>
                    </div>
                    
                    <div class="report-section">
                        <h3>DESCRIPCIÓN MICROSCÓPICA</h3>
                        <img src="/linea2.png" alt="Línea decorativa" class="decorative-line">
                        <div class="report-content">${data.micro_description}</div>
                    </div>
                    
                    <div class="diagnosis-section">
                        <div class="diagnosis-title">DIAGNÓSTICO HISTOLÓGICO:</div>
                        <div class="report-content">${data.diagnosis}</div>
                    </div>

                    <div class="report-section photos-section">
                        <h3>FOTOS ADJUNTAS</h3>
                        <div class="photos-grid">
                            ${data.photo1 ? `<img src="${data.photo1}" alt="Foto 1" class="report-photo">` : ''}
                            ${data.photo2 ? `<img src="${data.photo2}" alt="Foto 2" class="report-photo">` : ''}
                        </div>
                    </div>
                    
                    <!-- Pie de página dentro del A4 -->
                    <div class="report-footer-container">
                        <div class="signature-section">
                            <img src="/firma.png" alt="Firma del Dr. Joseph Castillo" class="signature-image">
                        </div>
                        
                        <div class="report-footer-line"></div>
                        
                        <div class="document-footer">
                            <div class="footer-left">
                                ${data.attention_code} ${data.last_name} ${data.first_name}
                            </div>
                            <div class="footer-right">
                                <span>página 1 de 1</span>
                            </div>
                        </div>
                    </div>
                `;
            }

            function generarPDF() {
                const buttonContainer = document.querySelector('.button-container');
                if (buttonContainer) buttonContainer.style.display = 'none';
                window.print();
                if (buttonContainer) buttonContainer.style.display = 'flex';
            }

            generarContenidoInforme();

        });

        function goBack() {
            window.history.back();
        }

        function editReport() {
            // Functionality to edit the report
        }

        function generarPDF() {
            const buttonContainer = document.querySelector('.button-container');
            if (buttonContainer) buttonContainer.style.display = 'none';
            window.print();
            if (buttonContainer) buttonContainer.style.display = 'flex';
        }
    </script>
</body>
</html>