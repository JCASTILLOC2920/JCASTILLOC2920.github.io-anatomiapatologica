<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Plantillas - JC PATH LAB</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Dexie.js for IndexedDB wrapper -->
    <script src="https://unpkg.com/dexie@3.2.2/dist/dexie.js"></script>
    <style>
        /* ESTILOS PARA PLANTILLAS (extra√≠dos de pagina2.html) */
        :root {
            --primary: #1e88e5;
            --primary-dark: #0d47a1;
            --secondary: #ff9800;
            --secondary-dark: #f57c00;
            --text: #333;
            --text-light: #666;
            --bg: #f0f2f5;
            --sidebar-bg: #2c3e50;
            --sidebar-hover: #34495e;
            --card-bg: #ffffff;
            --border: #e0e0e0;
            --success: #4caf50;
            --error: #e53935;
            --table-header: #e3f2fd;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        /* Animaciones sutiles */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideInLeft {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        
        .animated-fadeIn {
            animation: fadeIn 0.5s ease-out;
        }
        
        .animated-slideInLeft {
            animation: slideInLeft 0.5s ease-out;
        }
        
        .animated-slideInRight {
            animation: slideInRight 0.5s ease-out;
        }
        
        .animated-pulse:hover {
            animation: pulse 0.3s ease-in-out;
        }
        
        /* Aplicar animaciones a elementos clave */
        .card {
            transition: all 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }
        
        .btn {
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .add-template-btn {
            transition: all 0.3s ease;
        }
        
        .add-template-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        body {
            background-color: var(--bg);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
            padding: 0;
            margin: 0;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .card {
            background: var(--card-bg);
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        .card-header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .card-header h1 {
            font-size: 1.8rem;
            margin: 0;
        }
        
        .filters {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            padding: 20px;
            background-color: #f9f9f9;
            border-bottom: 1px solid var(--border);
        }
        
        .filter-group {
            flex: 1;
            min-width: 200px;
        }
        
        .filter-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--text-light);
        }
        
        .filter-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 1rem;
        }
        
        .search-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            align-self: flex-end;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .add-template-btn {
            background: linear-gradient(135deg, var(--success), #2e7d32);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .add-template-btn:hover {
            background: linear-gradient(135deg, #43a047, #1b5e20);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .results-container {
            overflow-x: auto;
            padding: 20px;
        }
        
        .results-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1000px;
        }
        
        .results-table th {
            background-color: var(--table-header);
            text-align: left;
            padding: 15px;
            font-weight: 600;
            color: var(--primary-dark);
            border-bottom: 2px solid var(--primary);
            border-right: 1px solid #d1d1d1;
        }
        
        .results-table th:last-child {
            border-right: none;
        }
        
        .results-table td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border);
            border-right: 1px solid #eaeaea;
        }
        
        .results-table td:last-child {
            border-right: none;
        }
        
        .results-table tr:hover {
            background-color: #f5f9ff;
        }
        
        .delete-btn {
            background: #fbe9e7;
            color: #e53935;
            border: none;
            border-radius: 4px;
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
        }
        
        .delete-btn:hover {
            background: #ffcdd2;
            transform: scale(1.1);
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            padding: 20px;
            gap: 10px;
        }
        
        /* üì± DISE√ëO RESPONSIVO MEJORADO PARA TODOS LOS DISPOSITIVOS */
        
        /* Mejoras para dispositivos t√°ctiles */
        @media (hover: none) and (pointer: coarse) {
            .search-btn, .add-template-btn, .page-btn, .delete-btn {
                min-height: 44px; /* Tama√±o m√≠nimo recomendado para touch */
                padding: 14px 20px;
                font-size: 16px;
            }
            
            .filter-group input {
                min-height: 48px;
                padding: 14px;
                font-size: 16px; /* Evita zoom en iOS */
            }
            
            .results-table td {
                padding: 16px 12px;
            }
        }
        
        /* Pantallas muy grandes (4K, Ultrawide) */
        @media (min-width: 1920px) {
            .container {
                max-width: 1600px;
                padding: 0 40px;
            }
            
            .filters {
                padding: 30px;
                gap: 20px;
            }
            
            .results-container {
                padding: 30px;
            }
            
            .results-table {
                min-width: 1200px;
            }
            
            .results-table th, .results-table td {
                padding: 18px 20px;
                font-size: 1.1rem;
            }
        }
        
        /* Pantallas grandes (1400px - 1919px) */
        @media (min-width: 1400px) and (max-width: 1919px) {
            .container {
                max-width: 1400px;
                padding: 0 30px;
            }
            
            .filters {
                padding: 25px;
                gap: 18px;
            }
            
            .results-table {
                min-width: 1100px;
            }
        }
        
        /* Pantallas medianas-grandes (1200px - 1399px) */
        @media (min-width: 1200px) and (max-width: 1399px) {
            .container {
                max-width: 1200px;
                padding: 0 25px;
            }
            
            .results-table {
                min-width: 1000px;
            }
        }
        
        /* Tablets grandes y pantallas laptop */
        @media (min-width: 993px) and (max-width: 1199px) {
            .container {
                max-width: 100%;
                padding: 0 20px;
            }
            
            .filters {
                padding: 20px;
                gap: 15px;
            }
            
            .filter-group {
                min-width: 180px;
            }
            
            .results-table {
                min-width: 900px;
            }
        }
        
        /* Tablets */
        @media (min-width: 769px) and (max-width: 992px) {
            .container {
                padding: 0 15px;
            }
            
            .filters {
                flex-direction: column;
                gap: 15px;
                padding: 20px;
            }
            
            .filter-group {
                min-width: 100%;
            }
            
            .search-btn, .add-template-btn {
                width: 100%;
                justify-content: center;
                margin-top: 10px;
            }
            
            .results-table {
                min-width: 700px;
                font-size: 0.9rem;
            }
            
            .results-table th, .results-table td {
                padding: 12px 10px;
            }
        }
        
        /* M√≥viles y tablets peque√±as */
        @media (max-width: 768px) {
            body {
                padding: 0;
            }
            
            .container {
                padding: 0;
                margin: 0;
            }
            
            .card {
                border-radius: 0;
                margin-bottom: 0;
            }
            
            .card-header {
                padding: 15px;
            }
            
            .card-header h1 {
                font-size: 1.5rem;
            }
            
            .filters {
                flex-direction: column;
                gap: 15px;
                padding: 20px;
            }
            
            .filter-group {
                min-width: 100%;
            }
            
            .search-btn, .add-template-btn {
                width: 100%;
                justify-content: center;
                margin-top: 10px;
                padding: 14px;
                font-size: 16px;
            }
            
            .results-container {
                padding: 15px;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .results-table {
                min-width: 600px;
                font-size: 0.85rem;
            }
            
            .results-table th, .results-table td {
                padding: 10px 8px;
                white-space: nowrap;
            }
            
            .delete-btn {
                padding: 6px 10px;
                font-size: 12px;
            }
            
            .pagination {
                flex-wrap: wrap;
                gap: 8px;
                padding: 15px;
            }
            
            .page-btn {
                padding: 8px 12px;
                font-size: 14px;
            }
        }
        
        /* M√≥viles peque√±os */
        @media (max-width: 480px) {
            .card-header h1 {
                font-size: 1.3rem;
            }
            
            .filters {
                padding: 12px;
            }
            
            .filter-group label {
                font-size: 14px;
            }
            
            .filter-group input {
                padding: 12px;
                font-size: 16px;
            }
            
            .search-btn, .add-template-btn {
                padding: 12px;
                font-size: 15px;
            }
            
            .results-container {
                padding: 10px;
            }
            
            .results-table {
                min-width: 500px;
                font-size: 0.8rem;
            }
            
            .results-table th, .results-table td {
                padding: 8px 6px;
            }
            
            .delete-btn {
                padding: 4px 8px;
                font-size: 11px;
                width: 30px;
                height: 30px;
            }
            
            .pagination {
                padding: 10px;
            }
            
            .page-btn {
                padding: 6px 10px;
                font-size: 13px;
                min-width: 36px;
            }
        }
        
        /* M√≥viles muy peque√±os */
        @media (max-width: 320px) {
            .card-header h1 {
                font-size: 1.2rem;
            }
            
            .filters {
                padding: 10px;
            }
            
            .results-table {
                min-width: 450px;
                font-size: 0.75rem;
            }
            
            .results-table th, .results-table td {
                padding: 6px 4px;
            }

            .editor-toolbar-large {
                padding: 8px;
                gap: 2px;
            }
            .editor-toolbar-large button, .format-select {
                padding: 5px 6px;
                font-size: 0.8rem;
            }
            
            .delete-btn {
                padding: 3px 6px;
                font-size: 10px;
                width: 28px;
                height: 28px;
            }
            
            .pagination {
                padding: 10px;
            }
            
            .page-btn {
                padding: 5px 8px;
                font-size: 12px;
                min-width: 32px;
            }
        }
        
        .page-btn {
            padding: 8px 15px;
            background: #f0f0f0;
            border: 1px solid var(--border);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .page-btn.active, .page-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        /* Estilos para formulario de plantillas */
        .template-form {
            padding: 20px;
            background: white;
            display: none;
        }
        
        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .form-row .form-group {
            flex: 1;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--text-light);
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 2px rgba(30, 136, 229, 0.2);
        }
        
        .editor-large {
            min-height: 300px;
        }
        
        .editor-container {
            border: 1px solid #ddd;
            border-radius: 6px;
            margin-bottom: 15px;
            overflow: hidden;
        }
        
        .editor-toolbar-large {
            background: #f0f0f0;
            padding: 10px;
            border-bottom: 1px solid #ddd;
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        
        .editor-toolbar-large button {
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .editor-toolbar-large button:hover {
            background: #e9f7ff;
            border-color: #1e88e5;
        }
        
        .format-select {
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1rem;
            min-width: 120px;
        }
        
        .format-select:hover {
            background: #e9f7ff;
            border-color: #1e88e5;
        }
        
        .format-select:focus {
            border-color: #1e88e5;
            outline: none;
            box-shadow: 0 0 0 2px rgba(30, 136, 229, 0.2);
        }
        
        .editor-content {
            min-height: 300px;
            padding: 12px;
            background: white;
            outline: none;
        }
        
        .template-actions {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 20px;
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #1976d2, #0d47a1);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .btn-outline {
            background: transparent;
            border: 2px solid var(--error);
            color: var(--error);
        }
        
        .btn-outline:hover {
            background: var(--error);
            color: white;
            transform: translateY(-2px);
        }
        
        .btn i {
            margin-right: 8px;
        }
        
        .tipo-selector {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .tipo-option {
            flex: 1;
            text-align: center;
            padding: 20px;
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .tipo-option:hover {
            border-color: var(--primary);
            background-color: #f5f9ff;
        }
        
        .tipo-option.selected {
            border-color: var(--primary);
            background-color: #e3f2fd;
        }
        
        .tipo-option i {
            font-size: 2rem;
            margin-bottom: 10px;
            color: var(--primary);
        }
        
        .microscopia-fields {
            display: none;
        }
        
        /* Estilos para la nueva secci√≥n de especialidad */
        #nueva-especialidad-section {
            display: none;
            margin-bottom: 20px;
        }
        
        #nueva-especialidad-section .form-group {
            flex: 1;
        }
        
        /* Responsive design */
        @media (max-width: 768px) {
            .filters {
                flex-direction: column;
            }
            
            .filter-group {
                min-width: 100%;
            }
            
            .results-table {
                min-width: 800px;
            }
            
            .form-row {
                flex-direction: column;
            }
            
            .tipo-selector {
                flex-direction: column;
            }
        }
        
        @media (max-width: 480px) {
            .card-header h1 {
                font-size: 1.5rem;
            }
            
            .results-table th, 
            .results-table td {
                padding: 8px 10px;
                font-size: 0.85rem;
            }
            
            .editor-toolbar-large {
                gap: 3px;
            }
            
            .editor-toolbar-large button {
                padding: 6px 8px;
                font-size: 0.9rem;
            }
            
            .format-select {
                padding: 6px 8px;
                font-size: 0.9rem;
                min-width: 100px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <div class="filters">
                <div class="filter-group">
                    <label for="search-nombre-plantilla">Nombre de Plantilla</label>
                    <input type="text" id="search-nombre-plantilla" placeholder="Buscar plantilla..." value="">
                </div>
                
                <button class="search-btn" id="search-btn-plant">
                    <i class="fas fa-search"></i> Buscar
                </button>
                
                <button class="add-template-btn" id="add-template-btn">
                    <i class="fas fa-plus-circle"></i> Agregar Plantilla
                </button>
                
                <button class="add-template-btn" id="view-macro-templates-btn" style="background: linear-gradient(135deg, var(--primary), var(--primary-dark));">
                    <i class="fas fa-eye"></i> Ver Macrosc√≥picas
                </button>
                <button class="add-template-btn" id="view-micro-templates-btn" style="background: linear-gradient(135deg, var(--secondary), var(--secondary-dark));">
                    <i class="fas fa-eye"></i> Ver Microsc√≥picas
                </button>
                

            </div>
            
            <!-- Formulario de plantilla (oculto inicialmente) -->
            <div class="template-form" id="template-form">
                <h3 style="margin-bottom: 20px; text-align: center;">Seleccione el tipo de plantilla</h3>
                
                <div class="tipo-selector">
                    <div class="tipo-option selected" data-tipo="macroscopia">
                        <i class="fas fa-search-plus"></i>
                        <h4>Macroscop√≠a</h4>
                        <p>Descripci√≥n de muestras a simple vista</p>
                    </div>
                    <div class="tipo-option" data-tipo="microscopia">
                        <i class="fas fa-microscope"></i>
                        <h4>Microscop√≠a</h4>
                        <p>Descripci√≥n de muestras al microscopio</p>
                    </div>
                </div>
                
                <input type="hidden" id="plantilla-tipo" value="macroscopia">
                
                <!-- Nueva secci√≥n para agregar especialidad/categor√≠a -->
                <div class="form-row" id="nueva-especialidad-section" style="display: none;">
                    <div class="form-group">
                        <label for="nueva-especialidad">Nueva Especialidad / Categor√≠a</label>
                        <input type="text" id="nueva-especialidad" placeholder="Ingrese nueva especialidad/categor√≠a">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="plantilla-especialidad">Especialidad / Categor√≠a</label>
                        <select id="plantilla-especialidad">
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="plantilla-nombre">Nombre de Plantilla</label>
                        <input type="text" id="plantilla-nombre" placeholder="Nombre descriptivo de la plantilla">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="plantilla-contenido">Contenido de la Plantilla</label>
                    <div class="editor-container">
                        <div class="editor-toolbar-large">
                            <button type="button" class="format-btn" data-command="bold" title="Negrita">
                                <i class="fas fa-bold"></i> Negrita
                            </button>
                            <button type="button" class="format-btn" data-command="italic" title="Cursiva">
                                <i class="fas fa-italic"></i> Cursiva
                            </button>
                            <button type="button" class="format-btn" data-command="underline" title="Subrayado">
                                <i class="fas fa-underline"></i> Subrayado
                            </button>
                            <button type="button" class="format-btn" data-command="insertUnorderedList" title="Lista">
                                <i class="fas fa-list-ul"></i> Lista
                            </button>
                            <button type="button" class="format-btn" data-command="insertOrderedList" title="Lista numerada">
                                <i class="fas fa-list-ol"></i> Numerada
                            </button>
                            <button type="button" class="format-btn" data-command="justifyLeft" title="Alinear a la izquierda">
                                <i class="fas fa-align-left"></i> Izquierda
                            </button>
                            <button type="button" class="format-btn" data-command="justifyRight" title="Alinear a la derecha">
                                <i class="fas fa-align-right"></i> Derecha
                            </button>
                            <button type="button" class="format-btn" data-command="justifyCenter" title="Centrar">
                                <i class="fas fa-align-center"></i> Centrar
                            </button>
                            <button type="button" class="format-btn" data-command="justifyFull" title="Justificar">
                                <i class="fas fa-align-justify"></i> Justificar
                            </button>
                            <select class="format-select" data-command="fontName" title="Tipo de letra">
                                <option value="">Tipo de letra</option>
                                <option value="Arial">Arial</option>
                                <option value="Times New Roman">Times New Roman</option>
                                <option value="Helvetica">Helvetica</option>
                                <option value="Georgia">Georgia</option>
                                <option value="Verdana">Verdana</option>
                                <option value="Courier New">Courier New</option>
                            </select>
                            <select class="format-select" data-command="fontSize" title="Tama√±o de letra">
                                <option value="">Tama√±o</option>
                                <option value="1">8pt</option>
                                <option value="2">10pt</option>
                                <option value="3">12pt</option>
                                <option value="4">14pt</option>
                                <option value="5">18pt</option>
                                <option value="6">24pt</option>
                                <option value="7">36pt</option>
                            </select>
                        </div>
                        <div class="editor-content editor-large" id="plantilla-editor" contenteditable="true"></div>
                    </div>
                </div>
                
                <div class="microscopia-fields" id="microscopia-fields">
                    <div class="form-group">
                        <label for="plantilla-diagnostico">Diagn√≥stico</label>
                        <div class="editor-container">
                            <div class="editor-toolbar-large">
                                <button type="button" class="format-btn" data-command="bold" title="Negrita">
                                    <i class="fas fa-bold"></i> Negrita
                                </button>
                                <button type="button" class="format-btn" data-command="italic" title="Cursiva">
                                    <i class="fas fa-italic"></i> Cursiva
                                </button>
                                <button type="button" class="format-btn" data-command="underline" title="Subrayado">
                                    <i class="fas fa-underline"></i> Subrayado
                                </button>
                                <button type="button" class="format-btn" data-command="insertUnorderedList" title="Lista">
                                    <i class="fas fa-list-ul"></i> Lista
                                </button>
                                <button type="button" class="format-btn" data-command="insertOrderedList" title="Lista numerada">
                                    <i class="fas fa-list-ol"></i> Numerada
                                </button>
                                <button type="button" class="format-btn" data-command="justifyLeft" title="Alinear a la izquierda">
                                    <i class="fas fa-align-left"></i> Izquierda
                                </button>
                                <button type="button" class="format-btn" data-command="justifyRight" title="Alinear a la derecha">
                                    <i class="fas fa-align-right"></i> Derecha
                                </button>
                                <button type="button" class="format-btn" data-command="justifyCenter" title="Centrar">
                                    <i class="fas fa-align-center"></i> Centrar
                                </button>
                                <button type="button" class="format-btn" data-command="justifyFull" title="Justificar">
                                    <i class="fas fa-align-justify"></i> Justificar
                                </button>
                                <select class="format-select" data-command="fontName" title="Tipo de letra">
                                    <option value="">Tipo de letra</option>
                                    <option value="Arial">Arial</option>
                                    <option value="Times New Roman">Times New Roman</option>
                                    <option value="Helvetica">Helvetica</option>
                                    <option value="Georgia">Georgia</option>
                                    <option value="Verdana">Verdana</option>
                                    <option value="Courier New">Courier New</option>
                                </select>
                                <select class="format-select" data-command="fontSize" title="Tama√±o de letra">
                                    <option value="">Tama√±o</option>
                                    <option value="1">8pt</option>
                                    <option value="2">10pt</option>
                                    <option value="3">12pt</option>
                                    <option value="4">14pt</option>
                                    <option value="5">18pt</option>
                                    <option value="6">24pt</option>
                                    <option value="7">36pt</option>
                                </select>
                            </div>
                            <div class="editor-content editor-large" id="plantilla-diagnostico" contenteditable="true"></div>
                        </div>
                    </div>
                </div>
                
                <div class="template-actions">
                    <button class="btn btn-outline" id="cancelar-plantilla-btn">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button class="btn btn-primary" id="guardar-plantilla-btn">
                        <i class="fas fa-save"></i> Guardar Plantilla
                    </button>
                </div>
            </div>
            
            <div class="results-container" id="macro-results-container">
                <h3 style="margin-bottom: 10px;">Plantillas Macrosc√≥picas</h3>
                <table class="results-table" id="plantillas-macro-results-table">
                    <thead>
                        <tr>
                            <th>N¬∫</th>
                            <th>ESPECIALIDAD</th>
                            <th>NOMBRE DE PLANTILLA</th>
                            <th>ACCIONES</th>
                            <th>ELIMINAR</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Los datos se cargar√°n din√°micamente -->
                    </tbody>
                </table>
            </div>

            <div class="results-container" id="micro-results-container" style="display: none;">
                <h3 style="margin-bottom: 10px;">Plantillas Microsc√≥picas</h3>
                <table class="results-table" id="plantillas-micro-results-table">
                    <thead>
                        <tr>
                            <th>N¬∫</th>
                            <th>ESPECIALIDAD</th>
                            <th>NOMBRE DE PLANTILLA</th>
                            <th>ACCIONES</th>
                            <th>ELIMINAR</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Los datos se cargar√°n din√°micamente -->
                    </tbody>
                </table>
            </div>
            
            <div class="pagination" id="pagination-plant">
                <button class="page-btn active">1</button>
                <button class="page-btn">2</button>
                <button class="page-btn">3</button>
                <button class="page-btn">4</button>
                <button class="page-btn">5</button>
                <button class="page-btn">Siguiente</button>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let plantillasData = [];
        let currentPlantillaId = null;
        const token = sessionStorage.getItem('token'); // Assumes token is in sessionStorage from parent

        // --- API Functions ---
        async function fetchTemplates() {
            try {
                const response = await fetch('https://mustafa-lackadaisical-laquita.ngrok-free.dev/api/templates', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    const data = await response.json();
                    plantillasData = data.templates;
                    renderTemplates();
                    renderSpecialtiesDropdown(); // <-- Add this call
                } else {
                    console.error('Error fetching templates:', response.statusText);
                    alert('No se pudieron cargar las plantillas desde el servidor.');
                }
            } catch (error) {
                console.error('Error de red al cargar plantillas:', error);
                alert('Error de conexi√≥n al cargar las plantillas.');
            }
        }

        async function saveTemplate() {
            const tipo = document.getElementById('plantilla-tipo').value;
            let especialidad = document.getElementById('plantilla-especialidad').value;
            const nombre = document.getElementById('plantilla-nombre').value;
            const contenido = document.getElementById('plantilla-editor').innerHTML;
            const diagnostico = tipo === 'microscopia' ? document.getElementById('plantilla-diagnostico').innerHTML : '';

            if (especialidad === 'nueva') {
                const nuevaEspecialidad = document.getElementById('nueva-especialidad').value.trim();
                if (!nuevaEspecialidad) {
                    alert('Por favor, ingrese el nombre de la nueva especialidad');
                    return;
                }
                especialidad = nuevaEspecialidad;
            }

            if (!especialidad || !nombre || !contenido) {
                alert('Por favor, complete todos los campos obligatorios');
                return;
            }
            if (tipo === 'microscopia' && !diagnostico) {
                alert('Por favor, complete el campo de diagn√≥stico para plantillas de microscop√≠a');
                return;
            }

            const templateData = { nombre, tipo, especialidad, contenido, diagnostico };

            const url = currentPlantillaId
                ? `https://mustafa-lackadaisical-laquita.ngrok-free.dev/api/templates/${currentPlantillaId}`
                : 'https://mustafa-lackadaisical-laquita.ngrok-free.dev/api/templates';
            const method = currentPlantillaId ? 'PUT' : 'POST';

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(templateData)
                });
                const result = await response.json();
                alert(result.message || result.error);
                if (response.ok) {
                    toggleFormularioPlantilla(false);
                    fetchTemplates(); // Refresh list
                    if (window.parent && window.parent.refreshTemplates) {
                        window.parent.refreshTemplates();
                    }
                }
            } catch (error) {
                console.error('Error saving template:', error);
                alert('Error de conexi√≥n al guardar la plantilla.');
            }
        }

        async function deleteTemplate(id) {
            if (!confirm('¬øEst√° seguro de que desea eliminar esta plantilla?')) return;

            try {
                const response = await fetch(`https://mustafa-lackadaisical-laquita.ngrok-free.dev/api/templates/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const result = await response.json();
                alert(result.message || result.error);
                if (response.ok) {
                    fetchTemplates(); // Refresh list
                }
            } catch (error) {
                console.error('Error deleting template:', error);
                alert('Error de conexi√≥n al eliminar la plantilla.');
            }
        }

        // --- UI Functions ---
        function renderTemplates() {
            const macroTabla = document.getElementById('plantillas-macro-results-table').getElementsByTagName('tbody')[0];
            const microTabla = document.getElementById('plantillas-micro-results-table').getElementsByTagName('tbody')[0];
            macroTabla.innerHTML = '';
            microTabla.innerHTML = '';

            const terminoBusqueda = document.getElementById('search-nombre-plantilla').value.toLowerCase();
            const plantillasFiltradas = plantillasData.filter(plantilla =>
                plantilla.nombre.toLowerCase().includes(terminoBusqueda) ||
                (plantilla.especialidad && plantilla.especialidad.toLowerCase().includes(terminoBusqueda))
            );

            const macroPlantillas = plantillasFiltradas.filter(p => p.tipo === 'macroscopia');
            const microPlantillas = plantillasFiltradas.filter(p => p.tipo === 'microscopia');

            if (macroPlantillas.length === 0) {
                macroTabla.innerHTML = `<tr><td colspan="5" style="text-align: center; padding: 20px;">No se encontraron plantillas macrosc√≥picas.</td></tr>`;
            } else {
                macroPlantillas.forEach((plantilla, index) => {
                    const fila = macroTabla.insertRow();
                    fila.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${plantilla.especialidad}</td>
                        <td>${plantilla.nombre}</td>
                        <td>
                            <button class="btn btn-secondary editar-plantilla-btn" data-id="${plantilla.id}" style="background: #ffc107; margin-left: 5px;">
                                <i class="fas fa-edit"></i> Editar
                            </button>
                        </td>
                        <td>
                            <button class="delete-btn eliminar-plantilla-btn" data-id="${plantilla.id}">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </td>
                    `;
                });
            }

            if (microPlantillas.length === 0) {
                microTabla.innerHTML = `<tr><td colspan="5" style="text-align: center; padding: 20px;">No se encontraron plantillas microsc√≥picas.</td></tr>`;
            } else {
                microPlantillas.forEach((plantilla, index) => {
                    const fila = microTabla.insertRow();
                    fila.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${plantilla.especialidad}</td>
                        <td>${plantilla.nombre}</td>
                        <td>
                            <button class="btn btn-secondary editar-plantilla-btn" data-id="${plantilla.id}" style="background: #ffc107; margin-left: 5px;">
                                <i class="fas fa-edit"></i> Editar
                            </button>
                        </td>
                        <td>
                            <button class="delete-btn eliminar-plantilla-btn" data-id="${plantilla.id}">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </td>
                    `;
                });
            }
            
            // Add event listeners after rendering
            addTableButtonListeners();
        }

        function renderSpecialtiesDropdown() {
            const select = document.getElementById('plantilla-especialidad');
            const currentValue = select.value; // Preserve current selection if possible

            // Get unique specialties from data
            const specialties = [...new Set(plantillasData.map(p => p.especialidad).filter(Boolean))];

            // Build the new options
            let optionsHtml = '<option value="">Seleccionar especialidad</option>';
            specialties.forEach(s => {
                optionsHtml += `<option value="${s}">${s}</option>`;
            });
            optionsHtml += '<option value="nueva">-- Agregar nueva especialidad --</option>';

            select.innerHTML = optionsHtml;
            select.value = currentValue; // Restore selection
        }

        function addTableButtonListeners() {
            document.querySelectorAll('.eliminar-plantilla-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    deleteTemplate(this.getAttribute('data-id'));
                });
            });

            document.querySelectorAll('.editar-plantilla-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    editTemplate(this.getAttribute('data-id'));
                });
            });
        }

        function editTemplate(id) {
            const plantilla = plantillasData.find(p => p.id == id);
            if (plantilla) {
                currentPlantillaId = id;
                document.getElementById('plantilla-tipo').value = plantilla.tipo;
                document.getElementById('plantilla-especialidad').value = plantilla.especialidad;
                document.getElementById('plantilla-nombre').value = plantilla.nombre;
                document.getElementById('plantilla-editor').innerHTML = plantilla.contenido;
                document.getElementById('plantilla-diagnostico').innerHTML = plantilla.diagnostico || '';

                cambiarTipoPlantilla(plantilla.tipo);
                toggleFormularioPlantilla(true, true);
            }
        }

        function toggleFormularioPlantilla(mostrar, isEdit = false) {
            document.getElementById('template-form').style.display = mostrar ? 'block' : 'none';
            document.getElementById('macro-results-container').style.display = mostrar ? 'none' : 'block';
            document.getElementById('micro-results-container').style.display = 'none';
            document.getElementById('pagination-plant').style.display = mostrar ? 'none' : 'flex';

            if (!mostrar) {
                currentPlantillaId = null;
                document.getElementById('plantilla-especialidad').value = '';
                document.getElementById('plantilla-nombre').value = '';
                document.getElementById('plantilla-editor').innerHTML = '';
                document.getElementById('plantilla-diagnostico').innerHTML = '';
                document.getElementById('nueva-especialidad-section').style.display = 'none';
                cambiarTipoPlantilla('macroscopia');
            } else {
                document.querySelector('#template-form h3').textContent = isEdit ? 'Editar Plantilla' : 'Agregar Nueva Plantilla';
            }
        }

        function cambiarTipoPlantilla(tipo) {
            document.getElementById('plantilla-tipo').value = tipo;
            document.querySelectorAll('.tipo-option').forEach(opt => opt.classList.remove('selected'));
            document.querySelector(`.tipo-option[data-tipo="${tipo}"]`).classList.add('selected');
            document.getElementById('microscopia-fields').style.display = tipo === 'microscopia' ? 'block' : 'none';
        }

        function toggleNuevaEspecialidad() {
            const especialidadSelect = document.getElementById('plantilla-especialidad');
            document.getElementById('nueva-especialidad-section').style.display = especialidadSelect.value === 'nueva' ? 'flex' : 'none';
        }

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', function() {
            if (!token) {
                alert('Error de autenticaci√≥n. Por favor, inicie sesi√≥n de nuevo.');
                // This page is in an iframe, so we can't redirect the parent.
                // The parent page should handle this.
                return;
            }

            fetchTemplates();

            // Event Listeners for editor toolbars
            document.querySelectorAll('.format-btn').forEach(button => {
                button.addEventListener('click', function(e) {
                    e.preventDefault(); // Prevent loss of selection
                    const command = this.getAttribute('data-command');
                    const editor = this.closest('.editor-container').querySelector('.editor-content');
                    if (editor) {
                        editor.focus();
                        document.execCommand(command, false, null);
                    }
                });
            });

            document.querySelectorAll('.format-select').forEach(select => {
                select.addEventListener('change', function(e) {
                    e.preventDefault(); // Prevent loss of selection
                    const command = this.getAttribute('data-command');
                    const value = this.value;
                    const editor = this.closest('.editor-container').querySelector('.editor-content');
                    if (editor && value) {
                        editor.focus();
                        document.execCommand(command, false, value);
                        this.value = ''; // Reset select to avoid re-applying
                    }
                });
            });
            document.querySelectorAll('.tipo-option').forEach(option => {
                option.addEventListener('click', function() { cambiarTipoPlantilla(this.getAttribute('data-tipo')); });
            });
            document.getElementById('plantilla-especialidad').addEventListener('change', toggleNuevaEspecialidad);
            document.getElementById('add-template-btn').addEventListener('click', () => toggleFormularioPlantilla(true, false));
            document.getElementById('view-macro-templates-btn').addEventListener('click', () => {
                toggleFormularioPlantilla(false);
                document.getElementById('macro-results-container').style.display = 'block';
                document.getElementById('micro-results-container').style.display = 'none';
            });
            document.getElementById('view-micro-templates-btn').addEventListener('click', () => {
                toggleFormularioPlantilla(false);
                document.getElementById('macro-results-container').style.display = 'none';
                document.getElementById('micro-results-container').style.display = 'block';
            });
            document.getElementById('cancelar-plantilla-btn').addEventListener('click', () => toggleFormularioPlantilla(false));
            document.getElementById('guardar-plantilla-btn').addEventListener('click', saveTemplate);
            document.getElementById('search-btn-plant').addEventListener('click', renderTemplates);
            document.getElementById('search-nombre-plantilla').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') renderTemplates();
            });
        });
    </script>
</body>
</html>

