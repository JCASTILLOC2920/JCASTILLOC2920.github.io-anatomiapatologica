const APP_CONFIG={STORAGE_KEY:"lab_users_data",BACKUP_KEY:"lab_users_backup",SESSION_KEY:"lab_current_session",VERSION:"2.0.0"};class UserManager{constructor(){this.users=new Map,this.currentUser=null,this.isInitialized=!1,this.init()}async init(){try{console.log("üöÄ Inicializando sistema de usuarios..."),await this.loadUsersFromStorage(),await this.ensureAdminUser(),this.setupEventListeners(),this.isInitialized=!0,console.log("‚úÖ Sistema de usuarios inicializado")}catch(e){console.error("‚ùå Error inicializando sistema:",e),this.handleError(e)}}async loadUsersFromStorage(){try{const e=localStorage.getItem(APP_CONFIG.STORAGE_KEY);e?(this.users=new Map(JSON.parse(e).users||[]),console.log(`üìä Usuarios cargados: ${this.users.size}`)):(console.log("üìù No hay usuarios almacenados, creando estructura inicial"),this.users=new Map)}catch(e){console.error("‚ùå Error cargando usuarios:",e),this.users=new Map}}async saveUsersToStorage(){try{const e={users:Array.from(this.users.entries()),lastUpdate:(new Date).toISOString(),version:APP_CONFIG.VERSION};localStorage.setItem(APP_CONFIG.STORAGE_KEY,JSON.stringify(e)),localStorage.setItem(APP_CONFIG.BACKUP_KEY,JSON.stringify(e)),console.log("üíæ Usuarios guardados en localStorage")}catch(e){throw console.error("‚ùå Error guardando usuarios:",e),e}}async ensureAdminUser(){this.users.has("josehpcastillo")||(console.log("üë§ Creando usuario administrador..."),this.users.set("josehpcastillo",{username:"josehpcastillo",password:"41457466",permissions:"admin",status:"active",lastLogin:null,createdAt:(new Date).toISOString()}),await this.saveUsersToStorage(),console.log("‚úÖ Usuario administrador creado"))}async authenticateUser(e,t){try{const s=this.users.get(e);if(!s)throw new Error("Usuario no encontrado");if(s.password!==t)throw new Error("Contrase√±a incorrecta");if("active"!==s.status)throw new Error("Usuario inactivo");return s.lastLogin=(new Date).toISOString(),await this.saveUsersToStorage(),this.currentUser={username:s.username,permissions:s.permissions,loginTime:(new Date).toISOString(),sessionId:"session_"+Date.now()},sessionStorage.setItem(APP_CONFIG.SESSION_KEY,JSON.stringify(this.currentUser)),console.log(`üîê Usuario autenticado: ${e}`),this.currentUser}catch(e){throw console.error("‚ùå Error de autenticaci√≥n:",e),e}}async createUser(e,t){try{if(this.users.has(e))throw new Error("El usuario ya existe");if(e.length<3)throw new Error("El nombre de usuario debe tener al menos 3 caracteres");if(t.length<6)throw new Error("La contrase√±a debe tener al menos 6 caracteres");const s={username:e,password:t,permissions:"lectura",status:"active",lastLogin:null,createdAt:(new Date).toISOString()};return this.users.set(e,s),await this.saveUsersToStorage(),console.log(`‚úÖ Usuario creado: ${e}`),s}catch(e){throw console.error("‚ùå Error creando usuario:",e),e}}async deleteUser(e){try{if("josehpcastillo"===e)throw new Error("No se puede eliminar el usuario administrador");if(!this.users.has(e))throw new Error("Usuario no encontrado");return this.users.delete(e),await this.saveUsersToStorage(),console.log(`‚úÖ Usuario eliminado: ${e}`),!0}catch(e){throw console.error("‚ùå Error eliminando usuario:",e),e}}getUsersList(){return Array.from(this.users.values()).map(e=>({username:e.username,permissions:e.permissions,status:e.status,lastLogin:e.lastLogin,createdAt:e.createdAt}))}logout(){this.currentUser=null,sessionStorage.removeItem(APP_CONFIG.SESSION_KEY),console.log("üîì Sesi√≥n cerrada")}hasActiveSession(){const e=sessionStorage.getItem(APP_CONFIG.SESSION_KEY);if(e)try{return this.currentUser=JSON.parse(e),!0}catch(e){return sessionStorage.removeItem(APP_CONFIG.SESSION_KEY),!1}return!1}setupEventListeners(){const e=document.getElementById("togglePassword"),t=document.getElementById("password");e&&t&&e.addEventListener("click",e=>{e.preventDefault();const s="password"===t.getAttribute("type")?"text":"password";t.setAttribute("type",s),e.classList.toggle("fa-eye"),e.classList.toggle("fa-eye-slash")});const s=document.getElementById("loginForm");s&&s.addEventListener("submit",this.handleLogin.bind(this)),this.setupAdminButtons()}async handleLogin(e){e.preventDefault();const t=document.getElementById("username").value,s=document.getElementById("password").value;try{await this.authenticateUser(t,s),document.getElementById("loginContainer").style.display="none",document.getElementById("adminPanel").style.display="flex",this.loadUserList()}catch(e){this.showError(e.message)}}setupAdminButtons(){const e=document.getElementById("proceedBtn");e&&e.addEventListener("click",()=>{window.location.href="pagina2.html"});const t=document.getElementById("createUserBtn");t&&t.addEventListener("click",this.handleCreateUser.bind(this));const s=document.getElementById("logoutAdminBtn");s&&s.addEventListener("click",this.handleLogout.bind(this)),this.setupPagination()}async handleCreateUser(){try{const e=prompt("Ingrese el nombre de usuario (m√≠nimo 3 caracteres):");if(!e)return;const t=prompt("Ingrese la contrase√±a (m√≠nimo 6 caracteres):");if(!t)return;await this.createUser(e,t),this.loadUserList(),alert(`‚úÖ Usuario "${e}" creado exitosamente\n\nPermisos: Solo Lectura\nEstado: Activo`)}catch(e){alert(`‚ùå Error: ${e.message}`)}}handleLogout(){this.logout(),document.getElementById("adminPanel").style.display="none",document.getElementById("loginContainer").style.display="flex",document.getElementById("username").value="",document.getElementById("password").value="",this.clearError()}loadUserList(){const e=document.getElementById("userList");if(e){e.innerHTML="";const t=this.getUsersList();t.forEach(t=>{const s=document.createElement("tr");s.innerHTML=`
                <td>
                    <span class="user-status status-${t.status}"></span>
                    ${t.username}
                </td>
                <td>${t.permissions}</td>
                <td class="last-login">${t.lastLogin?new Date(t.lastLogin).toLocaleString():"Nunca"}</td>
                <td class="action-cell">
                    ${"josehpcastillo"!==t.username?`<button class=\"delete-btn\" data-user=\"${t.username}\">
                            <i class=\"fas fa-trash-alt\"></i> Eliminar
                        </button>`:'<span class="admin-badge">Administrador</span>'}
                </td>
            `,e.appendChild(s)}),this.setupDeleteButtons()}}setupDeleteButtons(){document.querySelectorAll(".delete-btn").forEach(e=>{e.addEventListener("click",async t=>{const s=t.target.closest(".delete-btn").getAttribute("data-user");if(confirm(`¬øEst√° seguro de eliminar al usuario "${s}"?`))try{await this.deleteUser(s),this.loadUserList(),alert(`‚úÖ Usuario "${s}" eliminado correctamente`)}catch(e){alert(`‚ùå Error: ${e.message}`)}})})}}setupPagination(){const e=document.getElementById("prevPageBtn"),t=document.getElementById("nextPageBtn");e&&e.addEventListener("click",()=>{console.log("P√°gina anterior")}),t&&t.addEventListener("click",()=>{console.log("P√°gina siguiente")})}showError(e){const t=document.getElementById("errorMessage");t&&(t.textContent=e,document.getElementById("loginForm").classList.add("error-animation"),setTimeout(()=>{document.getElementById("loginForm").classList.remove("error-animation")},500))}clearError(){const e=document.getElementById("errorMessage");e&&(e.textContent="")}handleError(e){console.error("Error del sistema:",e),alert(`Error del sistema: ${e.message}`)}}let userManager;function detectMobileDevice(){/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)&&(document.body.classList.add("mobile-device"),document.querySelectorAll('input[type="text"], input[type="password"]').forEach(e=>{e.addEventListener("focus",function(){this.style.fontSize="16px"})}))}function optimizeMobileForms(){document.querySelectorAll("form").forEach(e=>{const t=e.querySelector('input[type="text"]');t&&(t.setAttribute("autocomplete","username"),t.setAttribute("autocapitalize","none"),t.setAttribute("autocorrect","off"));const s=e.querySelector('input[type="password"]');s&&s.setAttribute("autocomplete","current-password")})}function initializeMobileFeatures(){detectMobileDevice(),optimizeMobileForms()}document.addEventListener("DOMContentLoaded",function(){console.log("üöÄ Iniciando aplicaci√≥n..."),userManager=new UserManager}),window.addEventListener("load",function(){console.log("üì± Inicializando funcionalidades m√≥viles..."),userManager&&userManager.hasActiveSession()&&console.log("üîê Sesi√≥n activa detectada")}),initializeMobileFeatures();